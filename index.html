<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Men√∫ setmanal</title>
  <style>
    
  :root{
    --text:#111;
    --muted:#6b7280;
    --line: rgba(0,0,0,0.08);
    --card: rgba(255,255,255,0.70);
    --shadow: 0 12px 26px rgba(0,0,0,0.06);
    --radius: 16px;
  }

  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif;
    margin: 0;
    color: #111;
    background: transparent;
  }


  .panel{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.70);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 14px;
  }

  .panelTitle{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap: 10px;
    margin-bottom: 10px;
  }

  .inputWide{
    min-width: 320px;
  }

  @media (max-width: 520px){
    .inputWide{ min-width: 100%; }
  }


  .container{
    max-width: 1200px;
    margin: 0 auto;        /* <- fora el 40px inferior */
    padding: 18px;         /* <- mantenim aire */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow-x: visible;
  }


  h2,h3{
    margin: 0;
    letter-spacing: .2px;
  }

  hr{
    border: 0;
    height: 1px;
    background: var(--line);
    margin: 12px 0;
  }

  .row{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  /* Toast */
  .toastWrap{
    position: fixed;
    left: 18px;
    bottom: 18px;
    z-index: 10000;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .toast{
    min-width: 240px;
    max-width: min(520px, calc(100vw - 36px));
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(255,255,255,0.92);
    box-shadow: 0 16px 40px rgba(0,0,0,0.16);
    backdrop-filter: blur(6px);
    font-size: 14px;
  }
  .toast.success{ border-color: rgba(16,185,129,0.35); }
  .toast.error{ border-color: rgba(239,68,68,0.35); }

  .toastTitle{ font-weight: 800; margin-bottom: 2px; }
  .toastBody{ color: rgba(0,0,0,0.72); }


  .gcNavBtn{
    width: 40px;
    height: 40px;
    padding: 0;
    border-radius: 999px;
    background: rgba(255,255,255,0.8);
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    display:flex;
    align-items:center;
    justify-content:center;
    transition: background .12s ease, transform .12s ease;
  }

  .gcNavBtn:hover{ background: rgba(255,255,255,1); }
  .gcNavBtn:active{ transform: translateY(1px); }

  .weekPill{
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.70);
    color: rgba(0,0,0,0.70);
    font-size: 14px;
  }


  /* Dirty state per meal slot */
  .mealBody.dirty{
    outline: 2px solid rgba(245,158,11,0.35);
    background: rgba(255,255,255,0.80);
  }

  .mealBody.saveError{
    outline: 2px solid rgba(239,68,68,0.35);
  }

  /* Badge petit ‚ÄúPendent‚Äù */
  .dirtyBadge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(245,158,11,0.30);
    background: rgba(245,158,11,0.12);
    color: rgba(0,0,0,0.72);
  }

  .badgeRow{
    display:flex;
    justify-content:flex-end;
    margin-top: 6px;
  }



  .topbar { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
  .muted { color:#666; font-size:13px; }
  button, input, select, textarea{
    font-size: 15px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: #fff;
    outline: none;
  }

  button{
    cursor: pointer;
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
  }

  button:hover{ background: #fbfbfb; }
  button:active{ transform: translateY(1px); }

  button:disabled{
    opacity: .55;
    cursor: not-allowed;
    transform: none;
  }

  input, select, textarea{
    background: rgba(255,255,255,0.85);
  }

  input:focus, select:focus, textarea:focus{
    border-color: rgba(0,0,0,0.18);
    box-shadow: 0 0 0 4px rgba(74,124,255,0.10);
  }

  .board {
    margin-top: 8px;
    border: 0;
    border-radius: 0;

    /* CLAU: si no hi caben 7 dies, fem scroll horitzontal (no apilem) */
    overflow-x: hidden;
    overflow-y: visible;

    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px;
  }

  .weekCols{
    display: grid;
    grid-template-columns: repeat(7, minmax(130px, 1fr));
    gap: 10px;

    /* CLAU: forcem una amplada m√≠nima perqu√® el grid NO col¬∑lapsi ni apili */
    min-width: 0;
  }




  /* --- Mobile: setmana tipus carrusel (swipe) --- */
  @media (max-width: 980px){

    /* Menys padding general */
    .container{ padding: 12px; }

    /* Topbar m√©s compacta */
    .topbar h2{ font-size: 20px; }
    button, input, select, textarea{ padding: 9px 10px; font-size: 15px; }
    .actions{ width: 100%; justify-content: flex-end; }

    /* IMPORTANT: convertim la setmana en carrusel i RESETEGEM el grid de desktop */
    
    .board{
      overflow-x: auto;   /* ok */
      padding-bottom: 6px;
    }
    .dayCol{
      scroll-snap-align: start;
      border-radius: 16px;
    }
    .weekCols{
        min-width: 0;              /* CLAU: anul¬∑la el min-width de desktop */
        grid-template-columns: none;

        grid-auto-flow: column;
        grid-auto-columns: 88%;
        gap: 10px;

        overflow-x: auto;
        overflow-y: visible;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }
    .weekCols::-webkit-scrollbar{ height: 8px; }
    .weekCols::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.12); border-radius: 999px; }


    .topbar{
      align-items: center;
      gap: 10px;
    }

    .weekControlsTop{
      order: 2;
      flex: 1 1 auto;
      justify-content: center;
    }

    /* Elimina el text ‚ÄúSetmana‚Äù si el tens com a label */
    .weekControlsTop .weekLabel{
      display: none;
    }

    /* Botons m√©s petits */
    .gcNavBtn{
      width: 32px;
      height: 32px;
    }

    .weekPill{
      padding: 6px 10px;
      font-size: 12px;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

.topbar h2{
  font-size: 20px;     /* prova 19‚Äì22 segons gust */
  margin: 0;
}

  .actions{
    display:flex;
    gap: 10px;
    align-items:center;
  }

  .btnPrimary{
    background: #1a73e8;
    color: #fff;
    border-color: rgba(26,115,232,0.35);
  }
  .btnPrimary:hover{ background:#1667cf; }


  .btnGhost{
    background: rgba(255,255,255,0.7);
  }

  .weekControls{
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .iconBtn{
    width: 44px;
    height: 44px;
    padding: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius: 14px;
  }

  .dayHead{
    display:flex;
    flex-direction: row;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 4px;
  }

  .dayName{
    font-weight: 900;
    text-transform: uppercase;
    font-size: 13px;
    opacity: .85;
    margin: 0;
  }

  .dayDate{
    font-size: 12px;
    opacity: .65;
    margin: 0;
    white-space: nowrap;
  }




  .mealBody:hover{
    background: rgba(255,255,255,0.75);
  }



  .mealIcon{
    width: 16px;
    height: 16px;
    border-radius: 6px;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity: .65;
    margin-top: 0;
    font-size: 12px;
    user-select:none;
  }






  /* Scroll discret */
  .mealCards::-webkit-scrollbar{ width: 8px; }
  .mealCards::-webkit-scrollbar-thumb{
    background: rgba(0,0,0,0.12);
    border-radius: 999px;
  }


  /* Les teves cards funcionen igual; nom√©s les ajustem una mica */
  .card{
    padding: 6px 10px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: none;
    font-size: 12.5px;
    background: rgba(255,255,255,0.65);
    display:flex;
    gap:8px;
    align-items:center;
  }
  .card.primer {
    background:#fff7c7;
    border-left: 4px solid #f59e0b;
  }
  .card.segon  {
    background:#d8e9ff;
    border-left: 4px solid #3b82f6;
  }
  .card.unic   {
    background:#c9f2d2;
    border-left: 4px solid #22c55e;
  }

  .cIcon{ line-height:1; }
  .cName{ min-width:0; }
  /* Popup */

  .overlay{
    position:fixed; inset:0;
    background: rgba(17,24,39,0.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
  }

  .overlay.open{ display:flex; }

  .modal{
    width: min(820px, 100%);
    background: rgba(255,255,255,0.92);
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.10);
    box-shadow: 0 30px 80px rgba(0,0,0,0.25);
    padding: 14px;
    backdrop-filter: blur(6px);
    max-height: 92vh;
    display: flex;
    flex-direction: column;
  }

  .modalHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    padding: 6px 6px 10px 6px;
    flex: 0 0 auto;
  }

  .modalHeaderActions{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .modalTitle{ font-weight: 900; font-size: 16px; }



  .noteField{
    grid-column: 1 / -1;
    background: rgba(255,255,255,0.65);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    padding: 12px;
  }

  .noteField label{
    display:block;
    font-size: 12px;
    color: rgba(0,0,0,0.55);
    margin-bottom: 6px;
  }


  #noteBox{
    width: 100%;
    height: 40px;
    min-height: 40px;
    max-height: 40px;
    resize: none;
    overflow: hidden;
    padding: 10px 40px 10px 12px;  /* espai a la dreta per la creu */
    font-size: 14px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(255,255,255,0.85);
    line-height: 20px;
    box-sizing: border-box;
  }

  .noteClearBtn:active{ transform: translateY(-50%) scale(0.98); }
  .noteClearBtn.hidden{ display: none; }

  .noteInputWrap{
    position: relative;
    width: 100%;
  }

  .noteClearBtn{
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    border-radius: 10px;
    padding: 0;
    line-height: 28px;
    font-size: 16px;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.85);
  }

  .noteClearBtn:hover{
    background: rgba(255,255,255,1);
  }


  .noteActions{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  @media (max-width: 720px){
    .modalBody{ grid-template-columns: 1fr; }
  }


  .field { display:flex; flex-direction:column; gap:8px; }
  .field label { font-size:13px; color:#666; }
  .field select { width:100%; }
  .hint { font-size:12px; color:#666; margin-top:10px; }
  .bCell { cursor: pointer; }
  .cards { gap: 6px; }
  .card {
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
  }

  .loading {
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading.hidden {
    display: none;
  }

  .loadingBox {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px 26px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
  }

  .spinner {
    width: 42px;
    height: 42px;
    border: 4px solid #e0e0e0;
    border-top-color: #4a7cff;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loadingText {
    font-size: 14px;
    color: #333;
  }

  .noteLine{
    font-size: 13px;
    padding: 8px 10px;
    border-radius: 10px;
    background: #f3f3f3;
    border: 1px solid rgba(0,0,0,0.06);
    color: #333;
  }

  /* --- Layout estable dins de cada dia (Flex) --- */

  .dayCol{
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: auto;
    overflow: visible;
    padding-bottom: 10px;
  }

  .dayMeals{
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Una fila per √†pat: icona + bloc clickable */
  .mealRow{
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  .mealLabel{
    width: 100%;
    font-weight: 600;
    font-size: 13px;
    color: rgba(0,0,0,0.65);
    padding: 0 8px;
    text-transform: uppercase;
  }
  /* icona a l‚Äôesquerra */
  .mealIcon{
    width: 16px;
    height: 16px;
    border-radius: 7px;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    flex: 0 0 16px;
    margin-top: 10px; /* alinea amb el bloc */
  }

  /* bloc de l‚Äô√†pat (buit o amb cards) */
  .mealBody{
    flex: 1 1 auto;
    min-height: 52px;
    width: 100%;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
    background: rgba(255,255,255,0.55);
    padding: 8px;
    transition: background .12s ease, transform .12s ease;
  }

  .mealBody:hover{
    background: rgba(255,255,255,0.75);
  }

  .mealCards{
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* A m√≤bil, una mica m√©s compacte */
  @media (max-width: 520px){
    .mealIcon{ margin-top: 8px; }
    .mealBody{ min-height: 48px; }
  }



  /* Fix grid shrink: evita amplades diferents per contingut intern */
  .dayCol,
  .mealRow,
  .mealBody,
  .mealCards{
    min-width: 0;
  }

  .mealBody.meal-breakfast .mealCards,
  .mealBody.meal-snack .mealCards{
    overflow: hidden; /* normalment no cal scroll aqu√≠ */
  }

  .mealBody.meal-lunch .mealCards,
  .mealBody.meal-dinner .mealCards{
    overflow: auto;
  }


  html, body{
    height: auto;
    min-height: 100%;
    overflow-x: visible;
    overflow-y: auto;   /* permet scroll de p√†gina */
  }

  html{
    background:
      radial-gradient(900px 420px at 15% 5%, rgba(216,239,241,0.55), transparent 60%),
      radial-gradient(900px 420px at 85% 12%, rgba(247,223,230,0.55), transparent 60%),
      radial-gradient(900px 520px at 70% 120%, rgba(223,240,214,0.55), transparent 60%),
      radial-gradient(900px 520px at 30% 140%, rgba(216,239,241,0.35), transparent 70%),
      #ffffff;
  }

  body{
    background: transparent; /* perqu√® el fons el pinta html */
  }
  @media (min-width: 1200px) and (max-width: 2000px){
    .weekCols{
      gap: 8px;
    }
  }

  /* --- Recipe picker (modal) --- */
  .pickerTop{
    grid-column: 1 / -1;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap: wrap;
    padding: 6px 2px;
  }
  .pickerSearch{
    flex: 1 1 220px;
    display:flex;
    gap:8px;
    align-items:center;
    background: rgba(255,255,255,0.70);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 8px 10px;
  }
  .pickerSearch input{
    border: 0;
    outline: none;
    background: transparent;
    width: 100%;
    font-size: 14px;
  }
  .pickerCols{
    grid-column: 1 / -1;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    align-items:start;
  }
  @media (max-width: 720px){
    .pickerCols{ grid-template-columns: 1fr; }
    .modalHeaderActions{
      gap:8px;
    }
    #recipeTopStatus{
      display:none; /* si molesta en m√≤bil/tablet */
    }
  }
  .pickerCol{
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    padding: 10px;
    box-shadow: 0 10px 22px rgba(0,0,0,0.04);
    min-height: 0;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .pickerColHeader{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    position: sticky;
    top: 0;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(4px);
    z-index: 1;
  }
  .pickerColTitle{ font-weight: 800; }
  .pickerCurrent{
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }
  .pickerList{
    overflow:auto;
    overflow-y: auto;
    padding-right: 2px;
    display:flex;
    flex-direction:column;
    gap:8px;
    max-height: 100%;
  }
  .rCard{
    width: 100%;
    text-align:left;
    background: rgba(255,255,255,0.75);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 10px 10px;
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:center;
    transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
  }
  .rCard:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.06); }
  .rCard.selected{ border-color: rgba(59,130,246,0.55); box-shadow: 0 12px 22px rgba(59,130,246,0.12); }
  .rIcon{
    width: 28px; height: 28px;
    display:grid; place-items:center;
    border-radius: 10px;
    background: rgba(0,0,0,0.04);
    font-size: 16px;
    flex: 0 0 28px;
  }
  .rName{ font-weight: 650; }
  .rMeta{ font-size: 12px; color: var(--muted); }
  .rHidden{ display:none !important; }

  /* --- Recipe editor modal --- */
  .recipeEditor{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap: 12px;
    align-items: stretch;
    flex: 1 1 auto;
    overflow: hidden;   /* important */
  }
  @media (max-width: 900px){
    .recipeEditor{ grid-template-columns: 1fr; }
  }

  .recipeListPane{
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    background: rgba(255,255,255,0.60);
    padding: 10px;
    display:flex;
    flex-direction: column;
    gap: 10px;
    min-height: 0;
    overflow: hidden;
  }

  .recipeSearch{
    display:flex;
    gap:8px;
    align-items:center;
    background: rgba(255,255,255,0.70);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 8px 10px;
  }
  .recipeSearch input{
    border:0;
    outline:none;
    background:transparent;
    width:100%;
  }

  .recipeList{
    overflow:auto;
    display:flex;
    flex-direction: column;
    gap: 8px;
    padding-right: 2px;
    flex: 1 1 auto;
    overflow-y: auto;
  }

  .recipeRow{
    display:flex;
    gap:10px;
    align-items:center;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.75);
    border-radius: 14px;
    padding: 10px;
    cursor:pointer;
  }
  .recipeRow:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.06); }
  .recipeRow.selected{ border-color: rgba(59,130,246,0.55); box-shadow: 0 12px 22px rgba(59,130,246,0.12); }

  .recipeBadge{
    width: 30px; height: 30px;
    border-radius: 10px;
    background: rgba(0,0,0,0.04);
    display:grid;
    place-items:center;
    font-size: 16px;
    flex: 0 0 30px;
  }

  .recipeDetailPane{
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    background: rgba(255,255,255,0.60);
    padding: 12px;
    min-height: 0;
    overflow-y: auto;
  }

  /* El quadre blanc del modal (receptes) una mica m√©s ample */
  #recipeModal{
    overflow: visible;
    width: min(1120px, calc(100vw - 64px));
  }

  /* Si tens un layout en 2 columnes dins del modal, dona m√©s pes a la dreta */
  .recipeLayout{
    grid-template-columns: 320px 1fr; /* esquerra (llista) / dreta (formulari) */
  }
  .recipeForm{
    display:flex;
    flex-direction: column;
    gap: 8px;
    overflow: visible;
  }

  .recipeFormTop{
    display:grid;
    grid-template-columns: 120px 1fr 170px;
    gap: 10px;
    align-items:center;
  }
  @media (max-width: 900px){
    .recipeFormTop{ grid-template-columns: 120px 1fr; }
  }

  .recipeForm textarea{
    width: 100%;
    resize: vertical;
  }

  .mealIcon, .rIcon, .recipeBadge, #newIcon, #rIcon{
    font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }

  /* 1) Evita desbordaments ‚Äúper padding + width‚Äù */
  *, *::before, *::after {
    box-sizing: border-box;
  }

  /* 2) A la columna dreta, mai scrollbar horitzontal */
  .recipeDetailPane {
    overflow-x: hidden;   /* <- aix√≤ fa desapar√®ixer la barra */
  }

  /* 3) En grids/flex, permet que els fills s‚Äôencongeixin (si no, creen overflow) */
  .recipeEditor,
  .recipeListPane,
  .recipeDetailPane,
  .recipeForm,
  .recipeFormTop,
  .recipeFormTop > * {
    min-width: 0;
  }

  /* 4) Inputs/textarea: que no puguin passar de l‚Äôample disponible */
  .recipeDetailPane input,
  .recipeDetailPane select,
  .recipeDetailPane textarea {
    max-width: 100%;
    width: 100%;
  }

  /* 5) El select de la icona no ha de ser width:100% (sin√≥ trenca el grid de 3 columnes) */
  .recipeFormTop #rIcon {
    width: auto;
  }
  .card{ cursor: pointer; }

  /* SVG kawaii: multicolor (no dep√®n de currentColor) */
  .svgIcon{
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: -0.12em;
  }

  /* Twemoji SVG */
  .twSvg{
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: -0.12em;
  }
  .mealIcon .twSvg{ width: 16px; height: 16px; }
  .rIcon .twSvg,
  .recipeBadge .twSvg{ width: 18px; height: 18px; }
  .cIcon .twSvg{ width: 14px; height: 14px; }


  /* Mides per context */
  .mealIcon .svgIcon{ width: 16px; height: 16px; }
  .rIcon .svgIcon,
  .recipeBadge .svgIcon{ width: 18px; height: 18px; }
  .cIcon .svgIcon{ width: 14px; height: 14px; }

  /* Opcional: fa que les icones ‚Äúsaltin‚Äù una mica (sense recarregar) */
  .i{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,0.10));
  }


  /* Color per √†pat (icones de la columna) + badge suau al fons */
  .mealIcon{
    opacity: 1;
    width: 16px;
    height: 16px;
    border-radius: 7px;
    margin-top: 2px;
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(0,0,0,0.06);
  }
  .mealIcon.meal-breakfast{ background: rgba(255,255,255,0.55); }
  .mealIcon.meal-lunch    { background: rgba(245,158,11,0.12); }
  .mealIcon.meal-snack    { background: rgba(34,197,94,0.12); }
  .mealIcon.meal-dinner   { background: rgba(59,130,246,0.12); }




  #rvTitle{
    display:flex;
    align-items:center;
    gap: 8px;
  }

  .card.primer .svgIcon{ opacity: 0.95; }
  .card.segon  .svgIcon{ opacity: 0.92; }
  .card.unic   .svgIcon{ opacity: 0.92; }

  /* Twemoji inline SVG */
  .twSvg{
    width: 18px;
    height: 18px;
    display: inline-block;
    vertical-align: -3px;
  }

  /* a les targetes (board) */
  .card .cIcon .twSvg{
    width: 16px;
    height: 16px;
    vertical-align: -3px;
  }

  /* a les icones del lateral dels √†pats */
  .mealIcon .twSvg{
    width: 18px;
    height: 18px;
    vertical-align: -3px;
  }

  /* a les targetes del picker (modal) */
  .rIcon .twSvg,
  .recipeBadge .twSvg{
    width: 18px;
    height: 18px;
    vertical-align: -3px;
  }

  .iconPreview{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:28px;
    height:28px;
    margin-left:8px;
    vertical-align:middle;
  }
  .iconPreview .twSvg{
    width:20px;
    height:20px;
  }

  /* Cap√ßalera del formulari d'edici√≥ */
  .recipeHeaderRow{
    display: grid;
    grid-template-columns: 110px 28px minmax(220px, 1fr) 140px;
    align-items: center;
    gap: 10px;
  }

  #rIcon, #rCategory, #rName{
    width: 100%;
    min-width: 0;
  }

  #rName{
    display: block;
    min-height: 34px;
  }


  /* Evita que el preview mengi espai i provoqui salt */
  .recipeHeaderRow .iconPreview{
    flex: 0 0 auto;
    margin-left: 6px;
  }

  /* Controls m√©s compactes perqu√® hi c√†piguen */
  .recipeHeaderRow select,
  .recipeHeaderRow input{
    min-width: 0;
    padding: 8px 10px;
  }

  .recipeHeaderGrid{
    display: grid;
    grid-template-columns: 1fr 200px 150px;
    grid-template-areas: "name icon cat";
    gap: 12px;
    align-items: start;
  }

  @media (max-width: 900px) {
    .recipeHeaderGrid {
      grid-template-columns: 1fr;
      grid-template-areas: "name" "icon" "cat";
    }
  }

  .recipeHeaderGrid .rhName { 
    grid-area: name; 
  }

  .recipeHeaderGrid .rhIcon { 
    grid-area: icon;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .recipeHeaderGrid .rhCat { 
    grid-area: cat; 
  }

  /* Fix icon picker to fit in grid cell */
  .rhIcon .iconPickerGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    padding: 6px;
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    margin: 0;
  }

  .rhIcon .iconPickerBtn {
    width: 100%;
    aspect-ratio: 1;
    padding: 0;
    border: 2px solid rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 120ms ease;
  }

  .rhIcon .iconPickerBtn:hover {
    border-color: rgba(59,130,246,0.35);
    background: rgba(59,130,246,0.05);
    transform: scale(1.05);
  }

  .rhIcon .iconPickerBtn.selected {
    border-color: rgba(59,130,246,0.8);
    background: rgba(59,130,246,0.15);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }

  /* Visual Icon Picker - for adding recipes */
  .iconPickerGrid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    padding: 8px;
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    margin-bottom: 8px;
    max-width: 350px;
  }

  .iconPickerBtn {
    width: 100%;
    aspect-ratio: 1;
    padding: 0;
    border: 2px solid rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 120ms ease;
  }

  .iconPickerBtn:hover {
    border-color: rgba(59,130,246,0.35);
    background: rgba(59,130,246,0.05);
    transform: scale(1.05);
  }

  .iconPickerBtn.selected {
    border-color: rgba(59,130,246,0.8);
    background: rgba(59,130,246,0.15);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }

  </style>

</head>
<body>
  <div class="container">

    <div class="topbar">
      <div class="titleRow">
        <h2>Men√∫ setmanal</h2>
        <!-- <div class="muted subtitleInline">Planificaci√≥ familiar</div> -->
      </div>
      <!-- AUTH BAR (m√≠nim) --      /* Visual Icon Picker */ -->
  
      <div class="authBar">
        <span id="authStatus" class="muted">No autenticat</span>
      
        <input id="familyCodeInput" placeholder="Codi fam√≠lia (ex: CASA-1234)" />
        <button id="loginBtn">Login</button>
      
        <button id="logoutBtn" style="display:none;">Logout</button>
      </div>

      <div class="weekControls">
        <button id="prevWeekBtn" class="gcNavBtn" title="Setmana anterior">‚Äπ</button>
        <div id="weekLabel" class="weekPill"></div>
        <button id="nextWeekBtn" class="gcNavBtn" title="Setmana seg√ºent">‚Ä∫</button>
      </div>


    </div>


    <div id="grid"></div>

    <hr/>

    <h3>Cat√†leg de plats</h3>

    <div class="panel">
      <div class="panelTitle">
        <div class="muted">Afegeix plats i classifica‚Äôls per tipus</div>
      </div>

      <div class="row">
        <input id="newName" class="inputWide" placeholder="Nom del plat (ex: crema de carbassa)">
        <select id="newCat">
          <option value="Primer">Primer</option>
          <option value="Segon">Segon</option>
          <option value="Plat √∫nic">Plat √∫nic</option>
          <option value="Esmorzar">Esmorzar</option>
          <option value="Berenar">Berenar</option>
        </select>
        <div id="newIconPicker" class="iconPickerGrid" style="max-width: 300px;"></div>
        <span id="newIconPreview" class="iconPreview"></span>
        <input type="hidden" id="newIconValue">
        <button id="addBtn" class="btnPrimary">Afegir/Actualitzar</button>
        <button id="manageRecipesBtn" class="btnGhost">Gestionar receptes</button>
      </div>
    </div>
  <div id="overlay" class="overlay">
    <div id="modal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modalHeader">
        <div>
          <div id="modalTitle" class="modalTitle">Editar</div>
          <div id="modalSub" class="muted"></div>
        </div>
        <button id="closeBtn">Tancar</button>
      </div>
      <div id="modalBody" class="modalBody"></div>
    </div>
  </div>
  <div id="loadingOverlay" class="loading hidden">
    <div class="loadingBox">
      <div class="spinner"></div>
      <div class="loadingText">Cargando‚Ä¶</div>
    </div>
  </div>
  <script>

    let RECIPES = [];
    let PLAN = [];
    let WEEK_START_ISO = null; // dilluns (YYYY-MM-DD)
    let NOTES = []; // {date, meal, note}
    let RV_RECIPE_ID = null;

    // --- Twemoji SVG (CDN) ---
    const TWEMOJI_VERSION = "14.0.2";
    const TWEMOJI_BASE = "https://cdn.jsdelivr.net/gh/twitter/twemoji@" + TWEMOJI_VERSION + "/assets/svg/";


    const TWEMOJI_MAP = {
      soup:     "1f372",
      salad:    "1f957",
      pasta:    "1f35d",
      rice:     "1f35a",
      pizza:    "1f355",
      egg:      "1f373", // üç≥ (si el vols mantenir)
      egg2:     "1f95a", // ü•ö (OU SENCER)  <-- AFEGIT
      fish:     "1f41f",
      chicken:  "1f357",
      sandwich: "1f96a",
      stew:     "1f372",
      burger:   "1f354",
      taco:     "1f32e",
      sushi:    "1f363",
      dessert:  "1f370",
      fruit:    "1f34e",
      plate:    "1f37d",
      coffee:   "2615",   // opcional: ‚òï per esmorzar
      eggplant: "1f346", // üçÜ alberg√≠nia
      broccoli: "1f966", // ü•¶ verdura
      potato:   "1f954",  // ü•î patata
      cream:    "1f375"  // üçµ  ‚Üê AFEGIT (cremes)
    };

    const ICON_LABELS = {
      auto: "Auto",
      soup: "Sopa",
      cream: "Crema",
      eggplant: "Alberg√≠nia",
      broccoli: "Verdura",
      potato: "Patata",
      salad: "Amanida",
      pasta: "Pasta",
      rice: "Arr√≤s",
      pizza: "Pizza",
      egg: "Truita",
      egg2:"Ou",
      fish: "Peix",
      chicken: "Pollastre",
      sandwich: "Entrep√†",
      stew: "Estofat",
      burger: "Hamburguesa",
      taco: "Taco",
      sushi: "Sushi",
      dessert: "Postre",
      fruit: "Fruita",
      plate: "Plat",
      coffee: "Caf√®"
    };

    // L‚Äôordre com vols que surtin al desplegable
    const ICON_KEYS = [
      "auto",
      "soup","cream","salad","eggplant","broccoli","potato","pasta","rice","pizza","egg","egg2","fish","chicken","sandwich","stew",
      "burger","taco","sushi","dessert","fruit","plate",
      "coffee"
    ];


    const TW_SVG_CACHE = {}; // code -> <svg...>...</svg>

    function twCodeForKey(key){
      const k = String(key || "").trim();
      return TWEMOJI_MAP[k] || TWEMOJI_MAP.plate;
    }

    // Sanititza amb DOMParser    
    function sanitizeTwSvg(svgText){
      const parser = new DOMParser();
      const doc = parser.parseFromString(String(svgText || ""), "image/svg+xml");

      const svg = doc.documentElement;
      if (!svg || svg.nodeName.toLowerCase() !== "svg") return "";

      // elimina width/height per controlar via CSS
      svg.removeAttribute("width");
      svg.removeAttribute("height");

      // afegeix class twSvg
      const cls = (svg.getAttribute("class") || "").trim();
      svg.setAttribute("class", (cls ? cls + " " : "") + "twSvg");

      return new XMLSerializer().serializeToString(svg);
    }

    async function preloadTwemojiSvgs(){
      const uniqueCodes = Array.from(new Set(Object.values(TWEMOJI_MAP)));

      for (const code of uniqueCodes){
        if (TW_SVG_CACHE[code]) continue;

        const url = TWEMOJI_BASE + code + ".svg";
        try{
          const res = await fetch(url, { cache: "force-cache" });
          if (!res.ok) {
            console.warn("Twemoji fetch failed:", code, res.status);
            continue;
          }
          const raw = await res.text();
          const clean = sanitizeTwSvg(raw);
          if (clean) TW_SVG_CACHE[code] = clean;
        } catch(err){
          console.warn("Twemoji fetch error:", code, err);
        }
      }
    }

    const EMOJI_FALLBACK = {
      soup:"üç≤", salad:"ü•ó", pasta:"üçù", rice:"üçö", pizza:"üçï",
      egg:"üç≥", fish:"üêü", chicken:"üçó", sandwich:"ü•™",
      stew:"üç≤", burger:"üçî", taco:"üåÆ", sushi:"üç£",
      dessert:"üç∞", fruit:"üçé", plate:"üçΩÔ∏è",
      eggplant:"üçÜ", broccoli:"ü•¶", potato:"ü•î",
      cream:"üçµ" // si l‚Äôhas creat com a key
    };

    function twemojiSvgIcon(key){
      const k = String(key || "").trim() || "plate";
      const code = twCodeForKey(k);
      const svg = TW_SVG_CACHE[code];
      return svg || (EMOJI_FALLBACK[k] || EMOJI_FALLBACK.plate);
    }


    function findNote(date, mealKey){
      return NOTES.find(n => n.date === date && n.meal === mealKey)?.note || "";
    }

    async function gasp(fn, ...args) {
      // Map old Google Apps Script function names to new endpoints
      const apiMap = {
        api_getRecipes: { method: "GET", path: "/api/recipes" },
        api_getWeekData: { method: "GET", path: "/api/menu" },
        api_upsertRecipe: { method: "POST", path: "/api/recipes" },
        api_setNote: { method: "POST", path: "/api/menu" },
        api_applySlotChanges: { method: "POST", path: "/api/menu" },
        api_updateRecipeDetails: { method: "POST", path: "/api/recipes" },
      };

      const config = apiMap[fn];
      if (!config) throw new Error(`Unknown API: ${fn}`);

      let url = config.path;
      let options = {};

      if (config.method === "GET") {
        if (args[0]) {
          const params = new URLSearchParams(args[0]);
          url += "?" + params.toString();
        }
        options.method = "GET";
      } else {
        const data = args[0] || {};
        if (fn === "api_setNote") {
          data.action = "setNote";
        } else if (fn === "api_applySlotChanges") {
          data.action = "applyChanges";
        }
        options.method = "POST";
        options.headers = { "Content-Type": "application/json" };
        options.body = JSON.stringify(data);
      }

      const response = await apiFetch(url, options);

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || `API error: ${response.status}`);
      }

      return await response.json();
    }

    let DIRTY_SLOTS = {};      // { slot_id: {date, meal, recipe_id} | {slot_id, __delete:true} }
    let IS_IN_MODAL = false;

    function showLoading(opts = {}) {
      if (opts && opts.silent) return;   // <- per no molestar dins el modal
      const el = document.getElementById("loadingOverlay");
      if (el) el.classList.remove("hidden");
    }
    function hideLoading() {
      const el = document.getElementById("loadingOverlay");
      if (el) el.classList.add("hidden");
    }

    function toast(kind, title, body, ms){
      if (ms === undefined) ms = 2600;
      body = body || "";

      const wrap = document.getElementById("toastWrap");
      if (!wrap) return;

      const el = document.createElement("div");
      el.className = "toast" + (kind ? (" " + kind) : "");

      var html = '<div class="toastTitle">' + (title || "") + '</div>';
      if (body) html += '<div class="toastBody">' + body + '</div>';
      el.innerHTML = html;

      wrap.appendChild(el);

      setTimeout(function(){
        el.style.opacity = "0";
        el.style.transform = "translateY(6px)";
        el.style.transition = "all 180ms ease";
        setTimeout(function(){ el.remove(); }, 220);
      }, ms);
    }



    function mealBodyId(date, mealKey){
      return `mealBody_${date}_${mealKey}`;
    }



    function markMealDirty(date, mealKey, isDirty){
      const el = document.getElementById(mealBodyId(date, mealKey));
      if (!el) return;

      if (isDirty) el.classList.add("dirty");
      else el.classList.remove("dirty");

      // Badge
      const badge = el.querySelector(".dirtyBadge");
      if (isDirty){
        if (!badge){
          const row = document.createElement("div");
          row.className = "badgeRow";
          row.innerHTML = `<span class="dirtyBadge">Pendent de guardar</span>`;
          el.appendChild(row);
        }
      } else {
        el.querySelector(".badgeRow")?.remove();
        el.classList.remove("saveError");
      }
    }

    function markMealError(date, mealKey){
      const el = document.getElementById(mealBodyId(date, mealKey));
      if (!el) return;
      el.classList.add("saveError");
    }

    const MEALS = [
      { key: "breakfast", label: "Esmorzar", courses: ["plat"] },
      { key: "lunch",     label: "Dinar",    courses: ["primer", "segon", "unic"] },
      { key: "snack",     label: "Berenar",  courses: ["plat"] },
      { key: "dinner",    label: "Sopar",    courses: ["primer", "segon", "unic"] }
    ];

    function iso(d){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function addDays(dateStr, n){
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate() + n);
      return iso(d);
    }



    function parseISO(dateStr){
      return new Date(dateStr + "T00:00:00");
    }

    function startOfWeekMonday(d){
      // d = Date
      const day = d.getDay(); // 0 dg .. 6 ds
      const diff = (day === 0) ? 6 : (day - 1); // dilluns com a inici
      const out = new Date(d);
      out.setDate(d.getDate() - diff);
      return out;
    }

    function addDaysDate(d, n){
      const out = new Date(d);
      out.setDate(out.getDate() + n);
      return out;
    }

    function formatWeekLabel(mondayDate){
      const sunday = addDaysDate(mondayDate, 6);
      const fmt = (x) => iso(x);
      return `${fmt(mondayDate)} ‚Üí ${fmt(sunday)}`;
    }


    function rankRecipes(recipes){
      return [...recipes].sort((a,b)=>{
        const c = (Number(b.count||0) - Number(a.count||0));
        if (c !== 0) return c;
        return String(b.last_used||"").localeCompare(String(a.last_used||""));
      });
    }

    function norm_(s){
      return String(s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu,"");
    }

    function svgIcon(key){
       throw new Error("svgIcon() no s'ha d'utilitzar. Usa twemojiSvgIcon().");
    }




    // Reutilitzem r.icon com a "key"
    function recipeIconKey(r){
      const manual = String(r?.icon || "").trim(); // ara: "soup", "salad", ...
      return manual || autoIconKeyForRecipe(r);
    }




    function autoIconKeyForRecipe(r){
      const name = norm_(r?.name || "");
      const cat  = norm_(r?.category || "");

      if (cat.includes("esmorzar")) return "coffee";
      if (cat.includes("berenar"))  return "fruit";

      const map = [
        [/crema|cremes/, "cream"],        // üçµ PRIORITAT
        [/pasta|macarr|espaguet|lasany|fideu/, "pasta"],
        [/verdur/,"broccoli"],
        [/patat/,"potato"],
        [/alberg|carbas/,"eggplant"],
        [/arros|paella|risotto/, "rice"],
        [/pizza/, "pizza"],
        [/truita|tortilla|ou|huevo/, "egg"],
        [/sopa|crema|caldo|brou/, "soup"],
        [/amanid|ensalada/, "salad"],
        [/peix|pescad|salmo|tonyina|bacalla|sard/, "fish"],
        [/pollastre|pollo|gall/, "chicken"],
        [/hamburg|burger/, "burger"],
        [/taco|fajita|burrito|mex/, "taco"],
        [/sushi|maki|nigiri/, "sushi"],
        [/pa amb|sandwich|bikini|entrep[a√†]/, "sandwich"],
        [/estofat|guisat|rag[u√π]/, "stew"],
        [/postre|pastis|tarta|iogurt|gelat/, "dessert"],
        [/fruita|poma|platan|raim/, "fruit"],
      ];
      for (const [re, key] of map){
        if (re.test(name)) return key;
      }

      if (cat.includes("primer")) return "salad";
      return "plate";
    }




    function findRecipe(id){ return RECIPES.find(r => String(r.id) === String(id)); }
    function findSlot(slot_id){ return PLAN.find(p => String(p.slot_id) === String(slot_id)); }

    async function loadRecipesOnce(){
      if (RECIPES.length) return;
      const r1 = await gasp("api_getRecipes");
      RECIPES = (r1?.recipes || []).map(r => ({...r, count:Number(r.count||0)}));
    }

    async function loadWeekData(){
      const weekStart = WEEK_START_ISO;
      const weekEnd = addDays(weekStart, 6);
      const r = await gasp("api_getWeekData", { weekStart, weekEnd });
      PLAN = r?.plan || [];
      NOTES = r?.notes || [];
    }




    function dayLabel(dateStr){
      const d = new Date(dateStr + "T00:00:00");
      // Normalizamos: lunes = 0, domingo = 6
      const idx = (d.getDay() + 6) % 7;
      const names = ["dl.","dt.","dc.","dj.","dv.","ds.","dg."];
      return names[idx];
    }


    function buildDates(weekMondayISO){
      const start = parseISO(weekMondayISO);
      const dates = [];
      for (let i=0;i<7;i++) dates.push(iso(addDaysDate(start, i)));
      return dates;
    }


    const VIEW_MODE = "edit";

    function slotId(date, mealKey, course){
      return `${date}_${mealKey}_${course}`;
    }

    function slotHasValue(slot_id){
      const s = findSlot(slot_id);
      return !!(s && String(s.recipe_id || "").trim());
    }


    function courseClass(course){
      if (course === "primer") return "primer";
      if (course === "segon") return "segon";
      if (course === "unic") return "unic";
      return "plat";
    }

    function coursesForMeal(mealKey){
      if (mealKey === "lunch" || mealKey === "dinner") return ["primer","segon","unic"];
      if (mealKey === "breakfast") return ["plat"];
      if (mealKey === "snack") return ["plat"];
      return ["plat"];
    }

    function allowedForCourse(recipe, course){
      const cat = String(recipe.category || "");
      if (course === "primer") return cat === "Primer";
      if (course === "segon")  return cat === "Segon";
      if (course === "unic")   return cat === "Plat √∫nic";
      return true;
    }

    function renderBoard(weekMondayISO){
      const dates = buildDates(weekMondayISO);

      const DAY_COLORS = [
        "#f2e8e6", // dl
        "#f7dfe6", // dt
        "#d8eff1", // dc
        "#dff0d6", // dj
        "#f6efc8", // dv
        "#e9e5f7", // ds (extra)
        "#e7f5ff"  // dg (extra)
      ];

      const dayTitle = (dateStr) => {
        const d = new Date(dateStr + "T00:00:00");
        const names = ["Diumenge","Dilluns","Dimarts","Dimecres","Dijous","Divendres","Dissabte"];
        return names[d.getDay()];
      };

      const mealIconKey = (mealKey) => {
        if (mealKey === "breakfast") return "coffee";
        if (mealKey === "lunch") return "soup";
        if (mealKey === "snack") return "fruit"; 
        if (mealKey === "dinner") return "plate";
        return "plate";
      };


      const colHtml = dates.map((date, i) => {
        const dayBg = DAY_COLORS[i % DAY_COLORS.length];

        const mealsHtml = MEALS.map(m => {
          const courses = coursesForMeal(m.key);

          // Nota (si n‚Äôhi ha)
          const note = findNote(date, m.key);
          const noteHtml = note
            ? `<div class="noteLine" title="${note.replaceAll('"','&quot;')}">üìù ${note}</div>`
            : "";

          // Cards del dia/√†pat
          const cards = courses.map(course => {
            const sid = slotId(date, m.key, course);
            const slot = findSlot(sid);
            if (!slot || !slot.recipe_id) return "";

            const r = findRecipe(slot.recipe_id);
            const icon = r ? twemojiSvgIcon(recipeIconKey(r)) : twemojiSvgIcon("plate");

            const name = r ? String(r.name || "").trim() : getRecipeName(slot.recipe_id);

            const cls = courseClass(course);
            const recipe = findRecipe(slot.recipe_id);

            return `
              <div class="card ${cls}"
                  onclick="openRecipeViewer('${slot.recipe_id}', event)">
                <span class="cIcon">${icon}</span>
                <span class="cName">${name}</span>
              </div>
            `;

          }).filter(Boolean).join("");


          const clickable = `onclick="openCellEditor('${date}','${m.key}')"`

          const bodyId = mealBodyId(date, m.key);

          // si algun slot d‚Äôaquest meal √©s dirty
          const isMealDirty = Object.keys(DIRTY_SLOTS)
            .some(k => k.startsWith(`${date}_${m.key}_`));

          return `
            <div class="mealRow">
              <div class="mealLabel">${MEALS.find(x=>x.key===m.key)?.label || m.key}</div>

              <div id="${bodyId}"
                class="mealBody meal-${m.key} ${isMealDirty ? "dirty" : ""} ${(noteHtml || cards) ? "hasContent" : ""}"
                data-meal="${m.key}"
                role="button"
                tabindex="0"
                title="Editar ${MEALS.find(x=>x.key===m.key)?.label || m.key}"
                onclick="openCellEditor('${date}','${m.key}')"
                onkeydown="if(event.key==='Enter' || event.key===' ') openCellEditor('${date}','${m.key}')">

                <div class="mealCards">
                  ${noteHtml}
                  ${cards || ""}
                </div>

                ${isMealDirty
                  ? `<div class="badgeRow">
                      <span class="dirtyBadge">Pendent de guardar</span>
                    </div>`
                  : ""}
              </div>
            </div>
          `;



        }).join("");

        return `
          <div class="dayCol" data-date="${date}" style="background:${dayBg}">
            <div class="dayHead">
              <div class="dayName">${dayTitle(date)}</div>
              <div class="dayDate">${date}</div>
            </div>
            <div class="dayMeals">
              ${mealsHtml}
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("grid").innerHTML = `
        <div class="board">
          <div class="weekCols">
            ${colHtml}
          </div>
        </div>
      `;
    }

    function scrollToDateOnMobile(dateISO){
      if (!(window.matchMedia && window.matchMedia("(max-width: 640px)").matches)) return;

      const scroller = document.querySelector(".weekCols");
      if (!scroller) return;

      const el = scroller.querySelector(`.dayCol[data-date="${dateISO}"]`);
      if (!el) return;

      el.scrollIntoView({ behavior: "smooth", inline: "start", block: "nearest" });
    }


    async function addRecipe(){
      showLoading();
      const nameInput = document.getElementById("newName");
      const catSelect = document.getElementById("newCat");
      const iconSel = document.getElementById("newIcon");
      let icon = (iconSel?.value || "").trim();
      const name = nameInput.value.trim();
      const category = catSelect.value;
      if (!name) { hideLoading(); return; }

      const res = await gasp("api_upsertRecipe", { name, category, icon: (document.getElementById("newIconValue").value || "").trim() });

      // Si ha anat b√©
      if (res && res.ok !== false) {
        nameInput.value = "";        // buidar camp
        //nameInput.focus();           // tornar el cursor al camp
        // üîë AFEGIT: refresquem receptes en mem√≤ria
        RECIPES = (await gasp("api_getRecipes"))?.recipes
          .map(r => ({ ...r, count: Number(r.count || 0) }));
      }

      await loadWeekData();
      renderBoard(WEEK_START_ISO);
      // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)
      const todayISO = iso(new Date());
      const dates = buildDates(WEEK_START_ISO);
      scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

      syncMealHeights();
      hideLoading();
    }


    function initDefaultWeek(){
      const today = new Date();
      const monday = startOfWeekMonday(today);
      WEEK_START_ISO = iso(monday);
      document.getElementById("weekLabel").textContent = formatWeekLabel(monday);
    }



    document.getElementById("addBtn").addEventListener("click", addRecipe);

    // ENTER a l'input de nom = afegeix/actualitza
    document.getElementById("newName").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addRecipe();
      }
    });

    // Opcional: ENTER al desplegable de categoria tamb√© afegeix
    document.getElementById("newCat").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addRecipe();
      }
    });


    (async function boot(){
      showLoading();
      try{
        initDefaultWeek();
        await preloadTwemojiSvgs();
        await loadRecipesOnce();
        await loadWeekData();
        renderBoard(WEEK_START_ISO);
        // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)
        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
      } finally {
        hideLoading();
      }
    })();




    let OPEN_CELL = null;

    



    window.openCellEditor = async (date, mealKey) => {
      IS_IN_MODAL = true;
      if (VIEW_MODE === "view") return;

      OPEN_CELL = { date, mealKey };

      const overlay = document.getElementById("overlay");
      const modalBody = document.getElementById("modalBody");
      const title = document.getElementById("modalTitle");
      const sub = document.getElementById("modalSub");

      title.textContent = `Editar ${MEALS.find(x=>x.key===mealKey)?.label || mealKey}`;
      sub.textContent = `${date}`;

      const courses = coursesForMeal(mealKey);
      const existingNote = findNote(date, mealKey);

      const noteBlock = `
        <div class="noteField">
          <label>Comentari (opcional)</label>

          <div class="noteInputWrap">
            <textarea id="noteBox" rows="1"
              placeholder="Ex: Dinem fora, aniversari...">${existingNote || ""}</textarea>

            <button id="clearNoteBtn" type="button" class="noteClearBtn" aria-label="Esborrar comentari">√ó</button>
          </div>

          <div class="noteActions">
            <button id="saveNoteBtn" type="button" class="btnGhost">Guardar comentari</button>
            <span class="muted" style="font-size:12px;">Deixa-ho buit i guarda per eliminar-lo.</span>
          </div>
        </div>
      `;

      const currentByCourse = {};
      courses.forEach(course => {
        const sid = slotId(date, mealKey, course);
        const current = findSlot(sid);
        currentByCourse[course] = current?.recipe_id ? String(current.recipe_id) : "";
      });

      const topBar = `
        <div class="pickerTop">
          <div class="pickerSearch">
            <span class="muted">üîé</span>
            <input id="modalSearch" placeholder="Cerca plats..." autocomplete="off">
          </div>
          <div class="muted" style="font-size:12px;">Tria r√†pid: es guarda en tancar.</div>
        </div>
      `;

      function colTitle(course){
        if (course === "plat") {
          // Un sol ‚Äúplat‚Äù per esmorzar/berenar: t√≠tol del meal
          return MEALS.find(x=>x.key===mealKey)?.label || "Plats";
        }
        if (course === "primer") return "Primers";
        if (course === "segon") return "Segons";
        if (course === "unic") return "Plats √∫nics";
        return "Plats";
      }


      function renderColumn(course){
        const sid = slotId(date, mealKey, course);
        const baseline = currentByCourse[course] || "";

        // si ja hi ha un canvi pendent, que el modal reflecteixi aix√≤
        const selectedId = (DIRTY_SLOTS[sid] && !DIRTY_SLOTS[sid].__delete)
          ? String(DIRTY_SLOTS[sid].recipe_id || "")
          : baseline;

        const list = rankRecipes(RECIPES)
          .filter(r => {
            if (course !== "plat") return allowedForCourse(r, course);

            // course="plat" per esmorzar/berenar: filtra per categoria
            if (mealKey === "breakfast") return String(r.category||"") === "Esmorzar";
            if (mealKey === "snack")     return String(r.category||"") === "Berenar";

            // per defecte (si algun altre meal tingu√©s "plat")
            return true;
          })
          .map(r => {
            const rid = String(r.id);
            const isSel = rid === String(selectedId);
            const safeName = String(r.name||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
            return `
              <button class="rCard ${isSel ? "selected":""}"
                data-course="${course}"
                data-rid="${rid}"
                data-name="${norm_(r.name)}"
                onclick="onPick('${date}','${mealKey}','${course}','${rid}')">
                <div class="rIcon">${twemojiSvgIcon(recipeIconKey(r))}</div>
                <div style="display:flex; flex-direction:column; gap:2px;">
                  <div class="rName">${safeName}</div>
                  <div class="rMeta">${(r.count||0)} usos</div>
                </div>
              </button>
            `;
          }).join("");

        const currentLabel = selectedId ? getRecipeName(selectedId) : "‚Äî Cap ‚Äî";

        return `
          <div class="pickerCol" id="col_${course}">
            <div class="pickerColHeader">
              <div>
                <div class="pickerColTitle">${colTitle(course)}</div>
                <div class="pickerCurrent" id="current_${course}">Ara: ${currentLabel}</div>
              </div>
              <button class="btnGhost" onclick="onPick('${date}','${mealKey}','${course}','')">‚Äî Cap ‚Äî</button>
            </div>
            <div class="pickerList" id="list_${course}">
              ${list || '<div class="muted" style="padding:6px 4px;">No hi ha plats per mostrar.</div>'}
            </div>
          </div>
        `;
      }

      const pickerCols = `
        <div class="pickerCols">
          ${courses.map(renderColumn).join("")}
        </div>
      `;


      

      modalBody.innerHTML = noteBlock + topBar + pickerCols;

      const noteBox = document.getElementById("noteBox");
      const clearBtn = document.getElementById("clearNoteBtn");

      function syncClearBtn(){
        const hasText = (noteBox.value || "").trim().length > 0;
        clearBtn.classList.toggle("hidden", !hasText);
      }

      if (clearBtn && noteBox){
        // Evita que el click ‚Äúmogui‚Äù focus/selecci√≥ de manera estranya
        clearBtn.addEventListener("mousedown", (e) => e.preventDefault());

        clearBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          noteBox.value = "";
          noteBox.dispatchEvent(new Event("input", { bubbles: true }));
          noteBox.focus({ preventScroll: true });
        });

        noteBox.addEventListener("input", syncClearBtn);
        syncClearBtn();
      }


      // Cerca dins el selector (client-side, sense crides)
      const searchEl = document.getElementById("modalSearch");
      if (searchEl){
        searchEl.addEventListener("input", () => {
          const q = norm_(searchEl.value || "");
          document.querySelectorAll(".rCard").forEach(btn => {
            const name = btn.getAttribute("data-name") || "";
            btn.classList.toggle("rHidden", q && !name.includes(q));
          });
        });
        //setTimeout(()=> searchEl.focus(), 0);
      }




      document.getElementById("saveNoteBtn").addEventListener("click", async () => {
        showLoading({ silent: true });
        const note = (document.getElementById("noteBox").value || "").trim();

        await gasp("api_setNote", { date, meal: mealKey, note });

        await loadWeekData();
        DIRTY_SLOTS = {};
        renderBoard(WEEK_START_ISO);
        // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)
        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
        hideLoading();
      });


      overlay.classList.add("open");
      const modal = document.getElementById("modal");
      preventMobileKeyboardOnOpen(modal);


    };


    window.onPick = (date, mealKey, course, recipe_id) => {
      const sid = slotId(date, mealKey, course);
      const meal = `${mealKey}_${course}`;

      // Estat actual (baseline) segons PLAN
      const baseline = findSlot(sid)?.recipe_id ? String(findSlot(sid).recipe_id) : "";
      const nextId = String(recipe_id || "");

      // Si torna a l'estat original => no √©s un canvi pendent
      if (nextId === baseline) {
        delete DIRTY_SLOTS[sid];
      } else if (!nextId) {
        // marcar com a eliminaci√≥ pendent
        DIRTY_SLOTS[sid] = { __delete: true, slot_id: sid };
      } else {
        // marcar com a actualitzaci√≥ pendent
        DIRTY_SLOTS[sid] = { slot_id: sid, date, meal, recipe_id: nextId };
      }

      // Feedback visual al board (badge "pendent")
      recomputeMealDirty(date, mealKey);

      // Actualitzar UI dins el modal (si est√† obert)
      const cur = document.getElementById(`current_${course}`);
      if (cur){
        cur.textContent = `Ara: ${nextId ? getRecipeName(nextId) : "‚Äî Cap ‚Äî"}`;
      }
      document.querySelectorAll(`.rCard[data-course="${course}"]`).forEach(btn => {
        const rid = btn.getAttribute("data-rid") || "";
        btn.classList.toggle("selected", rid === nextId);
      });


    };







    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("closeBtn");

    document.getElementById("modal").addEventListener("click", e => {
      e.stopPropagation();
    });


    const prevWeekBtn = document.getElementById("prevWeekBtn");
    const nextWeekBtn = document.getElementById("nextWeekBtn");
    const weekLabelEl = document.getElementById("weekLabel");

    if (prevWeekBtn){
      prevWeekBtn.addEventListener("click", async () => {
        showLoading();
        const d = parseISO(WEEK_START_ISO);
        const prev = addDaysDate(d, -7);
        WEEK_START_ISO = iso(prev);

        if (weekLabelEl) weekLabelEl.textContent = formatWeekLabel(prev);

        await loadWeekData();
        renderBoard(WEEK_START_ISO);

        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        hideLoading();
      });
    } else {
      console.warn("prevWeekBtn not found");
    }

    if (nextWeekBtn){
      nextWeekBtn.addEventListener("click", async () => {
        showLoading();
        const d = parseISO(WEEK_START_ISO);
        const next = addDaysDate(d, 7);
        WEEK_START_ISO = iso(next);

        if (weekLabelEl) weekLabelEl.textContent = formatWeekLabel(next);

        await loadWeekData();
        renderBoard(WEEK_START_ISO);

        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
        hideLoading();
      });
    } else {
      console.warn("nextWeekBtn not found");
    }




    async function closeModal(){
      overlay.classList.remove("open");
      OPEN_CELL = null;
      IS_IN_MODAL = false;

      const changes = Object.values(DIRTY_SLOTS);
      if (!changes.length) return;

      showLoading();

      const res = await gasp("api_applySlotChanges", { changes });
      if (res?.ok === false) {
        hideLoading();
        toast("error", "No s'ha pogut guardar", res.error || "");
        return;
      }

      DIRTY_SLOTS = {};
      await loadWeekData();
      renderBoard(WEEK_START_ISO);
      // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)
      const todayISO = iso(new Date());
      const dates = buildDates(WEEK_START_ISO);
      scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

      syncMealHeights();
      hideLoading();
      toast("success", "Men√∫ actualitzat", "Canvis guardats.");
    }


    closeBtn.addEventListener("click", closeModal);

    // clic fora del quadre (overlay) => tanca
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeModal();
    });

    function recomputeMealDirty(date, mealKey){
      const stillDirty = Object.keys(DIRTY_SLOTS).some(k => k.startsWith(`${date}_${mealKey}_`));
      markMealDirty(date, mealKey, stillDirty);
    }
    function syncMealHeights(){
      // En m√≤bil (carrusel), no igualem al√ßades
      if (window.matchMedia && window.matchMedia("(max-width: 640px)").matches) {
        document.querySelectorAll(".mealBody").forEach(el => el.style.minHeight = "0");
        return;
      }

      const keys = ["breakfast","lunch","snack","dinner"];

      // reset
      document.querySelectorAll(".mealBody").forEach(el => {
        el.style.minHeight = "0";
      });

      keys.forEach(k => {
        const els = Array.from(document.querySelectorAll(`.mealBody[data-meal="${k}"]`));
        if (!els.length) return;

        const maxH = Math.max(...els.map(el => el.getBoundingClientRect().height));
        els.forEach(el => el.style.minHeight = `${Math.ceil(maxH)}px`);
      });
    }


    let RECIPE_EDITOR_OPEN = false;
    let SELECTED_RECIPE_ID = null;
    let RECIPE_DIRTY = false;

    function setRecipeDirty(isDirty){
      RECIPE_DIRTY = !!isDirty;

      const topBtn = document.getElementById("recipeSaveTopBtn");
      const topStatus = document.getElementById("recipeTopStatus");

      if (topBtn) topBtn.disabled = !RECIPE_DIRTY || !SELECTED_RECIPE_ID;

      if (topStatus){
        topStatus.textContent = RECIPE_DIRTY ? "Canvis pendents" : "";
      }
    }


    function openRecipeEditor(){
      RECIPE_EDITOR_OPEN = true;
      SELECTED_RECIPE_ID = null;

      document.getElementById("recipeOverlay").classList.add("open");
      document.getElementById("recipeEmpty").style.display = "block";
      document.getElementById("recipeForm").style.display = "none";
      document.getElementById("recipeSearchInput").value = "";

      renderRecipeList();
      setTimeout(() => {
        if (Array.isArray(RECIPES) && RECIPES.length) {
          selectRecipeForEdit(String(RECIPES[0].id));
        }
      }, 0);
    }

    function closeRecipeEditor(){
      if (RECIPE_DIRTY){
        const ok = confirm("Tens canvis pendents. Vols tancar sense guardar?");
        if (!ok) return;
      }
      RECIPE_EDITOR_OPEN = false;
      document.getElementById("recipeOverlay").classList.remove("open");
    }


    function renderRecipeList(){
      const q = norm_(document.getElementById("recipeSearchInput").value || "");
      const listEl = document.getElementById("recipeList");
      listEl.innerHTML = "";

      const items = rankRecipes(RECIPES).filter(r => {
        if (!q) return true;
        return norm_(r.name || "").includes(q);
      });

      if (!items.length){
        listEl.innerHTML = `<div class="muted" style="padding:6px 4px;">No hi ha receptes.</div>`;
        return;
      }

      for (const r of items){
        const row = document.createElement("div");
        row.className = "recipeRow" + (String(r.id) === String(SELECTED_RECIPE_ID) ? " selected" : "");
        row.innerHTML = `
          <div class="recipeBadge">${twemojiSvgIcon(recipeIconKey(r))}</div>
          <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${(r.name||"")}</div>
            <div class="muted" style="font-size:12px;">${(r.category||"")}</div>
          </div>
        `;
        row.addEventListener("click", ()=> selectRecipeForEdit(String(r.id)));
        listEl.appendChild(row);
      }
    }

    function selectRecipeForEdit(id){
      SELECTED_RECIPE_ID = id;
      renderRecipeList();

      const r = RECIPES.find(x => String(x.id) === String(id));
      if (!r) return;

      document.getElementById("recipeEmpty").style.display = "none";
      document.getElementById("recipeForm").style.display = "flex";

      // Update the icon picker
      const iconValue = String(r.icon || "");
      document.getElementById("rIconValue").value = iconValue;
      selectIconInPicker(document.getElementById("rIconPicker"), iconValue);
      
      // Update preview
      const previewEl = document.getElementById("rIconPreview");
      if (previewEl) {
        previewEl.innerHTML = twemojiSvgIcon(iconValue) || twemojiSvgIcon("plate");
      }
      
      document.getElementById("rName").value = String(r.name || "");
      document.getElementById("rCategory").value = String(r.category || "");
      document.getElementById("rIngredients").value = String(r.ingredients || "");
      document.getElementById("rSteps").value = String(r.steps || "");
      document.getElementById("rVideo").value = String(r.video_url || "");
      document.getElementById("rStatus").textContent = "";
      setRecipeDirty(false);
    }

    async function saveRecipeDetails(){
      if (!SELECTED_RECIPE_ID) return;

      const payload = {
        id: SELECTED_RECIPE_ID,
        icon: (document.getElementById("rIconValue").value || "").trim(),
        name: (document.getElementById("rName").value || "").trim(),
        category: (document.getElementById("rCategory").value || "").trim(),
        ingredients: (document.getElementById("rIngredients").value || "").trim(),
        steps: (document.getElementById("rSteps").value || "").trim(),
        video_url: (document.getElementById("rVideo").value || "").trim(),
      };

      document.getElementById("rStatus").textContent = "Guardant...";
      showLoading({ silent: true });

      const topBtn = document.getElementById("recipeSaveTopBtn");
      const topStatus = document.getElementById("recipeTopStatus");
      if (topStatus) topStatus.textContent = "Guardant...";
      if (topBtn) topBtn.disabled = true;


      try{
        const res = await gasp("api_updateRecipeDetails", payload);
        if (res?.ok === false) throw new Error(res.error || "Error");

        // Recarrega RECIPES (per veure canvis a icona/nom al picker i al board)
        const rr = await gasp("api_getRecipes");
        RECIPES = (rr?.recipes || []).map(x => ({...x, count:Number(x.count||0)}));

        document.getElementById("rStatus").textContent = "Guardat.";
        toast("success", "Recepta guardada");
        renderRecipeList();
        // tamb√© refresquem el board perqu√® icones/nom reflecteixin immediatament
        renderBoard(WEEK_START_ISO);
        // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)

        setRecipeDirty(false);
        if (topStatus) topStatus.textContent = "Guardat";
        setTimeout(()=>{ if (document.getElementById("recipeTopStatus")) document.getElementById("recipeTopStatus").textContent = ""; }, 1200);

        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
      } catch(err){
        document.getElementById("rStatus").textContent = "Error en guardar.";
        if (topStatus) topStatus.textContent = "Error en guardar";
        if (topBtn) topBtn.disabled = false;
        toast("error", "No s'ha pogut guardar", String(err));
      } finally {
        hideLoading();
      }
    }

    // Wire events
    document.addEventListener("DOMContentLoaded", () => {
      const recipeOverlayEl = document.getElementById("recipeOverlay");
      const recipeModalEl = document.getElementById("recipeModal");
      const recipeCloseBtnEl = document.getElementById("recipeCloseBtn");

      if (recipeOverlayEl) {
        recipeOverlayEl.addEventListener("click", (e) => {
          if (e.target === recipeOverlayEl) closeRecipeEditor();
        });
      } else {
        console.warn("recipeOverlay not found");
      }

      if (recipeModalEl) {
        recipeModalEl.addEventListener("click", (e) => e.stopPropagation());
      } else {
        console.warn("recipeModal not found");
      }

      if (recipeCloseBtnEl) {
        recipeCloseBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          closeRecipeEditor();
        });
      } else {
        console.warn("recipeCloseBtn not found");
      }

      const manageRecipesBtnEl = document.getElementById("manageRecipesBtn");
      if (manageRecipesBtnEl) {
        manageRecipesBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          openRecipeEditor();
          const modal = document.getElementById("recipeModal");
          preventMobileKeyboardOnOpen(modal);

        });
      } else {
        console.warn("manageRecipesBtn not found");
      }

      const recipeSaveTopBtnEl = document.getElementById("recipeSaveTopBtn");
      if (recipeSaveTopBtnEl) {
        recipeSaveTopBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          saveRecipeDetails();
        });
      }

      const recipeSearchInputEl = document.getElementById("recipeSearchInput");
      if (recipeSearchInputEl) {
        recipeSearchInputEl.addEventListener("input", () => {
          renderRecipeList();
        });

        // opcional: ESC neteja la cerca
        recipeSearchInputEl.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            recipeSearchInputEl.value = "";
            renderRecipeList();
          }
        });
      } else {
        console.warn("recipeSearchInput not found");
      }

      const markDirty = () => setRecipeDirty(true);

      ["rName","rCategory","rIcon","rIngredients","rSteps","rVideo"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", markDirty);
        el.addEventListener("change", markDirty);
      });


    });
   



    

    function getRecipeName(id){
      const r = findRecipe(id);
      if (!r) return "‚Äî";
      return String(r.name || "").trim() || "‚Äî";
    }

    window.openRecipeViewer = (recipeId, ev) => {
      if (ev) ev.stopPropagation(); // clau: que no obri el planificador

      const r = RECIPES.find(x => String(x.id) === String(recipeId));
      if (!r) return;
      
      RV_RECIPE_ID = String(recipeId || "");

      const title = document.getElementById("rvTitle");
      const meta  = document.getElementById("rvMeta");
      const ing   = document.getElementById("rvIngredients");
      const steps = document.getElementById("rvSteps");
      const vWrap = document.getElementById("rvVideoWrap");
      const vLink = document.getElementById("rvVideoLink");

      const safeName = String(r.name || "Recepta")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");

      title.innerHTML = `${twemojiSvgIcon(recipeIconKey(r))} <span>${safeName}</span>`;

      meta.textContent  = String(r.category || "");

      ing.textContent   = String(r.ingredients || "‚Äî");
      steps.textContent = String(r.steps || "‚Äî");

      const url = String(r.video_url || "").trim();
      if (url) {
        vWrap.style.display = "block";
        vLink.href = url;
      } else {
        vWrap.style.display = "none";
        vLink.href = "#";
      }

      document.getElementById("recipeViewOverlay").classList.add("open");
    };

    function closeRecipeViewer(){
      document.getElementById("recipeViewOverlay").classList.remove("open");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const ov = document.getElementById("recipeViewOverlay");
      const modal = document.getElementById("recipeViewModal");
      const btn = document.getElementById("rvCloseBtn");
      const closeBtn = document.getElementById("rvCloseBtn");
      const editBtn  = document.getElementById("rvEditBtn");

      if (closeBtn) closeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        closeRecipeViewer();
      });

      if (editBtn) editBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const id = RV_RECIPE_ID;
        if (!id) return;

        // 1) tanca visor
        closeRecipeViewer();

        // 2) obre editor
        openRecipeEditor();
        const modal = document.getElementById("recipeModal");
        preventMobileKeyboardOnOpen(modal);


        // 3) selecciona recepta (deixa un tick perqu√® el DOM i la llista estiguin pintats)
        setTimeout(() => {
          selectRecipeForEdit(String(id));
          // opcional: porta el focus al nom
          //setTimeout(() => document.getElementById("rName")?.focus(), 0);
        }, 0);
      });

      // clic fora del modal tanca
      if (ov) ov.addEventListener("click", (e) => {
        if (e.target === ov) closeRecipeViewer();
      });

      // evita propagaci√≥ dins modal
      if (modal) modal.addEventListener("click", (e) => e.stopPropagation());
    });

    document.addEventListener("DOMContentLoaded", () => {
      // New recipe icon picker
      const newPickerEl = document.getElementById("newIconPicker");
      if (newPickerEl) {
        fillIconPickerForAdd(newPickerEl, { includeAuto: true });
      }

      // Recipe editor icon picker
      const recipePickerEl = document.getElementById("rIconPicker");
      if (recipePickerEl) {
        fillIconPicker(recipePickerEl, { includeAuto: true });
      }
    });

    function fillIconPickerForAdd(pickerEl, { includeAuto = true } = {}) {
      if (!pickerEl) return;

      pickerEl.innerHTML = "";
      const keys = includeAuto ? ICON_KEYS : ICON_KEYS.filter(k => k !== "auto");

      for (const key of keys) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "iconPickerBtn";
        btn.dataset.iconKey = key;
        btn.title = ICON_LABELS[key] || key;
        
        // Render the icon
        const iconHtml = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
        btn.innerHTML = iconHtml;
        
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          // Remove selection from all buttons
          pickerEl.querySelectorAll(".iconPickerBtn").forEach(b => b.classList.remove("selected"));
          // Select this button
          btn.classList.add("selected");
          // Store the value and trigger preview update
          const previewEl = document.getElementById("newIconPreview");
          if (previewEl) {
            previewEl.innerHTML = iconHtml;
          }
          // Store value for saving (in hidden input)
          const hiddenInput = document.getElementById("newIconValue");
          if (hiddenInput) {
            hiddenInput.value = key === "auto" ? "" : key;
          }
        });
        
        pickerEl.appendChild(btn);
      }
    }
    function fillIconPicker(pickerEl, { includeAuto = true } = {}) {
      if (!pickerEl) return;

      pickerEl.innerHTML = "";
      const keys = includeAuto ? ICON_KEYS : ICON_KEYS.filter(k => k !== "auto");

      for (const key of keys) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "iconPickerBtn";
        btn.dataset.iconKey = key;
        btn.title = ICON_LABELS[key] || key;
        
        // Render the icon
        const iconHtml = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
        btn.innerHTML = iconHtml;
        
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          // Remove selection from all buttons
          pickerEl.querySelectorAll(".iconPickerBtn").forEach(b => b.classList.remove("selected"));
          // Select this button
          btn.classList.add("selected");
          // Store the value and trigger preview update
          const previewEl = document.getElementById("rIconPreview");
          if (previewEl) {
            previewEl.innerHTML = iconHtml;
          }
          // Store value for saving (in a hidden input)
          const hiddenInput = document.getElementById("rIconValue");
          if (hiddenInput) {
            hiddenInput.value = key === "auto" ? "" : key;
          }
          // Mark form as dirty
          setRecipeDirty(true);
        });
        
        pickerEl.appendChild(btn);
      }
    }

    function selectIconInPicker(pickerEl, iconKey) {
      if (!pickerEl) return;
      
      // Clear previous selection
      pickerEl.querySelectorAll(".iconPickerBtn").forEach(b => b.classList.remove("selected"));
      
      // Find and select the button with this key
      const btn = pickerEl.querySelector(`[data-icon-key="${iconKey || "auto"}"]`);
      if (btn) {
        btn.classList.add("selected");
      }
    }

    function bindIconPreview(selectEl, previewEl) {
      if (!selectEl || !previewEl) return;

      const render = () => {
        const key = String(selectEl.value || "").trim();
        // si √©s Auto (value=""), mostra plate
        previewEl.innerHTML = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
      };

      selectEl.addEventListener("change", render);
      render();
    }
    function preventMobileKeyboardOnOpen(modalEl){
      // 1) Si hi ha algun input enfocat, el desfocusem
      if (document.activeElement && typeof document.activeElement.blur === "function") {
        document.activeElement.blur();
      }

      // 2) Focalitzem un element no-editable (no obre teclat)
      // IMPORTANT: el modal ha de tenir tabindex="-1" (veure punt 2)
      if (modalEl && typeof modalEl.focus === "function") {
        // defer per evitar que algun altre focus "guanyi" just despr√©s
        setTimeout(() => modalEl.focus({ preventScroll: true }), 0);
      }

      // 3) Assegurem que cap input/textarea quedi amb autofocus
      if (modalEl){
        modalEl.querySelectorAll("input[autofocus], textarea[autofocus]").forEach(el => el.removeAttribute("autofocus"));
      }
    }

    async function login(code) {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      });
    
      const data = await res.json();
    
      if (!data.ok) {
        throw new Error(data.error || "Login failed");
      }
    
      // üîê AQU√ç √âS EL PUNT 1
      localStorage.setItem("mf_token", data.token);
      localStorage.setItem("mf_family", JSON.stringify(data.family));
    
      return data;
    }

    function isLoggedIn() {
      return !!localStorage.getItem("mf_token");
    }
    
    async function bootstrapAuth() {
      const token = localStorage.getItem("mf_token");
      if (!token) {
        console.log("No token. Not logged in.");
        return;
      }
    
      const res = await apiFetch("/api/me");
      const data = await res.json().catch(() => null);
    
      if (!res.ok || !data?.ok) {
        console.log("Token invalid/expired. Clearing.", data);
        localStorage.removeItem("mf_token");
        localStorage.removeItem("mf_family");
        return;
      }
    
      console.log("Token valid. Payload:", data.payload);
      // aqu√≠ ja pots activar la UI ‚Äúloguejada‚Äù de forma segura
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      bootstrapAuth();
    });

    
    document.addEventListener("DOMContentLoaded", () => {
      renderAuthState();
    });

    async function apiFetch(path, options = {}) {
      const token = localStorage.getItem("mf_token");
      const headers = {
        ...(options.headers || {}),
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
      };
    
      const res = await fetch(path, { ...options, headers });
      return res;
    }

    // ===== AUTH (client) =====
    const AUTH_TOKEN_KEY = "mf_token";
    const AUTH_FAMILY_KEY = "mf_family";

    function setAuth(token, family) {
      localStorage.setItem("mf_token", token);
      localStorage.setItem("mf_family", JSON.stringify(family));
    }
  
    function clearAuth() {
      localStorage.removeItem("mf_token");
      localStorage.removeItem("mf_family");
    }
  
    function getAuth() {
      const token = localStorage.getItem("mf_token");
      const familyRaw = localStorage.getItem("mf_family");
      let family = null;
      try { family = familyRaw ? JSON.parse(familyRaw) : null; } catch {}
      return { token, family };
    }
  
    function renderAuthState() {
      const { token, family } = getAuth();
  
      const statusEl = document.getElementById("authStatus");
      const inputEl  = document.getElementById("familyCodeInput");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
  
      const logged = !!token && !!family;
  
      if (logged) {
        statusEl.textContent = `Autenticat: ${family.name}`;
        inputEl.style.display = "none";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        statusEl.textContent = "No autenticat";
        inputEl.style.display = "inline-block";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    }
  
    async function apiFetch(path, options = {}) {
      const token = localStorage.getItem("mf_token");
      const headers = {
        ...(options.headers || {}),
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
      };
      const res = await fetch(path, { ...options, headers });
      return res;
    }
  
    async function bootstrapAuth() {
      // 1) Pinta r√†pid el que hi ha a localStorage
      renderAuthState();
  
      // 2) Si hi ha token, valida'l contra el server
      const token = localStorage.getItem("mf_token");
      if (!token) return;
  
      const res = await apiFetch("/api/me");
      const data = await res.json().catch(() => null);
  
      if (!res.ok || !data?.ok) {
        console.log("Token invalid/expirat. Netejant.", data);
        clearAuth();
        renderAuthState();
        return;
      }
  
      // Opcional: sincronitza family des del payload si vols
      const fam = { id: data.payload.family_id, name: data.payload.family_name };
      localStorage.setItem("mf_family", JSON.stringify(fam));
      renderAuthState();
    }
  
    async function doLogin() {
      const code = (document.getElementById("familyCodeInput").value || "").trim();
      if (!code) return alert("Introdueix el codi de fam√≠lia");
  
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code }),
      });
  
      const data = await res.json().catch(() => null);
      if (!res.ok || !data?.ok) {
        return alert(data?.error || "Login error");
      }
  
      setAuth(data.token, data.family);
      renderAuthState();
    }
  
    function doLogout() {
      clearAuth();
      renderAuthState();
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").addEventListener("click", doLogin);
      document.getElementById("logoutBtn").addEventListener("click", doLogout);
  
      // Enter per login
      document.getElementById("familyCodeInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") doLogin();
      });
  
      bootstrapAuth();
    });
  </script>

  </div>
  <div id="toastWrap" class="toastWrap"></div>

  <div id="recipeOverlay" class="overlay">
    <div id="recipeModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">Receptes</div>
          <div class="muted" style="font-size:12px;">Edita ingredients, passos, v√≠deo i icona</div>
        </div>

        <div class="modalHeaderActions">
          <span id="recipeTopStatus" class="muted" style="font-size:12px;"></span>
          <button id="recipeSaveTopBtn" class="btnPrimary" disabled>Guardar</button>
          <button id="recipeCloseBtn">Tancar</button>
        </div>
      </div>
      <div class="recipeEditor">
        <div class="recipeListPane">
          <div class="recipeSearch">
            <span class="muted">üîé</span>
            <input id="recipeSearchInput" placeholder="Cerca receptes..." autocomplete="off">
          </div>
          <div id="recipeList" class="recipeList"></div>
        </div>

        <div class="recipeDetailPane">
          <div id="recipeEmpty" class="muted">Selecciona una recepta a l‚Äôesquerra.</div>

          <div id="recipeForm" class="recipeForm" style="display:none;">
            <div class="recipeFormTop">
              <div class="recipeHeaderGrid">
                <div class="rhName">
                  <input id="rName" placeholder="Nom de la recepta">
                </div>

                <div class="rhIcon">
                  <div id="rIconPicker" class="iconPickerGrid"></div>
                  <span id="rIconPreview" class="iconPreview" aria-hidden="true"></span>
                </div>
                <input type="hidden" id="rIconValue">

                <div class="rhCat">
                  <select id="rCategory" title="Categoria">
                    <option value="Primer">Primer</option>
                    <option value="Segon">Segon</option>
                    <option value="Plat √∫nic">Plat √∫nic</option>
                    <option value="Esmorzar">Esmorzar</option>
                    <option value="Berenar">Berenar</option>
                  </select>
                </div>
              </div>

            </div>

            <label class="muted" style="font-size:12px;margin-top:8px;">Ingredients (1 per l√≠nia)</label>
            <textarea id="rIngredients" rows="5" placeholder="- Patates&#10;- Ceba&#10;- Oli..."></textarea>

            <label class="muted" style="font-size:12px;margin-top:8px;">Passos (1 per l√≠nia o numerat)</label>
            <textarea id="rSteps" rows="7" placeholder="1) ...&#10;2) ..."></textarea>

            <label class="muted" style="font-size:12px;margin-top:8px;">V√≠deo (URL)</label>
            <input id="rVideo" placeholder="https://...">

            <div class="noteActions" style="justify-content:space-between;">
              <div class="muted" id="rStatus" style="font-size:12px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="recipeViewOverlay" class="overlay">
    <div id="recipeViewModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modalHeader">
        <div>
          <div id="rvTitle" class="modalTitle">Recepta</div>
          <div id="rvMeta" class="muted" style="font-size:12px;"></div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button id="rvEditBtn" class="btnPrimary">Editar</button>
          <button id="rvCloseBtn">Tancar</button>
        </div>
      </div>


      <div class="modalBody" style="grid-template-columns: 1fr;">
        <div class="panel" style="background: rgba(255,255,255,0.65);">
          <div style="font-weight:800; margin-bottom:6px;">Ingredients</div>
          <pre id="rvIngredients" style="margin:0; white-space:pre-wrap; font-family:inherit; font-size:14px; color:rgba(0,0,0,0.78);"></pre>
        </div>

        <div class="panel" style="background: rgba(255,255,255,0.65);">
          <div style="font-weight:800; margin-bottom:6px;">Passos</div>
          <pre id="rvSteps" style="margin:0; white-space:pre-wrap; font-family:inherit; font-size:14px; color:rgba(0,0,0,0.78);"></pre>
        </div>

        <div id="rvVideoWrap" class="panel" style="display:none; background: rgba(255,255,255,0.65);">
          <div style="font-weight:800; margin-bottom:6px;">V√≠deo</div>
          <a id="rvVideoLink" href="#" target="_blank" rel="noopener">Obrir v√≠deo</a>
        </div>
      </div>
    </div>
  </div>
 
</body>
</html>
