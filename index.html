<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,interactive-widget=resizes-content" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Men√∫ setmanal" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg" />
  <link rel="apple-touch-icon" href="/icons/icon-192.svg" />
  <title>Men√∫ setmanal</title>
  <style>
    
  :root{
    --text:#111;
    --muted:#6b7280;
    --line: rgba(0,0,0,0.08);
    --card: rgba(255,255,255,0.70);
    --shadow: 0 12px 26px rgba(0,0,0,0.06);
    --radius: 16px;
  }

  html {
    height: 100%;
  }

  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif;
    margin: 0;
    color: #111;
    background: transparent;
    min-height: 100vh;
    min-height: 100dvh;
  }


  .panel{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.70);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 14px;
  }

  .panelTitle{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap: 10px;
    margin-bottom: 10px;
  }

  .inputWide{
    min-width: 200px;
  }

  @media (max-width: 520px){
    .inputWide{ min-width: 100%; }
  }

  /* Orientation support - landscape/portrait adaptive */
  @media (orientation: landscape) and (max-height: 500px) {
    .container {
      padding: 12px;
    }
  }




  .container{
    max-width: 1200px;
    margin: 0 auto;        /* <- fora el 40px inferior */
    padding: 18px;         /* <- mantenim aire */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow-x: visible;
  }


  /* Protected family buttons look disabled but keep same size/alignment */
  .protected-btn {
    opacity: 0.5;
    cursor: default;
    pointer-events: none;
  }
  .container.not-authenticated > :not(.topbar) {
    display: none;
  }

  .container.not-authenticated .weekControls {
    display: none;
  }


  h2,h3{
    margin: 0;
    letter-spacing: .2px;
  }

  hr{
    border: 0;
    height: 1px;
    background: var(--line);
    margin: 12px 0;
  }

  .row{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  /* Toast */
  .toastWrap{
    position: fixed;
    left: 18px;
    bottom: 18px;
    z-index: 10000;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .toast{
    min-width: 240px;
    max-width: min(520px, calc(100vw - 36px));
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(255,255,255,0.92);
    box-shadow: 0 16px 40px rgba(0,0,0,0.16);
    backdrop-filter: blur(6px);
    font-size: 14px;
  }
  .toast.success{ border-color: rgba(16,185,129,0.35); }
  .toast.error{ border-color: rgba(239,68,68,0.35); }

  .toastTitle{ font-weight: 800; margin-bottom: 2px; }
  .toastBody{ color: rgba(0,0,0,0.72); }


  .gcNavBtn{
    width: 40px;
    height: 40px;
    padding: 0;
    border-radius: 999px;
    background: rgba(255,255,255,0.8);
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    display:flex;
    align-items:center;
    justify-content:center;
    transition: background .12s ease, transform .12s ease;
  }

  .gcNavBtn:hover{ background: rgba(255,255,255,1); }
  .gcNavBtn:active{ transform: translateY(1px); }

  .weekPill{
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.70);
    color: rgba(0,0,0,0.70);
    font-size: 14px;
  }


  /* Dirty state per meal slot */
  .mealBody.dirty{
    outline: 2px solid rgba(245,158,11,0.35);
    background: rgba(255,255,255,0.80);
  }

  .mealBody.saveError{
    outline: 2px solid rgba(239,68,68,0.35);
  }

  /* Badge petit ‚ÄúPendent‚Äù */
  .dirtyBadge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(245,158,11,0.30);
    background: rgba(245,158,11,0.12);
    color: rgba(0,0,0,0.72);
  }

  .badgeRow{
    display:flex;
    justify-content:flex-end;
    margin-top: 6px;
  }



  .topbar { 
    display: grid; 
    grid-template-columns: auto 1fr auto; 
    align-items: center; 
    gap: 12px;
    grid-template-areas: "title week auth";
  }

  .topbar .titleRow {
    grid-area: title;
  }

  .topbar .weekControls {
    grid-area: week;
    justify-self: center;
  }

  .topbar .authBar {
    grid-area: auth;
    justify-self: end;
  }
  .muted { color:#666; font-size:13px; }
  button, input, select, textarea{
    font-size: 15px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: #fff;
    outline: none;
  }

  button{
    cursor: pointer;
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
  }

  button:hover{ background: #fbfbfb; }
  button:active{ transform: translateY(1px); }

  button:disabled{
    opacity: .55;
    cursor: not-allowed;
    transform: none;
  }

  input, select, textarea{
    background: rgba(255,255,255,0.85);
  }

  input:focus, select:focus, textarea:focus{
    border-color: rgba(0,0,0,0.18);
    box-shadow: 0 0 0 4px rgba(74,124,255,0.10);
  }

  .board {
    margin-top: 8px;
    border: 0;
    border-radius: 0;

    /* CLAU: si no hi caben 7 dies, fem scroll horitzontal (no apilem) */
    overflow-x: hidden;
    overflow-y: visible;

    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px;
  }

  .weekCols{
    display: grid;
    grid-template-columns: repeat(7, minmax(130px, 1fr));
    gap: 10px;

    /* CLAU: forcem una amplada m√≠nima perqu√® el grid NO col¬∑lapsi ni apili */
    min-width: 0;
  }


.topbar h2{
  font-size: 20px;     /* prova 19‚Äì22 segons gust */
  margin: 0;
}

  .actions{
    display:flex;
    gap: 10px;
    align-items:center;
  }

  .btnPrimary{
    background: #1a73e8;
    color: #fff;
    border-color: rgba(26,115,232,0.35);
  }
  .btnPrimary:hover{ background:#1667cf; }


  .btnGhost{
    background: rgba(255,255,255,0.7);
  }

  .weekControls{
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .iconBtn{
    width: 44px;
    height: 44px;
    padding: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius: 14px;
  }

  .dayHead{
    display:flex;
    flex-direction: row;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 4px;
  }

  .dayName{
    font-weight: 900;
    text-transform: uppercase;
    font-size: 13px;
    opacity: .85;
    margin: 0;
  }

  .dayDate{
    font-size: 12px;
    opacity: .65;
    margin: 0;
    white-space: nowrap;
  }




  .mealBody:hover{
    background: rgba(255,255,255,0.75);
  }



  .mealIcon{
    width: 16px;
    height: 16px;
    border-radius: 6px;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity: .65;
    margin-top: 0;
    font-size: 12px;
    user-select:none;
  }






  /* Scroll discret */
  .mealCards::-webkit-scrollbar{ width: 8px; }
  .mealCards::-webkit-scrollbar-thumb{
    background: rgba(0,0,0,0.12);
    border-radius: 999px;
  }


  /* Les teves cards funcionen igual; nom√©s les ajustem una mica */
  .card{
    padding: 6px 10px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: none;
    font-size: 12.5px;
    background: rgba(255,255,255,0.65);
    display:flex;
    flex-direction: column;
    gap:8px;
    align-items:flex-start;
  }
  .card.primer {
    background:#fff7c7;
    border-left: 4px solid #f59e0b;
  }
  .card.segon  {
    background:#d8e9ff;
    border-left: 4px solid #3b82f6;
  }
  .card.unic   {
    background:#c9f2d2;
    border-left: 4px solid #22c55e;
  }

  .cIcon{ line-height:1; display: flex; gap: 4px; flex-wrap: wrap; }
  .iconItem{ line-height: 1; }
  .cName{ min-width:0; }
  /* Popup */

  .overlay{
    position:fixed; inset:0;
    background: rgba(17,24,39,0.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 9999;
    padding-top: max(18px, env(safe-area-inset-top));
    padding-bottom: max(18px, env(safe-area-inset-bottom));
  }

  .overlay.open{ display:flex; }

  .modal{
    width: min(1100px, 100%);
    background: rgba(255,255,255,0.92);
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.10);
    box-shadow: 0 30px 80px rgba(0,0,0,0.25);
    padding: 14px;
    backdrop-filter: blur(6px);
    height: min(92vh, 100svh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    max-height: 90svh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .modalBody {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
    gap: 0;
    -webkit-overflow-scrolling: touch;
    min-height: 0;
  }

  .modalHeader{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 10px;
    padding: 6px 6px 10px 6px;
    flex: 0 0 auto;
  }

  .modalHeaderActions{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .modalTitle{ font-weight: 900; font-size: 16px; min-width: 0; word-break: break-word; display: flex; align-items: center; gap: 6px; }



  .noteField{
    grid-column: 1 / -1;
    background: rgba(255,255,255,0.65);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    padding: 12px;
  }

  .noteField label{
    display:block;
    font-size: 12px;
    color: rgba(0,0,0,0.55);
    margin-bottom: 6px;
  }


  #noteBox{
    width: 100%;
    height: 40px;
    min-height: 40px;
    max-height: 40px;
    resize: none;
    overflow: hidden;
    padding: 10px 40px 10px 12px;  /* espai a la dreta per la creu */
    font-size: 14px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(255,255,255,0.85);
    line-height: 20px;
    box-sizing: border-box;
  }

  .noteClearBtn:active{ transform: translateY(-50%) scale(0.98); }
  .noteClearBtn.hidden{ display: none; }

  .noteInputWrap{
    position: relative;
    width: 100%;
  }

  .noteClearBtn{
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    border-radius: 10px;
    padding: 0;
    line-height: 28px;
    font-size: 16px;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.85);
  }

  .noteClearBtn:hover{
    background: rgba(255,255,255,1);
  }


  .noteActions{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  @media (max-width: 720px){
    .modalBody{ grid-template-columns: 1fr; }
  }


  .field { display:flex; flex-direction:column; gap:8px; }
  .field label { font-size:13px; color:#666; }
  .field select { width:100%; }
  .hint { font-size:12px; color:#666; margin-top:10px; }
  .bCell { cursor: pointer; }
  .cards { gap: 6px; }
  .card {
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
  }

  .loading {
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading.hidden {
    display: none;
  }

  .loadingBox {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px 26px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
  }

  .spinner {
    width: 42px;
    height: 42px;
    border: 4px solid #e0e0e0;
    border-top-color: #4a7cff;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loadingText {
    font-size: 14px;
    color: #333;
  }

  .noteLine{
    font-size: 13px;
    padding: 8px 10px;
    border-radius: 10px;
    background: #f3f3f3;
    border: 1px solid rgba(0,0,0,0.06);
    color: #333;
  }

  /* --- Layout estable dins de cada dia (Flex) --- */

  .dayCol{
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: auto;
    overflow: visible;
    padding-bottom: 10px;
  }

  .dayMeals{
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Una fila per √†pat: icona + bloc clickable */
  .mealRow{
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  .mealLabel{
    width: 100%;
    font-weight: 600;
    font-size: 13px;
    color: rgba(0,0,0,0.65);
    padding: 0 8px;
    text-transform: uppercase;
  }
  /* icona a l‚Äôesquerra */
  .mealIcon{
    width: 16px;
    height: 16px;
    border-radius: 7px;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    flex: 0 0 16px;
    margin-top: 10px; /* alinea amb el bloc */
  }

  /* bloc de l‚Äô√†pat (buit o amb cards) */
  .mealBody{
    flex: 1 1 auto;
    min-height: 52px;
    width: 100%;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
    background: rgba(255,255,255,0.55);
    padding: 8px 8px 8px 8px;
    transition: background .12s ease, transform .12s ease;
  }

  /* Touchscreen devices: more left padding for easier touch interaction */
  @media (hover: none) and (pointer: coarse) {
    .mealBody {
      padding: 8px 8px 8px 56px;
    }
  }

  /* Non-touch devices (mouse/trackpad): standard padding */
  @media (hover: hover) and (pointer: fine) {
    .mealBody {
      padding: 8px 8px 8px 8px;
    }
  }

  .mealBody:hover{
    background: rgba(255,255,255,0.75);
  }

  .mealCards{
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* A m√≤bil, una mica m√©s compacte */
  @media (max-width: 520px){
    .mealIcon{ margin-top: 8px; }
    .mealBody{ min-height: 48px; }
  }



  /* Fix grid shrink: evita amplades diferents per contingut intern */
  .dayCol,
  .mealRow,
  .mealBody,
  .mealCards{
    min-width: 0;
  }

  .mealBody.meal-breakfast .mealCards,
  .mealBody.meal-snack .mealCards{
    overflow: hidden; /* normalment no cal scroll aqu√≠ */
  }

  .mealBody.meal-lunch .mealCards,
  .mealBody.meal-dinner .mealCards{
    overflow: auto;
  }


  html, body{
    height: auto;
    min-height: 100%;
    overflow-x: visible;
    overflow-y: auto;   /* permet scroll de p√†gina */
  }

  html{
    background:
      radial-gradient(900px 420px at 15% 5%, rgba(216,239,241,0.55), transparent 60%),
      radial-gradient(900px 420px at 85% 12%, rgba(247,223,230,0.55), transparent 60%),
      radial-gradient(900px 520px at 70% 120%, rgba(223,240,214,0.55), transparent 60%),
      radial-gradient(900px 520px at 30% 140%, rgba(216,239,241,0.35), transparent 70%),
      #ffffff;
  }

  body{
    background: transparent; /* perqu√® el fons el pinta html */
  }
  @media (min-width: 1200px) and (max-width: 2000px){
    .weekCols{
      gap: 8px;
    }
  }

  /* --- Daily view: Screens without enough space for 7-column weekly view (<=980px) --- */
  @media (max-width: 980px) {
    .topbar h2 {
      font-size: 24px;
      font-weight: 700;
    }

    .container {
      padding: 10px;
    }

    .board {
      overflow: hidden;
      width: 100%;
    }

    .weekCols {
      display: grid !important;
      grid-template-columns: 1fr !important;
      grid-auto-flow: row !important;
      gap: 10px !important;
      width: 100% !important;
      min-width: 0 !important;
      overflow: visible !important;
    }

    .dayCol {
      width: 100% !important;
      box-sizing: border-box;
      border-radius: 16px;
    }

    .mealName {
      font-size: 18px !important;
      font-weight: 600;
    }

    .mealBody {
      font-size: 16px;
    }

    .twSvg {
      width: 32px !important;
      height: 32px !important;
    }

    #weekLabel {
      font-size: 18px !important;
      font-weight: 600;
    }
  }

  /* Force daily view on all orientations when screen is small */
  @media (max-width: 980px) and (orientation: landscape) {
    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-height: 100vh;
      overflow-y: auto;
    }
  }

  /* --- Recipe picker (modal) --- */
  .pickerTop{
    grid-column: 1 / -1;
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 8px 2px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    flex-wrap: nowrap;
  }
  .pickerSearch{
    flex: 1 1 220px;
    display:flex;
    gap:8px;
    align-items:center;
    background: rgba(255,255,255,0.70);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 8px 10px;
  }
  .pickerSearch input{
    border: 0;
    outline: none;
    background: transparent;
    width: 100%;
    font-size: 14px;
  }
  .pickerCols{
    grid-column: 1 / -1;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    align-items:start;
  }
  @media (max-width: 720px){
    .pickerCols{ grid-template-columns: 1fr; }
    .modalHeaderActions{
      gap:8px;
    }
    #recipeTopStatus{
      display:none; /* si molesta en m√≤bil/tablet */
    }
  }
  .pickerCol{
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    padding: 10px;
    box-shadow: 0 10px 22px rgba(0,0,0,0.04);
    min-height: 0;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .pickerColHeader{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    position: sticky;
    top: 0;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(4px);
    z-index: 1;
  }
  .pickerColTitle{ font-weight: 800; }
  .pickerCurrent{
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }
  .pickerList{
    overflow:auto;
    overflow-y: auto;
    padding-right: 2px;
    display:flex;
    flex-direction:column;
    gap:8px;
    max-height: 100%;
  }
  .rCard{
    width: 100%;
    text-align:left;
    background: rgba(255,255,255,0.75);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 10px 10px;
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:center;
    transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
  }
  .rCard:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.06); }
  .rCard.selected{ border-color: rgba(59,130,246,0.55); box-shadow: 0 12px 22px rgba(59,130,246,0.12); }
  .rIcon{
    width: 28px; height: 28px;
    display:grid; place-items:center;
    border-radius: 10px;
    background: rgba(0,0,0,0.04);
    font-size: 16px;
    flex: 0 0 28px;
  }
  .rName{ font-weight: 650; }
  .rMeta{ font-size: 12px; color: var(--muted); }
  .rHidden{ display:none !important; }

  /* --- Recipe editor modal --- */
  .recipeEditor{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap: 12px;
    align-items: stretch;
    flex: 1 1 auto;
    overflow: hidden;   /* important */
  }
  @media (max-width: 900px){
    .recipeEditor{ grid-template-columns: 1fr; }
  }

  .recipeListPane{
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    background: rgba(255,255,255,0.60);
    padding: 10px;
    display:flex;
    flex-direction: column;
    gap: 10px;
    min-height: 0;
    overflow: hidden;
  }

  .recipeSearch{
    display:flex;
    gap:8px;
    align-items:center;
    background: rgba(255,255,255,0.70);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 8px 10px;
  }
  .recipeSearch input{
    border:0;
    outline:none;
    background:transparent;
    width:100%;
  }

  .recipeList{
    overflow:auto;
    display:flex;
    flex-direction: column;
    gap: 8px;
    padding-right: 2px;
    flex: 1 1 auto;
    overflow-y: auto;
  }

  .recipeRow{
    display:flex;
    flex-direction: column;
    gap:8px;
    align-items:flex-start;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.75);
    border-radius: 14px;
    padding: 10px;
    cursor:pointer;
  }
  
  .recipeRowContent {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
    width: 100%;
  }
  
  .recipeRowIcons {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    width: 100%;
  }
  
  .recipeRowIcons .iconItem {
    font-size: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .recipeRow:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.06); }
  .recipeRow.selected{ border-color: rgba(59,130,246,0.55); box-shadow: 0 12px 22px rgba(59,130,246,0.12); }

  .recipeBadge{
    width: 30px; height: 30px;
    border-radius: 10px;
    background: rgba(0,0,0,0.04);
    display:grid;
    place-items:center;
    font-size: 16px;
    flex: 0 0 30px;
  }

  .recipeDetailPane{
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 16px;
    background: rgba(255,255,255,0.60);
    padding: 12px;
    min-height: 0;
    overflow-y: auto;
  }

  /* El quadre blanc del modal (receptes) una mica m√©s ample */
  #recipeModal{
    overflow: visible;
    width: min(1120px, calc(100vw - 64px));
  }

  /* Si tens un layout en 2 columnes dins del modal, dona m√©s pes a la dreta */
  .recipeLayout{
    grid-template-columns: 320px 1fr; /* esquerra (llista) / dreta (formulari) */
  }
  .recipeForm{
    display:flex;
    flex-direction: column;
    gap: 8px;
    overflow: visible;
  }

  .recipeFormTop{
    display:grid;
    grid-template-columns: 1fr;
    gap: 6px;
    align-items:flex-start;
  }
  @media (max-width: 900px){
    .recipeFormTop{ grid-template-columns: 1fr; }
  }

  .recipeForm textarea{
    width: 100%;
    resize: vertical;
  }

  .mealIcon, .rIcon, .recipeBadge, #newIcon, #rIcon{
    font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }

  /* 1) Evita desbordaments ‚Äúper padding + width‚Äù */
  *, *::before, *::after {
    box-sizing: border-box;
  }

  /* 2) A la columna dreta, mai scrollbar horitzontal */
  .recipeDetailPane {
    overflow-x: hidden;   /* <- aix√≤ fa desapar√®ixer la barra */
  }

  /* 3) En grids/flex, permet que els fills s‚Äôencongeixin (si no, creen overflow) */
  .recipeEditor,
  .recipeListPane,
  .recipeDetailPane,
  .recipeForm,
  .recipeFormTop,
  .recipeFormTop > * {
    min-width: 0;
  }

  /* 4) Inputs/textarea: que no puguin passar de l‚Äôample disponible */
  .recipeDetailPane input,
  .recipeDetailPane select,
  .recipeDetailPane textarea {
    max-width: 100%;
    width: 100%;
  }

  /* 5) El select de la icona no ha de ser width:100% (sin√≥ trenca el grid de 3 columnes) */
  .recipeFormTop #rIcon {
    width: auto;
  }
  .card{ cursor: pointer; }

  /* SVG kawaii: multicolor (no dep√®n de currentColor) */
  .svgIcon{
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: -0.12em;
  }

  /* Twemoji SVG */
  .twSvg{
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: -0.12em;
  }
  .mealIcon .twSvg{ width: 16px; height: 16px; }
  .rIcon .twSvg,
  .recipeBadge .twSvg{ width: 18px; height: 18px; }
  .cIcon .twSvg{ width: 14px; height: 14px; }


  /* Mides per context */
  .mealIcon .svgIcon{ width: 16px; height: 16px; }
  .rIcon .svgIcon,
  .recipeBadge .svgIcon{ width: 18px; height: 18px; }
  .cIcon .svgIcon{ width: 14px; height: 14px; }

  /* Opcional: fa que les icones ‚Äúsaltin‚Äù una mica (sense recarregar) */
  .i{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,0.10));
  }


  /* Color per √†pat (icones de la columna) + badge suau al fons */
  .mealIcon{
    opacity: 1;
    width: 16px;
    height: 16px;
    border-radius: 7px;
    margin-top: 2px;
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(0,0,0,0.06);
  }
  .mealIcon.meal-breakfast{ background: rgba(255,255,255,0.55); }
  .mealIcon.meal-lunch    { background: rgba(245,158,11,0.12); }
  .mealIcon.meal-snack    { background: rgba(34,197,94,0.12); }
  .mealIcon.meal-dinner   { background: rgba(59,130,246,0.12); }




  #rvTitle{
    display:flex;
    align-items:center;
    gap: 8px;
  }

  .card.primer .svgIcon{ opacity: 0.95; }
  .card.segon  .svgIcon{ opacity: 0.92; }
  .card.unic   .svgIcon{ opacity: 0.92; }

  /* Twemoji inline SVG */
  .twSvg{
    width: 18px;
    height: 18px;
    display: inline-block;
    vertical-align: -3px;
  }

  /* a les targetes (board) */
  .card .cIcon .twSvg{
    width: 16px;
    height: 16px;
    vertical-align: -3px;
  }

  /* a les icones del lateral dels √†pats */
  .mealIcon .twSvg{
    width: 18px;
    height: 18px;
    vertical-align: -3px;
  }

  /* a les targetes del picker (modal) */
  .rIcon .twSvg,
  .recipeBadge .twSvg{
    width: 18px;
    height: 18px;
    vertical-align: -3px;
  }

  .iconPreview{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:28px;
    height:28px;
    margin-left:8px;
    vertical-align:middle;
    border-radius:12px;
  }
  .iconPreview .twSvg{
    width:20px;
    height:20px;
  }

  /* Cap√ßalera del formulari d'edici√≥ */
  .recipeHeaderRow{
    display: grid;
    grid-template-columns: 110px 28px minmax(220px, 1fr) 140px;
    align-items: center;
    gap: 10px;
  }

  #rIcon, #rCategory, #rName{
    width: 100%;
    min-width: 0;
  }

  #rName{
    display: block;
    min-height: 34px;
  }


  /* Evita que el preview mengi espai i provoqui salt */
  .recipeHeaderRow .iconPreview{
    flex: 0 0 auto;
    margin-left: 6px;
  }

  /* Controls m√©s compactes perqu√® hi c√†piguen */
  .recipeHeaderRow select,
  .recipeHeaderRow input{
    min-width: 0;
    padding: 8px 10px;
  }

  .recipeHeaderGrid{
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    align-items: stretch;
  }

  .rhName {
    grid-column: 1;
    grid-row: 1;
  }

  .rhName input {
    width: 100%;
  }

  .rhCat {
    grid-column: 2;
    grid-row: 1;
  }

  .rhCat select {
    width: 100%;
  }

  .rhIcon {
    grid-column: 1 / 3;
    grid-row: 2;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #rIconPicker {
    grid-column: 3;
    grid-row: 1 / 3;
  }

  /* Fix icon picker to fit in grid cell - 2 ROWS x 6 COLUMNS */
  .rhIcon .iconPickerGrid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
    padding: 4px;
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    margin: 0;
    width: 100%;
  }

  .rhIcon .iconPickerBtn {
    width: 100%;
    aspect-ratio: 1;
    padding: 0;
    border: 2px solid rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 120ms ease;
  }

  .rhIcon .iconPickerBtn:hover {
    border-color: rgba(59,130,246,0.35);
    background: rgba(59,130,246,0.05);
    transform: scale(1.05);
  }

  .rhIcon .iconPickerBtn.selected {
    border-color: rgba(59,130,246,0.8);
    background: rgba(59,130,246,0.15);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }

  /* Icon preview - shows selected icons with larger size */
  .iconPreview {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    width: auto;
    min-height: 48px;
    border-radius: 12px;
    background: rgba(255,255,255,0.85);
    border: 2px solid rgba(0,0,0,0.08);
    flex: 0 0 auto;
    flex-wrap: wrap;
    padding: 6px;
  }

  .iconPreview .twSvg {
    width: 36px;
    height: 36px;
  }

  .rhIcon:has(.iconPreview:empty) {
    display: none;
  }

  /* Visual Icon Picker - for adding recipes */
  .iconPickerGrid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    padding: 8px;
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    margin-bottom: 8px;
    max-width: 350px;
  }

  .panel:not(.daily-mode) #newIconPicker {
    max-width: 300px;
  }
  
  .rhIcon .iconPreview {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: rgba(255,255,255,0.85);
    border: 2px solid rgba(0,0,0,0.08);
  }

  .rhIcon .iconPreview .twSvg {
    width: 28px;
    height: 28px;
  }
  .iconPickerBtn {
    width: 100%;
    aspect-ratio: 1;
    padding: 0;
    border: 2px solid rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 120ms ease;
    min-height: 40px;
  }

  .panel.daily-mode .iconPickerBtn {
    font-size: 18px;
    min-height: 36px;
  }

  .iconPickerBtn:hover {
    border-color: rgba(59,130,246,0.35);
    background: rgba(59,130,246,0.05);
    transform: scale(1.05);
  }

  .iconPickerBtn.selected {
    border-color: rgba(59,130,246,0.8);
    background: rgba(59,130,246,0.15);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }

  /* Recipe filter bar - single row of icons in header */
  .recipeFilterBar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    background: transparent;
    border: none;
    border-radius: 12px;
    margin-bottom: 6px;
  }

  .recipeFilterLabel {
    font-size: 14px;
    color: var(--muted);
    font-weight: 500;
    white-space: nowrap;
  }

  .recipeFilterIcons {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }

  .recipeFilterBtn {
    width: 44px;
    height: 44px;
    padding: 0;
    border: 2px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 140ms ease;
    flex-shrink: 0;
  }

  .recipeFilterBtn:hover {
    border-color: rgba(59,130,246,0.35);
    background: rgba(59,130,246,0.05);
    transform: scale(1.08);
  }

  .recipeFilterBtn.active {
    border-color: rgba(59,130,246,0.8);
    background: rgba(59,130,246,0.2);
    box-shadow: 0 4px 12px rgba(59,130,246,0.2);
    transform: scale(1.1);
  }

  .recipeFilterBtn.active:hover {
    background: rgba(59,130,246,0.25);
  }

  .recipeFilterClear {
    margin-left: 4px;
    font-size: 12px;
    color: var(--muted);
    opacity: 0.7;
    transition: opacity 140ms ease;
  }

  .recipeFilterClear:hover {
    opacity: 1;
    color: var(--text);
  }

  /* User menu dropdown */
  .userMenuBtn {
    background: transparent;
    border: 1px solid var(--line);
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 120ms ease;
    position: relative;
  }

  .userMenuBtn:hover {
    background: rgba(0,0,0,0.04);
    border-color: rgba(0,0,0,0.15);
  }

  .userMenuDropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    min-width: 200px;
    margin-top: 8px;
    z-index: 9999;
    backdrop-filter: blur(4px);
    overflow: hidden;
    display: none;
  }

  .userMenuDropdown.open {
    display: block;
  }

  .userMenuDropdown > button,
  .userMenuDropdown > div {
    display: block;
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: transparent;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    color: var(--text);
    transition: background 120ms ease;
    border-radius: 0;
    box-shadow: none;
  }

  .userMenuDropdown > button:hover {
    background: rgba(0,0,0,0.05);
    transform: none;
  }

  .userMenuDropdown > button:active {
    background: rgba(0,0,0,0.08);
    transform: none;
  }

  .userMenuDropdown > button.danger {
    color: #dc2626;
  }

  .userMenuDropdown > button.danger:hover {
    background: rgba(220,38,38,0.1);
  }

  .userMenuDropdown > hr {
    margin: 4px 0;
    border: none;
    height: 1px;
    background: rgba(0,0,0,0.08);
  }

  .userMenuDropdown > button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .iconPickerHelper {
    font-size: 12px;
    color: rgba(0,0,0,0.55);
    margin-bottom: 6px;
  }

  .rhIcon .iconPreview {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2px;
    width: auto;
    min-width: 160px;
    height: 50px;
    border-radius: 12px;
    background: rgba(255,255,255,0.85);
    border: 2px solid rgba(0,0,0,0.08);
    flex: 0 0 auto;
    flex-wrap: wrap;
    padding: 0 16px;
  }

  .rhIcon .iconPreview .twSvg {
    width: 24px;
    height: 24px;
  }

  /* Icon preview for recipe form - larger icons to match selector */
  #newIconPreview.iconPreview {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 4px;
    width: 80px;
    height: 32px;
    line-height: 1;
    border-radius: 12px;
    background: rgba(255,255,255,0.85);
    border: 2px solid rgba(0,0,0,0.08);
    padding: 4px 6px;
    flex-wrap: nowrap;
    flex-shrink: 0;
    overflow: hidden;
    box-sizing: border-box;
  }

  #newIconPreview.iconPreview .twSvg {
    width: 20px;
    height: 20px;
    min-width: 20px;
    min-height: 20px;
    flex-shrink: 0;
  }

  .panel:not(.daily-mode) #newIconPicker {
    max-width: 300px;
  }

  /* Layout para Men√∫ Setmanal - una sola l√≠nea */
  .panel .row {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .panel .recipeForm1,
  .panel .recipeForm2,
  .panel .form-row-1,
  .panel .form-row-2 {
    display: contents;
  }

  /* Layout para Men√∫ Diari - dos columnas */
  .panel.daily-mode .row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: start;
  }

  .panel.daily-mode .recipeForm1 {
    grid-column: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }

  .panel.daily-mode .form-row-1 {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .panel.daily-mode .form-row-1 input[type="text"] {
    flex: 1;
    min-width: 100px;
  }

  .panel.daily-mode .form-row-1 select {
    flex: 0 1 120px;
    min-width: 100px;
  }

  .panel.daily-mode .form-row-2 {
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }
  .panel.daily-mode .form-row-2 .iconPickerGrid {
    /* Show as 2 rows x 6 columns */
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
    padding: 4px;
    max-width: 100%;
    width: auto;
    height: auto;
    margin: 0;
    flex: 1;
    /* limit visible area to two rows and allow scrolling if more icons exist */
    max-height: 92px;
    overflow-y: auto;
  }

  .panel.daily-mode .form-row-2 .iconPickerGrid button {
    /* Use compact but consistent square buttons */
    min-width: 36px;
    min-height: 36px;
    padding: 4px;
    font-size: 16px;
    box-sizing: border-box;
  }

  /* Force fixed compact button boxes in daily mode to avoid stretching */
  .panel.daily-mode .form-row-2 .iconPickerGrid .iconPickerBtn {
    width: 36px !important;
    height: 36px !important;
    min-width: 36px !important;
    min-height: 36px !important;
    aspect-ratio: initial !important;
    padding: 4px !important;
    display: inline-flex !important;
    justify-content: center !important;
    align-items: center !important;
  }

  /* Reduce svg icon size inside the daily-mode picker to keep icons small */
  .panel.daily-mode .form-row-2 .iconPickerGrid .twSvg,
  .panel.daily-mode .form-row-2 .iconPickerGrid button .twSvg,
  .panel.daily-mode .form-row-2 .iconPickerGrid .iconPickerBtn .twSvg {
    width: 20px !important;
    height: 20px !important;
  }

  /* Extra specific rule targeting actual svg elements inside picker buttons */
  .panel.daily-mode .form-row-2 .iconPickerGrid button svg,
  .panel.daily-mode .form-row-2 .iconPickerGrid .iconPickerBtn svg {
    width: 20px !important;
    height: 20px !important;
    max-width: 20px !important;
    max-height: 20px !important;
  }

  .panel.daily-mode .form-row-2 #newIconPreview {
    width: 80px;
    height: 32px;
    flex-shrink: 0;
    margin-top: 0;
  }

  .panel.daily-mode .recipeForm2 {
    grid-column: 2;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }

  .panel.daily-mode .recipeForm2 button {
    padding: 10px 12px;
    min-height: 44px;
    font-size: 14px;
    flex: 1 0 auto;
  }

  .panel.daily-mode #newIconPreview .twSvg {
    width: 20px;
    height: 20px;
    min-width: 20px;
    min-height: 20px;
  }


  .panel.daily-mode #newIconPreview .twSvg {
    width: 20px;
    height: 20px;
    min-width: 20px;
    min-height: 20px;
  }
  </style>

</head>
<body>
  <div class="container">

    <div class="topbar">
      <div class="titleRow">
        <h2>Men√∫ setmanal</h2>
        <!-- <div class="muted subtitleInline">Planificaci√≥ familiar</div> -->
      </div>
      <!-- AUTH BAR (m√≠nim) --      /* Visual Icon Picker */ -->
  
      <div class="authBar">
        <!-- User menu (cuando autenticado) -->
        <div style="position: relative; display: none;" id="userMenuContainer">
          <button id="userMenuBtn" class="userMenuBtn">
            <span id="userMenuLabel">‚Äî</span>
            <span>‚ñæ</span>
          </button>
          <div id="userMenuDropdown" class="userMenuDropdown">
            <button id="userMenuPreferences">Prefer√®ncies</button>
            <button id="userMenuAdmin" style="display: none;">Administraci√≥</button>
            <hr>
            <button id="userMenuLogout" class="danger">Logout</button>
          </div>
        </div>
      
        <!-- Login form (cuando no autenticado) -->
        <div id="loginForm" style="display: flex; gap: 8px; align-items: center;">
          <input id="familyCodeInput" placeholder="Codi fam√≠lia" style="width:60%;" />
          <button id="loginBtn">Login</button>
        </div>
      </div>

      <div class="weekControls">
        <button id="prevWeekBtn" class="gcNavBtn" title="Setmana anterior">‚Äπ</button>
        <div id="weekLabel" class="weekPill"></div>
        <button id="nextWeekBtn" class="gcNavBtn" title="Setmana seg√ºent">‚Ä∫</button>
      </div>


    </div>


    <div id="grid"></div>

    <hr/>

    <h3>Afegir recepta</h3>

    <div class="panel" id="addRecipePanel">
      <div class="row">
        <div class="recipeForm1">
          <div class="form-row-1">
            <input id="newName" class="inputWide" placeholder="Nom del plat">
            <select id="newCat">
              <option value="Primer">Primer</option>
              <option value="Segon">Segon</option>
              <option value="Plat √∫nic">Plat √∫nic</option>
              <option value="Esmorzar">Esmorzar</option>
              <option value="Berenar">Berenar</option>
            </select>
          </div>
          <div class="form-row-2">
            <div id="newIconPicker" class="iconPickerGrid"></div>
            <span id="newIconPreview" class="iconPreview"></span>
            <input type="hidden" id="newIconValue">
          </div>
        </div>
        <div class="recipeForm2">
          <button id="addBtn" class="btnPrimary">Afegir</button>
          <button id="manageRecipesBtn" class="btnGhost">Gestionar receptes</button>
        </div>
      </div>
    </div>
  <div id="overlay" class="overlay">
    <div id="modal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modalHeader">
        <div>
          <div id="modalTitle" class="modalTitle">Editar</div>
          <div id="modalSub" class="muted"></div>
        </div>
        <button id="closeBtn">Tancar</button>
      </div>
      <div id="modalBody" class="modalBody"></div>
    </div>
  </div>
  <div id="loadingOverlay" class="loading hidden">
    <div class="loadingBox">
      <div class="spinner"></div>
      <div class="loadingText">Cargando‚Ä¶</div>
    </div>
  </div>
  <script>

    let RECIPES = [];
    let PLAN = [];
    let WEEK_START_ISO = null; // dilluns (YYYY-MM-DD)
    let NOTES = []; // {date, meal, note}
    let RV_RECIPE_ID = null;
    let RECIPE_FILTER_ICON = null; // Filter by icon key: null = show all

    // --- Twemoji SVG (CDN) ---
    const TWEMOJI_VERSION = "14.0.2";
    const TWEMOJI_BASE = "https://cdn.jsdelivr.net/gh/twitter/twemoji@" + TWEMOJI_VERSION + "/assets/svg/";


    const TWEMOJI_MAP = {
      meat:      "1f356",  // üçñ Carn
      fish:      "1f41f",  // üêü Peix
      egg:       "1f95a",  // ü•ö Ous
      beans:     "1fad8",  // ü´ò Llegums (Fava Beans)
      vegetable: "1f966",  // ü•¶ Verdura
      fruit:     "1f34e",  // üçé Fruita
      pasta:     "1f35d",  // üçù Pasta
      rice:      "1f35a",  // üçö Arr√≤s
      potato:    "1f954",  // ü•î Patates
      dairy:     "1f9c0",  // üßÄ L√†ctics
      nuts:      "1f95c",  // ü•ú Fruits secs
      cereals:   "1f33e"   // üåæ Cereals
    };

    const ICON_LABELS = {
      meat:      "Carn",
      fish:      "Peix",
      egg:       "Ous",
      beans:     "Llegums",
      vegetable: "Verdura",
      fruit:     "Fruita",
      pasta:     "Pasta",
      rice:      "Arr√≤s",
      potato:    "Patates",
      dairy:     "L√†ctics",
      nuts:      "Fruits secs",
      cereals:   "Cereals"
    };

    // L‚Äôordre com vols que surtin al desplegable
    const ICON_KEYS = [
      "meat", "fish", "egg", "beans", "vegetable", "fruit",
      "pasta", "rice", "potato", "dairy", "nuts", "cereals"
    ];


    const TW_SVG_CACHE = {}; // code -> <svg...>...</svg>

    function twCodeForKey(key){
      const k = String(key || "").trim();
      return TWEMOJI_MAP[k] || TWEMOJI_MAP.fruit;
    }

    // Sanititza amb DOMParser    
    function sanitizeTwSvg(svgText){
      const parser = new DOMParser();
      const doc = parser.parseFromString(String(svgText || ""), "image/svg+xml");

      const svg = doc.documentElement;
      if (!svg || svg.nodeName.toLowerCase() !== "svg") return "";

      // elimina width/height per controlar via CSS
      svg.removeAttribute("width");
      svg.removeAttribute("height");

      // afegeix class twSvg
      const cls = (svg.getAttribute("class") || "").trim();
      svg.setAttribute("class", (cls ? cls + " " : "") + "twSvg");

      return new XMLSerializer().serializeToString(svg);
    }

    async function preloadTwemojiSvgs(){
      const uniqueCodes = Array.from(new Set(Object.values(TWEMOJI_MAP)));

      for (const code of uniqueCodes){
        if (TW_SVG_CACHE[code]) continue;

        const url = TWEMOJI_BASE + code + ".svg";
        try{
          const res = await fetch(url, { cache: "force-cache" });
          if (!res.ok) {
            console.warn("Twemoji fetch failed:", code, res.status);
            continue;
          }
          const raw = await res.text();
          const clean = sanitizeTwSvg(raw);
          if (clean) TW_SVG_CACHE[code] = clean;
        } catch(err){
          console.warn("Twemoji fetch error:", code, err);
        }
      }
    }

    const EMOJI_FALLBACK = {
      soup:"üç≤", salad:"ü•ó", pasta:"üçù", rice:"üçö", pizza:"üçï",
      egg:"üç≥", fish:"üêü", chicken:"üçó", sandwich:"ü•™",
      stew:"üç≤", burger:"üçî", taco:"üåÆ", sushi:"üç£",
      dessert:"üç∞", fruit:"üçé", plate:"üçΩÔ∏è",
      eggplant:"üçÜ", broccoli:"ü•¶", potato:"ü•î",
      cream:"üçµ" // si l‚Äôhas creat com a key
    };

    function twemojiSvgIcon(key){
      const k = String(key || "").trim() || "plate";
      const code = twCodeForKey(k);
      const svg = TW_SVG_CACHE[code];
      return svg || (EMOJI_FALLBACK[k] || EMOJI_FALLBACK.plate);
    }


    function findNote(date, mealKey){
      return NOTES.find(n => n.date === date && n.meal === mealKey)?.note || "";
    }

    async function gasp(fn, ...args) {
      // Map old Google Apps Script function names to new endpoints
      const apiMap = {
        api_getRecipes: { method: "GET", path: "/api/recipes" },
        api_getWeekData: { method: "GET", path: "/api/menu" },
        api_upsertRecipe: { method: "POST", path: "/api/recipes" },
        api_setNote: { method: "POST", path: "/api/menu" },
        api_applySlotChanges: { method: "POST", path: "/api/menu" },
        api_updateRecipeDetails: { method: "POST", path: "/api/recipes" },
      };

      const config = apiMap[fn];
      if (!config) throw new Error(`Unknown API: ${fn}`);

      let url = config.path;
      let options = {};

      if (config.method === "GET") {
        if (args[0]) {
          const params = new URLSearchParams(args[0]);
          url += "?" + params.toString();
        }
        options.method = "GET";
      } else {
        const data = args[0] || {};
        if (fn === "api_setNote") {
          data.action = "setNote";
        } else if (fn === "api_applySlotChanges") {
          data.action = "applyChanges";
        }
        options.method = "POST";
        options.headers = { "Content-Type": "application/json" };
        options.body = JSON.stringify(data);
      }

      const response = await apiFetch(url, options);

      if (!response.ok) {
        let errorMsg = `API error: ${response.status}`;
        try {
          const errorData = await response.json();
          errorMsg = errorData.error || errorMsg;
        } catch (e) {
          // Si no es JSON, usar el texto
          try {
            const text = await response.text();
            if (text) errorMsg = text;
          } catch (e2) {}
        }
        console.error(`${fn} failed:`, errorMsg);
        throw new Error(errorMsg);
      }

      let result;
      try {
        result = await response.json();
      } catch (e) {
        console.error(`${fn} response not valid JSON:`, e);
        throw new Error(`Response not JSON: ${e.message}`);
      }

      return result;
    }

    let DIRTY_SLOTS = {};      // { slot_id: {date, meal, recipe_id} | {slot_id, __delete:true} }
    let IS_IN_MODAL = false;

    function showLoading(opts = {}) {
      if (opts && opts.silent) return;   // <- per no molestar dins el modal
      const el = document.getElementById("loadingOverlay");
      if (el) el.classList.remove("hidden");
    }
    function hideLoading() {
      const el = document.getElementById("loadingOverlay");
      if (el) el.classList.add("hidden");
    }

    function toast(kind, title, body, ms){
      if (ms === undefined) ms = 2600;
      body = body || "";

      const wrap = document.getElementById("toastWrap");
      if (!wrap) return;

      const el = document.createElement("div");
      el.className = "toast" + (kind ? (" " + kind) : "");

      var html = '<div class="toastTitle">' + (title || "") + '</div>';
      if (body) html += '<div class="toastBody">' + body + '</div>';
      el.innerHTML = html;

      wrap.appendChild(el);

      setTimeout(function(){
        el.style.opacity = "0";
        el.style.transform = "translateY(6px)";
        el.style.transition = "all 180ms ease";
        setTimeout(function(){ el.remove(); }, 220);
      }, ms);
    }



    function mealBodyId(date, mealKey){
      return `mealBody_${date}_${mealKey}`;
    }



    function markMealDirty(date, mealKey, isDirty){
      const el = document.getElementById(mealBodyId(date, mealKey));
      if (!el) return;

      if (isDirty) el.classList.add("dirty");
      else el.classList.remove("dirty");

      // Badge
      const badge = el.querySelector(".dirtyBadge");
      if (isDirty){
        if (!badge){
          const row = document.createElement("div");
          row.className = "badgeRow";
          row.innerHTML = `<span class="dirtyBadge">Pendent de guardar</span>`;
          el.appendChild(row);
        }
      } else {
        el.querySelector(".badgeRow")?.remove();
        el.classList.remove("saveError");
      }
    }

    function markMealError(date, mealKey){
      const el = document.getElementById(mealBodyId(date, mealKey));
      if (!el) return;
      el.classList.add("saveError");
    }

    const MEALS = [
      { key: "breakfast", label: "Esmorzar", courses: ["plat"] },
      { key: "lunch",     label: "Dinar",    courses: ["primer", "segon", "unic"] },
      { key: "snack",     label: "Berenar",  courses: ["plat"] },
      { key: "dinner",    label: "Sopar",    courses: ["primer", "segon", "unic"] }
    ];

    function iso(d){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function addDays(dateStr, n){
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate() + n);
      return iso(d);
    }



    function parseISO(dateStr){
      return new Date(dateStr + "T00:00:00");
    }

    function startOfWeekMonday(d){
      // d = Date
      const day = d.getDay(); // 0 dg .. 6 ds
      const diff = (day === 0) ? 6 : (day - 1); // dilluns com a inici
      const out = new Date(d);
      out.setDate(d.getDate() - diff);
      return out;
    }

    function addDaysDate(d, n){
      const out = new Date(d);
      out.setDate(out.getDate() + n);
      return out;
    }

    function getISOWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function formatWeekLabel(mondayDate){
      const sunday = addDaysDate(mondayDate, 6);
      
      const formatShortCa = (d) => {
        const months = ["gen", "feb", "mar", "abr", "mai", "jun", "jul", "ago", "set", "oct", "nov", "des"];
        const day = d.getDate();
        const month = months[d.getMonth()];
        return `${day} ${month}`;
      };
      
      return `${formatShortCa(mondayDate)} ‚Üí ${formatShortCa(sunday)}`;
    }

    function formatWeekNumber(mondayDate) {
      const weekNum = getISOWeekNumber(mondayDate);
      return `Setmana ${weekNum}`;
    }


    function rankRecipes(recipes){
      return [...recipes].sort((a,b)=>{
        const c = (Number(b.count||0) - Number(a.count||0));
        if (c !== 0) return c;
        return String(b.last_used||"").localeCompare(String(a.last_used||""));
      });
    }

    function norm_(s){
      return String(s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu,"");
    }

    function svgIcon(key){
       throw new Error("svgIcon() no s'ha d'utilitzar. Usa twemojiSvgIcon().");
    }




    // Reutilitzem r.icon com a "key"
    function recipeIconKey(r){
      const manual = String(r?.icon || "").trim(); // ara: "soup", "salad", ...
      return manual || autoIconKeyForRecipe(r);
    }




    function autoIconKeyForRecipe(r){
      const name = norm_(r?.name || "");
      const cat  = norm_(r?.category || "");

      if (cat.includes("esmorzar")) return "coffee";
      if (cat.includes("berenar"))  return "fruit";

      const map = [
        [/crema|cremes/, "cream"],        // üçµ PRIORITAT
        [/pasta|macarr|espaguet|lasany|fideu/, "pasta"],
        [/verdur/,"broccoli"],
        [/patat/,"potato"],
        [/alberg|carbas/,"eggplant"],
        [/arros|paella|risotto/, "rice"],
        [/pizza/, "pizza"],
        [/truita|tortilla|ou|huevo/, "egg"],
        [/sopa|crema|caldo|brou/, "soup"],
        [/amanid|ensalada/, "salad"],
        [/peix|pescad|salmo|tonyina|bacalla|sard/, "fish"],
        [/pollastre|pollo|gall/, "chicken"],
        [/hamburg|burger/, "burger"],
        [/taco|fajita|burrito|mex/, "taco"],
        [/sushi|maki|nigiri/, "sushi"],
        [/pa amb|sandwich|bikini|entrep[a√†]/, "sandwich"],
        [/estofat|guisat|rag[u√π]/, "stew"],
        [/postre|pastis|tarta|iogurt|gelat/, "dessert"],
        [/fruita|poma|platan|raim/, "fruit"],
      ];
      for (const [re, key] of map){
        if (re.test(name)) return key;
      }

      if (cat.includes("primer")) return "salad";
      return "plate";
    }




    function findRecipe(id){ return RECIPES.find(r => String(r.id) === String(id)); }
    function findSlot(slot_id){ return PLAN.find(p => String(p.slot_id) === String(slot_id)); }

    async function loadRecipesOnce(){
      if (RECIPES.length) return;
      const r1 = await gasp("api_getRecipes");
      RECIPES = (r1?.recipes || []).map(r => ({...r, count:Number(r.count||0)}));
    }

    async function loadWeekData(){
      const weekStart = WEEK_START_ISO;
      const weekEnd = addDays(weekStart, 6);
      const r = await gasp("api_getWeekData", { weekStart, weekEnd });
      PLAN = r?.plan || [];
      NOTES = r?.notes || [];
    }




    function dayLabel(dateStr){
      const d = new Date(dateStr + "T00:00:00");
      // Normalizamos: lunes = 0, domingo = 6
      const idx = (d.getDay() + 6) % 7;
      const names = ["dl.","dt.","dc.","dj.","dv.","ds.","dg."];
      return names[idx];
    }


    function buildDates(weekMondayISO){
      const start = parseISO(weekMondayISO);
      const dates = [];
      for (let i=0;i<7;i++) dates.push(iso(addDaysDate(start, i)));
      return dates;
    }


    const VIEW_MODE = "edit";

    // Daily View variables
    let CURRENT_DISPLAY_DATE = null;  // ISO date for daily view
    let PRELOADED_DATES = new Set();  // For smooth swipe navigation

    function isDailyViewMode() {
      // Force daily view if:
      // 1. Screen width is very small (mobile portrait)
      // 2. Screen doesn't have enough space for 7-column weekly view
      //    (7 columns √ó 130px min + gaps ~80px = ~980px minimum)
      const windowWidth = window.innerWidth;
      return windowWidth <= 980;
    }

    function updateTitleForMode() {
      const h2 = document.querySelector(".titleRow h2");
      if (!h2) return;
      
      const prevBtn = document.getElementById("prevWeekBtn");
      const nextBtn = document.getElementById("nextWeekBtn");
      
      if (isDailyViewMode() && CURRENT_DISPLAY_DATE) {
        h2.textContent = "Men√∫ diari";
        if (prevBtn) prevBtn.style.display = "none";
        if (nextBtn) nextBtn.style.display = "none";
      } else {
        h2.textContent = "Men√∫ setmanal";
        if (prevBtn) prevBtn.style.display = "";
        if (nextBtn) nextBtn.style.display = "";
      }
    }

    function updateRecipePanelForMode() {
      const panel = document.getElementById("addRecipePanel");
      if (!panel) return;
      
      if (isDailyViewMode()) {
        panel.classList.add("daily-mode");
      } else {
        panel.classList.remove("daily-mode");
      }
    }

    function updateDateLabelForMode() {
      const weekLabel = document.getElementById("weekLabel");
      if (!weekLabel) return;
      
      if (isDailyViewMode() && CURRENT_DISPLAY_DATE) {
        // In daily view: hide the week label
        weekLabel.style.display = "none";
      } else {
        weekLabel.style.display = "";
      }
    }

    function updateUIForMode() {
      updateTitleForMode();
      updateDateLabelForMode();
      updateRecipePanelForMode();
    }

    function navigateToDate(dateISO) {
      CURRENT_DISPLAY_DATE = dateISO;
      updateUIForMode();
      renderBoardForDisplay();
    }

    function nextDay() {
      if (!CURRENT_DISPLAY_DATE) return;
      const next = addDaysDate(parseISO(CURRENT_DISPLAY_DATE), 1);
      navigateToDate(iso(next));
    }

    function prevDay() {
      if (!CURRENT_DISPLAY_DATE) return;
      const prev = addDaysDate(parseISO(CURRENT_DISPLAY_DATE), -1);
      navigateToDate(iso(prev));
    }

    function renderBoardForDisplay() {
      if (isDailyViewMode() && CURRENT_DISPLAY_DATE) {
        renderBoardDaily(CURRENT_DISPLAY_DATE);
      } else {
        renderBoard(WEEK_START_ISO);
      }
    }

    function slotId(date, mealKey, course){
      return `${date}_${mealKey}_${course}`;
    }

    function slotHasValue(slot_id){
      const s = findSlot(slot_id);
      return !!(s && String(s.recipe_id || "").trim());
    }


    function courseClass(course){
      if (course === "primer") return "primer";
      if (course === "segon") return "segon";
      if (course === "unic") return "unic";
      return "plat";
    }

    function coursesForMeal(mealKey){
      if (mealKey === "lunch" || mealKey === "dinner") return ["primer","segon","unic"];
      if (mealKey === "breakfast") return ["plat"];
      if (mealKey === "snack") return ["plat"];
      return ["plat"];
    }

    function allowedForCourse(recipe, course){
      const cat = String(recipe.category || "");
      if (course === "primer") return cat === "Primer";
      if (course === "segon")  return cat === "Segon";
      if (course === "unic")   return cat === "Plat √∫nic";
      return true;
    }

    function renderBoard(weekMondayISO){
      const dates = buildDates(weekMondayISO);

      const DAY_COLORS = [
        "#f2e8e6", // dl
        "#f7dfe6", // dt
        "#d8eff1", // dc
        "#dff0d6", // dj
        "#f6efc8", // dv
        "#e9e5f7", // ds (extra)
        "#e7f5ff"  // dg (extra)
      ];

      const dayTitle = (dateStr) => {
        const d = new Date(dateStr + "T00:00:00");
        const names = ["Diumenge","Dilluns","Dimarts","Dimecres","Dijous","Divendres","Dissabte"];
        return names[d.getDay()];
      };

      const mealIconKey = (mealKey) => {
        if (mealKey === "breakfast") return "coffee";
        if (mealKey === "lunch") return "soup";
        if (mealKey === "snack") return "fruit"; 
        if (mealKey === "dinner") return "plate";
        return "plate";
      };


      const colHtml = dates.map((date, i) => {
        const dayBg = DAY_COLORS[i % DAY_COLORS.length];

        const mealsHtml = MEALS.map(m => {
          const courses = coursesForMeal(m.key);

          // Nota (si n‚Äôhi ha)
          const note = findNote(date, m.key);
          const noteHtml = note
            ? `<div class="noteLine" title="${note.replaceAll('"','&quot;')}">üìù ${note}</div>`
            : "";

          // Cards del dia/√†pat
          const cards = courses.map(course => {
            const sid = slotId(date, m.key, course);
            const slot = findSlot(sid);
            if (!slot || !slot.recipe_id) return "";

            const r = findRecipe(slot.recipe_id);
            // Soportar m√∫ltiples iconos
            let icons = "";
            if (r) {
              let iconKeys = [];
              if (r.icons) {
                try {
                  iconKeys = JSON.parse(r.icons);
                } catch (e) {}
              } else if (r.icon) {
                iconKeys = [r.icon];
              }
              
              icons = iconKeys.map(key => `<span class="iconItem">${twemojiSvgIcon(key)}</span>`).join("");
            }

            const name = r ? String(r.name || "").trim() : getRecipeName(slot.recipe_id);

            const cls = courseClass(course);
            const recipe = findRecipe(slot.recipe_id);

            return `
              <div class="card ${cls}"
                  onclick="openRecipeViewer('${slot.recipe_id}', event)">
                <span class="cName">${name}</span>
                <span class="cIcon">${icons}</span>
              </div>
            `;

          }).filter(Boolean).join("");


          const clickable = `onclick="openCellEditor('${date}','${m.key}')"`

          const bodyId = mealBodyId(date, m.key);

          // si algun slot d‚Äôaquest meal √©s dirty
          const isMealDirty = Object.keys(DIRTY_SLOTS)
            .some(k => k.startsWith(`${date}_${m.key}_`));

          return `
            <div class="mealRow">
              <div class="mealLabel">${MEALS.find(x=>x.key===m.key)?.label || m.key}</div>

              <div id="${bodyId}"
                class="mealBody meal-${m.key} ${isMealDirty ? "dirty" : ""} ${(noteHtml || cards) ? "hasContent" : ""}"
                data-meal="${m.key}"
                role="button"
                tabindex="0"
                title="Editar ${MEALS.find(x=>x.key===m.key)?.label || m.key}"
                onclick="openCellEditor('${date}','${m.key}')"
                onkeydown="if(event.key==='Enter' || event.key===' ') openCellEditor('${date}','${m.key}')">

                <div class="mealCards">
                  ${noteHtml}
                  ${cards || ""}
                </div>

                ${isMealDirty
                  ? `<div class="badgeRow">
                      <span class="dirtyBadge">Pendent de guardar</span>
                    </div>`
                  : ""}
              </div>
            </div>
          `;



        }).join("");

        const formatShortCa = (d) => {
          const months = ["gen", "feb", "mar", "abr", "mai", "jun", "jul", "ago", "set", "oct", "nov", "des"];
          const day = d.getDate();
          const month = months[d.getMonth()];
          return `${day} ${month}`;
        };
        const dateObj = parseISO(date);
        const shortDate = formatShortCa(dateObj);

        return `
          <div class="dayCol" data-date="${date}" style="background:${dayBg}">
            <div class="dayHead">
              <div class="dayName">${dayTitle(date)}</div>
              <div class="dayDate">${shortDate}</div>
            </div>
            <div class="dayMeals">
              ${mealsHtml}
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("grid").innerHTML = `
        <div class="board">
          <div class="weekCols">
            ${colHtml}
          </div>
        </div>
      `;
    }

    function renderBoardDaily(dateISO) {
      // Render only one day in full width for daily view
      const DAY_COLORS = [
        "#f2e8e6", "#f7dfe6", "#d8eff1", "#dff0d6", "#f6efc8", "#e9e5f7", "#e7f5ff"
      ];

      const dayTitle = (dateStr) => {
        const d = new Date(dateStr + "T00:00:00");
        const names = ["Diumenge","Dilluns","Dimarts","Dimecres","Dijous","Divendres","Dissabte"];
        return names[d.getDay()];
      };

      const formatShortCa = (d) => {
        const months = ["gen", "feb", "mar", "abr", "mai", "jun", "jul", "ago", "set", "oct", "nov", "des"];
        const day = d.getDate();
        const month = months[d.getMonth()];
        return `${day} ${month}`;
      };

      const dateObj = parseISO(dateISO);
      const dayIdx = (dateObj.getDay() + 6) % 7;
      const dayBg = DAY_COLORS[dayIdx];

      const mealsHtml = MEALS.map(m => {
        const courses = coursesForMeal(m.key);
        const note = findNote(dateISO, m.key);
        const noteHtml = note
          ? `<div class="noteLine" title="${note.replaceAll('"','&quot;')}">üìù ${note}</div>`
          : "";

        const cards = courses.map(course => {
          const sid = slotId(dateISO, m.key, course);
          const slot = findSlot(sid);
          if (!slot || !slot.recipe_id) return "";

          const r = findRecipe(slot.recipe_id);
          let icons = "";
          if (r) {
            let iconKeys = [];
            if (r.icons) {
              try {
                iconKeys = JSON.parse(r.icons);
              } catch (e) {}
            } else if (r.icon) {
              iconKeys = [r.icon];
            }
            icons = iconKeys.map(key => `<span class="iconItem">${twemojiSvgIcon(key)}</span>`).join("");
          }

          const name = r ? String(r.name || "").trim() : getRecipeName(slot.recipe_id);
          const cls = courseClass(course);

          return `
            <div class="card ${cls}"
                onclick="openRecipeViewer('${slot.recipe_id}', event)">
              <span class="cName">${name}</span>
              <span class="cIcon">${icons}</span>
            </div>
          `;
        }).filter(Boolean).join("");

        const bodyId = mealBodyId(dateISO, m.key);
        const isMealDirty = Object.keys(DIRTY_SLOTS)
          .some(k => k.startsWith(`${dateISO}_${m.key}_`));

        return `
          <div class="mealRow">
            <div class="mealLabel">${MEALS.find(x=>x.key===m.key)?.label || m.key}</div>
            <div id="${bodyId}"
              class="mealBody meal-${m.key} ${isMealDirty ? "dirty" : ""} ${(noteHtml || cards) ? "hasContent" : ""}"
              data-meal="${m.key}"
              role="button"
              tabindex="0"
              title="Editar ${MEALS.find(x=>x.key===m.key)?.label || m.key}"
              onclick="openCellEditor('${dateISO}','${m.key}')"
              onkeydown="if(event.key==='Enter' || event.key===' ') openCellEditor('${dateISO}','${m.key}')">
              <div class="mealCards">
                ${noteHtml}
                ${cards || ""}
              </div>
              ${isMealDirty
                ? `<div class="badgeRow">
                    <span class="dirtyBadge">Pendent de guardar</span>
                  </div>`
                : ""}
            </div>
          </div>
        `;
      }).join("");

      const colHtml = `
        <div class="dayCol" data-date="${dateISO}" style="background:${dayBg}">
          <div class="dayHead">
            <div class="dayName">${dayTitle(dateISO)}</div>
            <div class="dayDate">${formatShortCa(dateObj)}</div>
          </div>
          <div class="dayMeals">
            ${mealsHtml}
          </div>
        </div>
      `;

      document.getElementById("grid").innerHTML = `
        <div class="board" id="dailyBoard">
          <div class="weekCols">
            ${colHtml}
          </div>
        </div>
      `;

      // Setup swipe handlers for daily view
      setupDailySwipeHandlers();
    }

    function setupDailySwipeHandlers() {
      const board = document.getElementById("dailyBoard");
      if (!board) return;

      let startX = 0;
      let startY = 0;
      const THRESHOLD = 50;

      board.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }, false);

      board.addEventListener("touchend", (e) => {
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        const diffX = endX - startX;
        const diffY = endY - startY;

        // Require mostly horizontal movement
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > THRESHOLD) {
          if (diffX > 0) {
            // Swipe right = previous day
            prevDay();
          } else {
            // Swipe left = next day
            nextDay();
          }
        }
      }, false);
    }

    function scrollToDateOnMobile(dateISO){
      if (!(window.matchMedia && window.matchMedia("(max-width: 640px)").matches)) return;

      const scroller = document.querySelector(".weekCols");
      if (!scroller) return;

      const el = scroller.querySelector(`.dayCol[data-date="${dateISO}"]`);
      if (!el) return;

      el.scrollIntoView({ behavior: "smooth", inline: "start", block: "nearest" });
    }


    async function addRecipe(){
      showLoading();
      try {
        const nameInput = document.getElementById("newName");
        const catSelect = document.getElementById("newCat");
        const name = nameInput.value.trim();
        const category = catSelect.value;
        
        if (!name) { 
          hideLoading(); 
          toast("error", "Error", "El nom √©s obligatori");
          return; 
        }

        // Obtenir iconos del input oculto (como JSON string)
        const iconVal = (document.getElementById("newIconValue").value || "").trim();
        let icons = [];
        if (iconVal) {
          try {
            icons = JSON.parse(iconVal);
          } catch (e) {
            console.warn("Error parsing icons:", e);
            icons = [];
          }
        }
        
        const res = await gasp("api_upsertRecipe", { name, category, icons });
        
        if (res && res.ok !== false) {
          nameInput.value = "";
          
          // Refrescar receptes en mem√≤ria
          RECIPES = (await gasp("api_getRecipes"))?.recipes
            .map(r => ({ ...r, count: Number(r.count || 0) })) || [];
          
          toast("success", "Recepta afegida", "La recepta s'ha creat correctament");
        } else {
          toast("error", "Error", res.error || "No s'ha pogut afegir la recepta");
        }

        await loadWeekData();
        renderBoardForDisplay();
        updateUIForMode();
        
        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
      } catch (err) {
        console.error("addRecipe error:", err);
        toast("error", "Error", String(err));
      } finally {
        hideLoading();
      }
    }



    document.getElementById("addBtn").addEventListener("click", addRecipe);

    // ENTER a l'input de nom = afegeix/actualitza
    document.getElementById("newName").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addRecipe();
      }
    });

    // Opcional: ENTER al desplegable de categoria tamb√© afegeix
    document.getElementById("newCat").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addRecipe();
      }
    });

    function initDefaultWeek(){
      const today = new Date();
      const mondayDate = startOfWeekMonday(today);
      WEEK_START_ISO = iso(mondayDate);
      CURRENT_DISPLAY_DATE = iso(today);  // Initialize daily view date to today
      const weekLabelEl = document.getElementById("weekLabel");
      if (weekLabelEl) {
        weekLabelEl.textContent = formatWeekLabel(mondayDate);
      }
    }

    (async function boot(){
      showLoading();
      try{
        initDefaultWeek();
        await preloadTwemojiSvgs();
        initializeIconPickers();
        
        // Ensure auth is set up first
        await bootstrapAuth();
        
        // Check if user is authenticated
        const { token } = getAuth();
        if (!token) {
          console.log("User not authenticated - skipping data load");
          hideLoading();
          return;
        }
        
        console.log("Loading recipes and week data...");
        
        // Now load data with proper error handling
        try {
          await loadRecipesOnce();
          console.log("Recipes loaded:", RECIPES.length, "recipes");
        } catch (e) {
          console.error("Error loading recipes:", e);
          toast("error", "Error carregant receptes", e.message);
        }
        
        try {
          await loadWeekData();
          console.log("Week data loaded:", PLAN.length, "items");
        } catch (e) {
          console.error("Error loading week data:", e);
          toast("error", "Error carregant dades", e.message);
        }
        
        console.log("Rendering board with WEEK_START_ISO:", WEEK_START_ISO);
        renderBoardForDisplay();
        updateUIForMode();
        
        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);
        syncMealHeights();
        
        console.log("Boot complete");
      } catch (e) {
        console.error("Boot error:", e);
        toast("error", "Error en la inicialitzaci√≥", e.message);
      } finally {
        hideLoading();
      }
    })();


    let OPEN_CELL = null;

    



    function createRecipeFilterBarForModal() {
      const keys = ICON_KEYS;
      let html = `
        <div class="recipeFilterBar" id="modalRecipeFilterBar">
          <div class="recipeFilterIcons" id="modalRecipeFilterIcons">
      `;
      
      for (const key of keys) {
        const iconSvg = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
        const label = ICON_LABELS[key] || key;
        html += `
          <button type="button" class="recipeFilterBtn" data-icon-key="${key}" 
                  title="Filtra per ${label}" onclick="toggleModalRecipeFilter('${key}', this)">
            ${iconSvg}
          </button>
        `;
      }
      
      html += `
          </div>
        </div>
      `;
      return html;
    }

    window.toggleModalRecipeFilter = function(key, btnEl) {
      if (RECIPE_FILTER_ICON === key) {
        RECIPE_FILTER_ICON = null;
        btnEl.classList.remove("active");
      } else {
        // Deselecciona el bot√≥n anterior si existe
        const prevBtn = document.querySelector("#modalRecipeFilterIcons .recipeFilterBtn.active");
        if (prevBtn) {
          prevBtn.classList.remove("active");
        }
        RECIPE_FILTER_ICON = key;
        btnEl.classList.add("active");
      }
      
      // Re-renderiza las columnas del modal
      rerenderModalRecipeColumns();
    };

    function rerenderModalRecipeColumns() {
      if (!OPEN_CELL) return;
      
      const { date, mealKey } = OPEN_CELL;
      const courses = coursesForMeal(mealKey);
      
      // Re-render cada columna
      for (const course of courses) {
        const col = document.getElementById(`col_${course}`);
        if (col) {
          col.innerHTML = renderModalColumn(date, mealKey, course);
        }
      }
    }

    function renderModalColumn(date, mealKey, course) {
      const sid = slotId(date, mealKey, course);
      
      // Obtener estado actual (puede estar en DIRTY_SLOTS o en PLAN)
      const currentByCourse = {};
      const courses = coursesForMeal(mealKey);
      courses.forEach(c => {
        const s = slotId(date, mealKey, c);
        const current = findSlot(s);
        currentByCourse[c] = current?.recipe_id ? String(current.recipe_id) : "";
      });
      
      const baseline = currentByCourse[course] || "";
      const selectedId = (DIRTY_SLOTS[sid] && !DIRTY_SLOTS[sid].__delete)
        ? String(DIRTY_SLOTS[sid].recipe_id || "")
        : baseline;

      // Obtener lista de recetas (aplicando filtro)
      let recipes = RECIPES
        .filter(r => {
          if (course !== "plat") return allowedForCourse(r, course);
          if (mealKey === "breakfast") return String(r.category||"") === "Esmorzar";
          if (mealKey === "snack")     return String(r.category||"") === "Berenar";
          return true;
        });
      
      // Aplicar filtro por icono si hay uno activo
      if (RECIPE_FILTER_ICON) {
        recipes = recipes.filter(r => {
          let iconKeys = [];
          if (r.icons) {
            try {
              iconKeys = JSON.parse(r.icons);
            } catch (e) {}
          } else if (r.icon) {
            iconKeys = [r.icon];
          }
          if (iconKeys.length === 0) {
            iconKeys = [recipeIconKey(r)];
          }
          return iconKeys.includes(RECIPE_FILTER_ICON);
        });
      }
      
      const list = rankRecipes(recipes)
        .map(r => {
          const rid = String(r.id);
          const isSel = rid === String(selectedId);
          const safeName = String(r.name||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
          
          let iconHtml = "";
          if (r.icons) {
            try {
              const iconKeys = JSON.parse(r.icons);
              if (Array.isArray(iconKeys) && iconKeys.length > 0) {
                iconHtml = iconKeys.map(key => twemojiSvgIcon(key)).join("");
              }
            } catch (e) {}
          }
          
          return `
            <button class="rCard ${isSel ? "selected":""}"
              data-course="${course}"
              data-rid="${rid}"
              data-name="${norm_(r.name)}"
              onclick="onPick('${date}','${mealKey}','${course}','${rid}')">
              <div style="display:flex; flex-direction:column; gap:2px; flex: 1;">
                <div class="rName">${safeName}</div>
                <div class="rMeta">${(r.count||0)} usos</div>
              </div>
              ${iconHtml ? `<div style="display:flex; gap:4px; align-items:center; flex: 0 0 auto;">${iconHtml}</div>` : ""}
            </button>
          `;
        }).join("");

      function colTitle(c){
        if (c === "plat") {
          return MEALS.find(x=>x.key===mealKey)?.label || "Plats";
        }
        if (c === "primer") return "Primers";
        if (c === "segon") return "Segons";
        if (c === "unic") return "Plats √∫nics";
        return "Plats";
      }

      const currentLabel = selectedId ? getRecipeName(selectedId) : "‚Äî Cap ‚Äî";

      return `
        <div class="pickerColHeader">
          <div>
            <div class="pickerColTitle">${colTitle(course)}</div>
            <div class="pickerCurrent" id="current_${course}">Ara: ${currentLabel}</div>
          </div>
          <button class="btnGhost" onclick="onPick('${date}','${mealKey}','${course}','')">‚Äî Cap ‚Äî</button>
        </div>
        <div class="pickerList" id="list_${course}">
          ${list || '<div class="muted" style="padding:6px 4px;">No hi ha plats per mostrar.</div>'}
        </div>
      `;
    }

    window.openCellEditor = async (date, mealKey) => {
      IS_IN_MODAL = true;
      if (VIEW_MODE === "view") return;
      
      // Reiniciar filtro al abrir modal
      RECIPE_FILTER_ICON = null;


      OPEN_CELL = { date, mealKey };

      const overlay = document.getElementById("overlay");
      const modalBody = document.getElementById("modalBody");

      const courses = coursesForMeal(mealKey);
      const existingNote = findNote(date, mealKey);

      const noteBlock = `
        <div class="noteField" id="noteSection" style="display: none;">
          <div class="noteField" style="margin-bottom: 0;">
            <label>Comentari (opcional)</label>

            <div class="noteInputWrap">
              <textarea id="noteBox" rows="1"
                placeholder="Ex: Dinem fora, aniversari...">${existingNote || ""}</textarea>

              <button id="clearNoteBtn" type="button" class="noteClearBtn" aria-label="Esborrar comentari">√ó</button>
            </div>

            <div class="noteActions">
              <button id="saveNoteBtn" type="button" class="btn" style="padding: 6px 12px; font-size: 12px;">Guardar comentari</button>
            </div>
          </div>
        </div>
      `;

      const currentByCourse = {};
      courses.forEach(course => {
        const sid = slotId(date, mealKey, course);
        const current = findSlot(sid);
        currentByCourse[course] = current?.recipe_id ? String(current.recipe_id) : "";
      });

      const topBar = `
        <div class="pickerTop">
          <div style="flex: 0 0 auto; font-weight: 600; font-size: 16px;">Editar ${MEALS.find(x=>x.key===mealKey)?.label || mealKey} ‚Ä¢ ${date}</div>
          <div class="pickerSearch">
            <span class="muted">üîé</span>
            <input id="modalSearch" placeholder="Cerca plats..." autocomplete="off">
          </div>
          <button id="closeModalSearchBtn" type="button" class="btnGhost" style="flex: 0 0 auto;">Tancar</button>
        </div>
      `;

      function colTitle(course){
        if (course === "plat") {
          // Un sol ‚Äúplat‚Äù per esmorzar/berenar: t√≠tol del meal
          return MEALS.find(x=>x.key===mealKey)?.label || "Plats";
        }
        if (course === "primer") return "Primers";
        if (course === "segon") return "Segons";
        if (course === "unic") return "Plats √∫nics";
        return "Plats";
      }


      function renderColumn(course){
        return renderModalColumn(date, mealKey, course);
      }

      // Construir pickerCols combinando todas las columnas
      const pickerColsContent = courses.map(course => {
        const colContent = renderModalColumn(date, mealKey, course);
        return `<div class="pickerCol" id="col_${course}">${colContent}</div>`;
      }).join("");
      
      const pickerCols = `
        <div class="pickerCols">
          ${pickerColsContent}
        </div>
      `;
      
      // Crear barra de filtros
      const filterBarHtml = createRecipeFilterBarForModal();
      
      // Build modalBody con filtro + picker
      const modalBodyContent = filterBarHtml + pickerCols;

      // Actualizar cabecera con t√≠tulo, fecha, b√∫squeda, toggle comentarios y bot√≥n cerrar
      const modalHeader = overlay?.querySelector(".modalHeader");
      const mealLabel = MEALS.find(x=>x.key===mealKey)?.label || mealKey;
      
      if (modalHeader) {
        modalHeader.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px; flex: 1; height: 40px;">
            <div style="flex: 1;">
              <div class="modalTitle">Editar ${mealLabel} ‚Ä¢ <span style="font-weight: 500; opacity: 0.8;">${date}</span></div>
            </div>
            <div class="pickerSearch" style="flex: 1; margin-left: auto; height: 100%; display: flex; align-items: center;">
              <span class="muted">üîé</span>
              <input id="modalSearch" placeholder="Cerca plats..." autocomplete="off">
            </div>
            <button id="toggleNoteHeaderBtn" type="button" class="btnGhost" style="font-size: 12px; flex: 0 0 auto; height: 100%;" title="Mostra/amaga comentari">‚ñ∏ Comentari</button>
            <button id="closeBtn" type="button" style="height: 100%; padding: 8px 12px; cursor: pointer;">Tancar</button>
          </div>
        `;
      }

      modalBody.innerHTML = noteBlock + modalBodyContent;

      // Toggle nota desde bot√≥n en cabecera
      const toggleNoteHeaderBtn = document.getElementById("toggleNoteHeaderBtn");
      const noteSection = document.getElementById("noteSection");
      if (toggleNoteHeaderBtn && noteSection) {
        toggleNoteHeaderBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const isHidden = noteSection.style.display === "none";
          noteSection.style.display = isHidden ? "block" : "none";
          toggleNoteHeaderBtn.textContent = isHidden ? "‚ñæ Comentari" : "‚ñ∏ Comentari";
        });
      }

      // Toggle nota desde bot√≥n antiguo (si existe - legacy)
      const toggleNoteBtn = document.getElementById("toggleNoteBtn");
      if (toggleNoteBtn && noteSection) {
        toggleNoteBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const isHidden = noteSection.style.display === "none";
          noteSection.style.display = isHidden ? "block" : "none";
          toggleNoteBtn.textContent = isHidden ? "‚ñæ Afegir/editar comentari" : "‚ñ∏ Afegir/editar comentari";
        });
      }

      // Cerrar modal desde el bot√≥n de la cabecera (nuevo)
      const newCloseBtn = document.getElementById("closeBtn");
      if (newCloseBtn) {
        newCloseBtn.addEventListener("click", (e) => {
          e.preventDefault();
          closeModal();
        });
      }

      // Cerrar modal desde el bot√≥n dentro del topBar (si existe - legacy)
      const closeModalBtn = document.getElementById("closeModalSearchBtn");
      if (closeModalBtn) {
        closeModalBtn.addEventListener("click", (e) => {
          e.preventDefault();
          closeModal();
        });
      }

      const noteBox = document.getElementById("noteBox");
      const clearBtn = document.getElementById("clearNoteBtn");
      const saveBtn = document.getElementById("saveNoteBtn");

      function syncClearBtn(){
        const hasText = (noteBox.value || "").trim().length > 0;
        clearBtn.classList.toggle("hidden", !hasText);
      }

      if (clearBtn && noteBox){
        // Evita que el click ‚Äúmogui‚Äù focus/selecci√≥ de manera estranya
        clearBtn.addEventListener("mousedown", (e) => e.preventDefault());

        clearBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          noteBox.value = "";
          noteBox.dispatchEvent(new Event("input", { bubbles: true }));
          noteBox.focus({ preventScroll: true });
        });

        noteBox.addEventListener("input", syncClearBtn);
        syncClearBtn();
      }

      // Save note button
      if (saveBtn && noteBox) {
        saveBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          const note = noteBox.value || "";
          try {
            const res = await gasp("api_setNote", { date, meal: mealKey, note });
            if (res && res.ok !== false) {
              toast("success", "Comentari guardat", "");
              // Recarregar les dades i el board perqu√® reflectisca la nota
              await loadWeekData();
              renderBoardForDisplay();
              
              // Collapse the notes section after saving
              const noteSection = document.getElementById("noteSection");
              const toggleNoteHeaderBtn = document.getElementById("toggleNoteHeaderBtn");
              if (noteSection) {
                noteSection.style.display = "none";
                if (toggleNoteHeaderBtn) {
                  toggleNoteHeaderBtn.textContent = "‚ñ∏ Comentari";
                }
              }
            } else {
              toast("error", "Error", res?.error || "No s'ha pogut guardar el comentari");
            }
          } catch (e) {
            toast("error", "Error", e.message);
          }
        });
      }


      // B√∫squeda dentro del selector (client-side, sin llamadas)
      const searchEl = document.getElementById("modalSearch");
      if (searchEl){
        searchEl.addEventListener("input", () => {
          const q = norm_(searchEl.value || "");
          document.querySelectorAll(".rCard").forEach(btn => {
            const name = btn.getAttribute("data-name") || "";
            btn.classList.toggle("rHidden", q && !name.includes(q));
          });
        });
        //setTimeout(()=> searchEl.focus(), 0);
      }

      overlay.classList.add("open");

      const modal = document.getElementById("modal");
      preventMobileKeyboardOnOpen(modal);


    };


    window.onPick = (date, mealKey, course, recipe_id) => {
      const sid = slotId(date, mealKey, course);
      const meal = `${mealKey}_${course}`;

      // Estat actual (baseline) segons PLAN
      const baseline = findSlot(sid)?.recipe_id ? String(findSlot(sid).recipe_id) : "";
      const nextId = String(recipe_id || "");

      // Si torna a l'estat original => no √©s un canvi pendent
      if (nextId === baseline) {
        delete DIRTY_SLOTS[sid];
      } else if (!nextId) {
        // marcar com a eliminaci√≥ pendent
        DIRTY_SLOTS[sid] = { __delete: true, slot_id: sid };
      } else {
        // marcar com a actualitzaci√≥ pendent
        DIRTY_SLOTS[sid] = { slot_id: sid, date, meal, recipe_id: nextId };
      }

      // Feedback visual al board (badge "pendent")
      recomputeMealDirty(date, mealKey);

      // Actualitzar UI dins el modal (si est√† obert)
      const cur = document.getElementById(`current_${course}`);
      if (cur){
        cur.textContent = `Ara: ${nextId ? getRecipeName(nextId) : "‚Äî Cap ‚Äî"}`;
      }
      document.querySelectorAll(`.rCard[data-course="${course}"]`).forEach(btn => {
        const rid = btn.getAttribute("data-rid") || "";
        btn.classList.toggle("selected", rid === nextId);
      });


    };







    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("closeBtn");

    document.getElementById("modal").addEventListener("click", e => {
      e.stopPropagation();
    });


    const prevWeekBtn = document.getElementById("prevWeekBtn");
    const nextWeekBtn = document.getElementById("nextWeekBtn");
    const weekLabelEl = document.getElementById("weekLabel");

    if (prevWeekBtn){
      prevWeekBtn.addEventListener("click", async () => {
        showLoading();
        const d = parseISO(WEEK_START_ISO);
        const prev = addDaysDate(d, -7);
        WEEK_START_ISO = iso(prev);

        if (weekLabelEl && !isDailyViewMode()) weekLabelEl.textContent = formatWeekLabel(prev);

        await loadWeekData();
        renderBoardForDisplay();
        updateUIForMode();

        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        hideLoading();
      });
    } else {
      console.warn("prevWeekBtn not found");
    }

    if (nextWeekBtn){
      nextWeekBtn.addEventListener("click", async () => {
        showLoading();
        const d = parseISO(WEEK_START_ISO);
        const next = addDaysDate(d, 7);
        WEEK_START_ISO = iso(next);

        if (weekLabelEl && !isDailyViewMode()) weekLabelEl.textContent = formatWeekLabel(next);

        await loadWeekData();
        renderBoardForDisplay();
        updateUIForMode();

        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
        hideLoading();
      });
    } else {
      console.warn("nextWeekBtn not found");
    }




    async function closeModal(){
      overlay.classList.remove("open");
      OPEN_CELL = null;
      IS_IN_MODAL = false;
      RECIPE_FILTER_ICON = null; // Reiniciar filtro al cerrar modal

      // Restaurar modalHeader original
      const modalHeader = document.getElementById("overlay").querySelector(".modalHeader");
      modalHeader.innerHTML = `
        <div>
          <div id="modalTitle" class="modalTitle">Editar</div>
          <div id="modalSub" class="muted"></div>
        </div>
        <button id="closeBtn">Tancar</button>
      `;

      // Re-attach event listener para el nuevo closeBtn
      const newCloseBtn = modalHeader.querySelector("#closeBtn");
      if (newCloseBtn) {
        newCloseBtn.addEventListener("click", closeModal);
      }

      const changes = Object.values(DIRTY_SLOTS);
      if (!changes.length) return;

      showLoading();

      const res = await gasp("api_applySlotChanges", { changes });
      if (res?.ok === false) {
        hideLoading();
        toast("error", "No s'ha pogut guardar", res.error || "");
        return;
      }

      DIRTY_SLOTS = {};
      await loadWeekData();
      renderBoardForDisplay();
      updateUIForMode();
      // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)
      const todayISO = iso(new Date());
      const dates = buildDates(WEEK_START_ISO);
      scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

      syncMealHeights();
      hideLoading();
      toast("success", "Men√∫ actualitzat", "Canvis guardats.");
    }


    closeBtn.addEventListener("click", closeModal);

    // clic fora del quadre (overlay) => tanca
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeModal();
    });

    function recomputeMealDirty(date, mealKey){
      const stillDirty = Object.keys(DIRTY_SLOTS).some(k => k.startsWith(`${date}_${mealKey}_`));
      markMealDirty(date, mealKey, stillDirty);
    }
    function syncMealHeights(){
      // En m√≤bil (carrusel), no igualem al√ßades
      if (window.matchMedia && window.matchMedia("(max-width: 640px)").matches) {
        document.querySelectorAll(".mealBody").forEach(el => el.style.minHeight = "0");
        return;
      }

      const keys = ["breakfast","lunch","snack","dinner"];

      // reset
      document.querySelectorAll(".mealBody").forEach(el => {
        el.style.minHeight = "0";
      });

      keys.forEach(k => {
        const els = Array.from(document.querySelectorAll(`.mealBody[data-meal="${k}"]`));
        if (!els.length) return;

        const maxH = Math.max(...els.map(el => el.getBoundingClientRect().height));
        els.forEach(el => el.style.minHeight = `${Math.ceil(maxH)}px`);
      });
    }


    let RECIPE_EDITOR_OPEN = false;
    let SELECTED_RECIPE_ID = null;
    let RECIPE_DIRTY = false;

    function setRecipeDirty(isDirty){
      RECIPE_DIRTY = !!isDirty;

      const topBtn = document.getElementById("recipeSaveTopBtn");
      const topStatus = document.getElementById("recipeTopStatus");

      if (topBtn) topBtn.disabled = !RECIPE_DIRTY || !SELECTED_RECIPE_ID;

      if (topStatus){
        topStatus.textContent = RECIPE_DIRTY ? "Canvis pendents" : "";
      }
    }


    function openRecipeEditor(){
      RECIPE_EDITOR_OPEN = true;
      SELECTED_RECIPE_ID = null;

      document.getElementById("recipeOverlay").classList.add("open");
      document.getElementById("recipeEmpty").style.display = "block";
      document.getElementById("recipeForm").style.display = "none";
      document.getElementById("recipeSearchInput").value = "";

      renderRecipeList();
      setTimeout(() => {
        if (Array.isArray(RECIPES) && RECIPES.length) {
          selectRecipeForEdit(String(RECIPES[0].id));
        }
      }, 0);
    }

    function closeRecipeEditor(){
      if (RECIPE_DIRTY){
        const ok = confirm("Tens canvis pendents. Vols tancar sense guardar?");
        if (!ok) return;
      }
      RECIPE_EDITOR_OPEN = false;
      document.getElementById("recipeOverlay").classList.remove("open");
    }


    function renderRecipeList(){
      const q = norm_(document.getElementById("recipeSearchInput").value || "");
      const listEl = document.getElementById("recipeList");
      listEl.innerHTML = "";

      // Usa getFilteredRecipes() en lugar de RECIPES para aplicar el filtro
      const items = rankRecipes(getFilteredRecipes()).filter(r => {
        if (!q) return true;
        return norm_(r.name || "").includes(q);
      });

      if (!items.length){
        listEl.innerHTML = `<div class="muted" style="padding:6px 4px;">No hi ha receptes.</div>`;
        return;
      }

      for (const r of items){
        let iconKeys = [];
        if (r.icons) {
          try {
            iconKeys = JSON.parse(r.icons);
          } catch (e) {}
        } else if (r.icon) {
          iconKeys = [r.icon];
        }
        const iconsHtml = iconKeys.map(key => `<span class="iconItem">${twemojiSvgIcon(key)}</span>`).join("");
        
        const row = document.createElement("div");
        row.className = "recipeRow" + (String(r.id) === String(SELECTED_RECIPE_ID) ? " selected" : "");
        row.innerHTML = `
          <div class="recipeRowContent">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${(r.name||"")}</div>
            <div class="muted" style="font-size:12px;">${(r.category||"")}</div>
          </div>
          ${iconsHtml ? `<div class="recipeRowIcons">${iconsHtml}</div>` : ""}
        `;
        row.addEventListener("click", ()=> selectRecipeForEdit(String(r.id)));
        listEl.appendChild(row);
      }
    }

    function selectRecipeForEdit(id){
      SELECTED_RECIPE_ID = id;
      renderRecipeList();

      const r = RECIPES.find(x => String(x.id) === String(id));
      if (!r) return;

      document.getElementById("recipeEmpty").style.display = "none";
      document.getElementById("recipeForm").style.display = "flex";

      // Soportar ambos formatos: campo "icon" antiguo y "icons" nuevo
      let iconKeys = [];
      if (r.icons) {
        try {
          iconKeys = JSON.parse(r.icons);
        } catch (e) {
          console.warn("Error parsing icons JSON:", e);
        }
      } else if (r.icon) {
        iconKeys = [r.icon];
      }

      document.getElementById("rIconValue").value = iconKeys.length > 0 ? JSON.stringify(iconKeys) : "";
      selectIconsInPicker(document.getElementById("rIconPicker"), iconKeys);

      // Update preview
      const previewEl = document.getElementById("rIconPreview");
      if (previewEl) {
        previewEl.innerHTML = iconKeys.map(key => twemojiSvgIcon(key)).join("");
      }
      
      document.getElementById("rName").value = String(r.name || "");
      document.getElementById("rCategory").value = String(r.category || "");
      document.getElementById("rIngredients").value = String(r.ingredients || "");
      document.getElementById("rSteps").value = String(r.steps || "");
      document.getElementById("rVideo").value = String(r.video_url || "");
      document.getElementById("rStatus").textContent = "";
      setRecipeDirty(false);
    }

    function deleteRecipeWithConfirmation() {
      if (!SELECTED_RECIPE_ID) return;
      
      const r = RECIPES.find(x => String(x.id) === String(SELECTED_RECIPE_ID));
      if (!r) return;
      
      const recipeName = String(r.name || "Recepta");
      
      // Crear di√°logo de confirmaci√≥n
      const confirmed = confirm(`¬øEst√°s seguro de que deseas borrar "${recipeName}"?\n\nEsta acci√≥n no se puede deshacer.`);
      
      if (confirmed) {
        deleteRecipe();
      }
    }

    async function deleteRecipe() {
      if (!SELECTED_RECIPE_ID) return;

      document.getElementById("rStatus").textContent = "Borrando...";
      showLoading({ silent: true });

      const topBtn = document.getElementById("recipeSaveTopBtn");
      const topStatus = document.getElementById("recipeTopStatus");
      if (topStatus) topStatus.textContent = "Borrando...";
      if (topBtn) topBtn.disabled = true;

      try {
        const { token } = getAuth();
        const response = await fetch(`/api/recipes?id=${encodeURIComponent(SELECTED_RECIPE_ID)}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Error borrando la receta");
        }

        // Recargar recetas - forzar recarga sin cach√©
        RECIPES = [];
        await loadRecipesOnce();
        
        document.getElementById("rStatus").textContent = "Borrada.";
        SELECTED_RECIPE_ID = null;
        
        // Cerrar el formulario y volver a la lista
        document.getElementById("recipeForm").style.display = "none";
        document.getElementById("recipeEmpty").style.display = "block";
        renderRecipeList();
        
        toast("success", "Receta borrada", "La receta se ha eliminado correctamente.");
      } catch (e) {
        document.getElementById("rStatus").textContent = "Error al borrar.";
        toast("error", "Error borrando receta", e.message);
      } finally {
        hideLoading();
        const topBtn = document.getElementById("recipeSaveTopBtn");
        if (topBtn) topBtn.disabled = false;
      }
    }

    async function saveRecipeDetails(){
      if (!SELECTED_RECIPE_ID) return;

      const payload = {
        id: SELECTED_RECIPE_ID,
        icons: (document.getElementById("rIconValue").value || "").trim(),
        name: (document.getElementById("rName").value || "").trim(),
        category: (document.getElementById("rCategory").value || "").trim(),
        ingredients: (document.getElementById("rIngredients").value || "").trim(),
        steps: (document.getElementById("rSteps").value || "").trim(),
        video_url: (document.getElementById("rVideo").value || "").trim(),
      };

      document.getElementById("rStatus").textContent = "Guardant...";
      showLoading({ silent: true });

      const topBtn = document.getElementById("recipeSaveTopBtn");
      const topStatus = document.getElementById("recipeTopStatus");
      if (topStatus) topStatus.textContent = "Guardant...";
      if (topBtn) topBtn.disabled = true;


      try{
        const res = await gasp("api_upsertRecipe", payload);
        if (res?.ok === false) throw new Error(res.error || "Error");

        // Recarrega RECIPES (per veure canvis a icona/nom al picker i al board)
        const rr = await gasp("api_getRecipes");
        RECIPES = (rr?.recipes || []).map(x => ({...x, count:Number(x.count||0)}));

        document.getElementById("rStatus").textContent = "Guardat.";
        toast("success", "Recepta guardada");
        renderRecipeList();
        // tamb√© refresquem el board perqu√® icones/nom reflecteixin immediatament
        renderBoardForDisplay();
        updateUIForMode();
        // si la setmana carregada cont√© avui, hi anem; si no, al dilluns (primer dia de la setmana)

        setRecipeDirty(false);
        if (topStatus) topStatus.textContent = "Guardat";
        setTimeout(()=>{ if (document.getElementById("recipeTopStatus")) document.getElementById("recipeTopStatus").textContent = ""; }, 1200);

        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);

        syncMealHeights();
      } catch(err){
        document.getElementById("rStatus").textContent = "Error en guardar.";
        if (topStatus) topStatus.textContent = "Error en guardar";
        if (topBtn) topBtn.disabled = false;
        toast("error", "No s'ha pogut guardar", String(err));
      } finally {
        hideLoading();
      }
    }

    // Wire events
    document.addEventListener("DOMContentLoaded", () => {
      const recipeOverlayEl = document.getElementById("recipeOverlay");
      const recipeModalEl = document.getElementById("recipeModal");
      const recipeCloseBtnEl = document.getElementById("recipeCloseBtn");

      if (recipeOverlayEl) {
        recipeOverlayEl.addEventListener("click", (e) => {
          if (e.target === recipeOverlayEl) closeRecipeEditor();
        });
      } else {
        console.warn("recipeOverlay not found");
      }

      if (recipeModalEl) {
        recipeModalEl.addEventListener("click", (e) => e.stopPropagation());
      } else {
        console.warn("recipeModal not found");
      }

      if (recipeCloseBtnEl) {
        recipeCloseBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          closeRecipeEditor();
        });
      } else {
        console.warn("recipeCloseBtn not found");
      }

      const manageRecipesBtnEl = document.getElementById("manageRecipesBtn");
      if (manageRecipesBtnEl) {
        manageRecipesBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          openRecipeEditor();
          const modal = document.getElementById("recipeModal");
          preventMobileKeyboardOnOpen(modal);

        });
      } else {
        console.warn("manageRecipesBtn not found");
      }

      const recipeSaveTopBtnEl = document.getElementById("recipeSaveTopBtn");
      if (recipeSaveTopBtnEl) {
        recipeSaveTopBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          saveRecipeDetails();
        });
      }

      const recipeDeleteBtnEl = document.getElementById("recipeDeleteBtn");
      if (recipeDeleteBtnEl) {
        recipeDeleteBtnEl.addEventListener("click", (e) => {
          e.preventDefault();
          deleteRecipeWithConfirmation();
        });
      }

      const recipeSearchInputEl = document.getElementById("recipeSearchInput");
      if (recipeSearchInputEl) {
        recipeSearchInputEl.addEventListener("input", () => {
          renderRecipeList();
        });

        // opcional: ESC neteja la cerca
        recipeSearchInputEl.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            recipeSearchInputEl.value = "";
            renderRecipeList();
          }
        });
      } else {
        console.warn("recipeSearchInput not found");
      }

      const markDirty = () => setRecipeDirty(true);

      ["rName","rCategory","rIcon","rIngredients","rSteps","rVideo"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", markDirty);
        el.addEventListener("change", markDirty);
      });


    });
   



    

    function getRecipeName(id){
      const r = findRecipe(id);
      if (!r) return "‚Äî";
      return String(r.name || "").trim() || "‚Äî";
    }

    window.openRecipeViewer = (recipeId, ev) => {
      if (ev) ev.stopPropagation(); // clau: que no obri el planificador

      const r = RECIPES.find(x => String(x.id) === String(recipeId));
      if (!r) return;
      
      RV_RECIPE_ID = String(recipeId || "");

      const title = document.getElementById("rvTitle");
      const meta  = document.getElementById("rvMeta");
      const ing   = document.getElementById("rvIngredients");
      const steps = document.getElementById("rvSteps");
      const vWrap = document.getElementById("rvVideoWrap");
      const vLink = document.getElementById("rvVideoLink");

      const safeName = String(r.name || "Recepta")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");

      // Renderizar iconos de ingredientes si existen
      let iconHtml = "";
      if (r.icons) {
        try {
          const iconKeys = JSON.parse(r.icons);
          if (Array.isArray(iconKeys) && iconKeys.length > 0) {
            iconHtml = iconKeys.map(key => twemojiSvgIcon(key)).join(" ");
          }
        } catch (e) {
          // ignorar si hay error al parsear JSON
        }
      }

      title.innerHTML = `<span>${safeName}</span>${iconHtml ? ` ${iconHtml}` : ""}`;

      meta.textContent  = String(r.category || "");

      ing.textContent   = String(r.ingredients || "‚Äî");
      steps.textContent = String(r.steps || "‚Äî");

      const url = String(r.video_url || "").trim();
      if (url) {
        vWrap.style.display = "block";
        vLink.href = url;
      } else {
        vWrap.style.display = "none";
        vLink.href = "#";
      }

      document.getElementById("recipeViewOverlay").classList.add("open");
    };

    function closeRecipeViewer(){
      document.getElementById("recipeViewOverlay").classList.remove("open");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const ov = document.getElementById("recipeViewOverlay");
      const modal = document.getElementById("recipeViewModal");
      const btn = document.getElementById("rvCloseBtn");
      const closeBtn = document.getElementById("rvCloseBtn");
      const editBtn  = document.getElementById("rvEditBtn");

      if (closeBtn) closeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        closeRecipeViewer();
      });

      if (editBtn) editBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const id = RV_RECIPE_ID;
        if (!id) return;

        // 1) tanca visor
        closeRecipeViewer();

        // 2) obre editor
        openRecipeEditor();
        const modal = document.getElementById("recipeModal");
        preventMobileKeyboardOnOpen(modal);


        // 3) selecciona recepta (deixa un tick perqu√® el DOM i la llista estiguin pintats)
        setTimeout(() => {
          selectRecipeForEdit(String(id));
          // opcional: porta el focus al nom
          //setTimeout(() => document.getElementById("rName")?.focus(), 0);
        }, 0);
      });

      // clic fora del modal tanca
      if (ov) ov.addEventListener("click", (e) => {
        if (e.target === ov) closeRecipeViewer();
      });

      // evita propagaci√≥ dins modal
      if (modal) modal.addEventListener("click", (e) => e.stopPropagation());
    });

// REMOVE: document.addEventListener("DOMContentLoaded", () => {
//   const newPickerEl = document.getElementById("newIconPicker");
//   if (newPickerEl) {
//     fillIconPickerForAdd(newPickerEl, { includeAuto: true });
//   }
//   const recipePickerEl = document.getElementById("rIconPicker");
//   if (recipePickerEl) {
//     fillIconPicker(recipePickerEl, { includeAuto: true });
//   }
// });

    function fillIconPickerForAdd(pickerEl) {
      if (!pickerEl) return;

      pickerEl.innerHTML = "";
      const keys = ICON_KEYS;

      for (const key of keys) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "iconPickerBtn";
        btn.dataset.iconKey = key;
        btn.title = ICON_LABELS[key] || key;
        
        // Render the icon
        const iconHtml = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
        btn.innerHTML = iconHtml;
        
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          // Selecci√≥n m√∫ltiple: toggle
          const isSelected = btn.classList.contains("selected");
          const selectedBtns = Array.from(pickerEl.querySelectorAll(".iconPickerBtn.selected"));
          
          // Si intenta seleccionar el 4¬∫ icono, mostrar error
          if (!isSelected && selectedBtns.length >= 3) {
            toast("error", "M√†xim 3 icones", "No pots afegir m√©s de 3 icones.");
            return;
          }
          
          // Toggle selecci√≥n
          btn.classList.toggle("selected");
          
          // Actualizar preview y valor oculto
          updateIconPreviewAndValue("newIconPreview", "newIconValue", pickerEl);
        });
        
        pickerEl.appendChild(btn);
      }
    }

    function fillIconPicker(pickerEl) {
      if (!pickerEl) return;

      pickerEl.innerHTML = "";
      const keys = ICON_KEYS;

      for (const key of keys) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "iconPickerBtn";
        btn.dataset.iconKey = key;
        btn.title = ICON_LABELS[key] || key;
        
        // Render the icon
        const iconHtml = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
        btn.innerHTML = iconHtml;
        
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          // Selecci√≥n m√∫ltiple: toggle
          const isSelected = btn.classList.contains("selected");
          const selectedBtns = Array.from(pickerEl.querySelectorAll(".iconPickerBtn.selected"));
          
          // Si intenta seleccionar el 4¬∫ icono, mostrar error
          if (!isSelected && selectedBtns.length >= 3) {
            toast("error", "M√†xim 3 icones", "No pots afegir m√©s de 3 icones.");
            return;
          }
          
          // Toggle selecci√≥n
          btn.classList.toggle("selected");
          
          // Actualizar preview y valor oculto
          updateIconPreviewAndValue("rIconPreview", "rIconValue", pickerEl);
          
          // Mark form as dirty
          setRecipeDirty(true);
        });
        
        pickerEl.appendChild(btn);
      }
    }

    function updateIconPreviewAndValue(previewId, valueId, pickerEl) {
      const selectedBtns = Array.from(pickerEl.querySelectorAll(".iconPickerBtn.selected"));
      const selectedKeys = selectedBtns.map(b => b.dataset.iconKey);
      
      // Actualizar preview: mostrar los iconos seleccionados
      const previewEl = document.getElementById(previewId);
      if (previewEl) {
        previewEl.innerHTML = selectedKeys.map(key => twemojiSvgIcon(key)).join("");
      }
      
      // Guardar com a JSON en el input oculto
      const hiddenInput = document.getElementById(valueId);
      if (hiddenInput) {
        hiddenInput.value = selectedKeys.length > 0 ? JSON.stringify(selectedKeys) : "";
      }
    }

    function selectIconsInPicker(pickerEl, iconKeys) {
      if (!pickerEl) return;
      
      // Limpiar selecciones previas
      pickerEl.querySelectorAll(".iconPickerBtn").forEach(b => b.classList.remove("selected"));
      
      // iconKeys puede ser: null, "", [], o array de strings
      if (!iconKeys || iconKeys.length === 0) return;
      
      // Si es string (JSON), parsearlo
      let keys = iconKeys;
      if (typeof iconKeys === "string") {
        try {
          keys = JSON.parse(iconKeys);
        } catch (e) {
          // Si falla, asumir que es un string single
          keys = [iconKeys];
        }
      }
      
      // Seleccionar cada icono
      if (Array.isArray(keys)) {
        keys.forEach(key => {
          const btn = pickerEl.querySelector(`[data-icon-key="${key}"]`);
          if (btn) {
            btn.classList.add("selected");
          }
        });
      }
    }

    function initializeIconPickers() {
      // New recipe icon picker
      const newPickerEl = document.getElementById("newIconPicker");
      if (newPickerEl) {
        fillIconPickerForAdd(newPickerEl);
      }

      // Recipe editor icon picker
      const recipePickerEl = document.getElementById("rIconPicker");
      if (recipePickerEl) {
        fillIconPicker(recipePickerEl);
      }
    }

    function initializeRecipeFilterBar() {
      const filterContainer = document.getElementById("recipeFilterIcons");
      if (!filterContainer) return;

      filterContainer.innerHTML = "";
      const keys = ICON_KEYS;

      for (const key of keys) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "recipeFilterBtn";
        btn.dataset.iconKey = key;
        btn.title = `Filtra per ${ICON_LABELS[key] || key}`;
        
        // Render the icon
        const iconHtml = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
        btn.innerHTML = iconHtml;
        
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          // Toggle: si ja est√† seleccionat, deselecciona; si no, selecciona
          if (RECIPE_FILTER_ICON === key) {
            RECIPE_FILTER_ICON = null; // Deselecciona
            btn.classList.remove("active");
          } else {
            // Deselecciona el bot√≥ anterior si existeix
            const prevBtn = filterContainer.querySelector(".recipeFilterBtn.active");
            if (prevBtn) {
              prevBtn.classList.remove("active");
            }
            RECIPE_FILTER_ICON = key; // Selecciona el nou
            btn.classList.add("active");
          }
          
          // Actualitza la llista de receptes
          renderRecipeList();
        });
        
        filterContainer.appendChild(btn);
      }
    }

    function getFilteredRecipes() {
      if (!RECIPE_FILTER_ICON) {
        return RECIPES; // Si no hi ha filtre, retorna totes
      }
      
      // Filtra per icones que cont√© el key seleccionat
      return RECIPES.filter(r => {
        let iconKeys = [];
        if (r.icons) {
          try {
            iconKeys = JSON.parse(r.icons);
          } catch (e) {}
        } else if (r.icon) {
          iconKeys = [r.icon];
        }
        
        // Si la recepta no t√© iconos, assigna l'icono autom√†tic
        if (iconKeys.length === 0) {
          iconKeys = [recipeIconKey(r)];
        }
        
        return iconKeys.includes(RECIPE_FILTER_ICON);
      });
    }

    function selectIconInPicker(pickerEl, iconKey) {
      if (!pickerEl || !iconKey) return;
      
      // Clear previous selection
      pickerEl.querySelectorAll(".iconPickerBtn").forEach(b => b.classList.remove("selected"));
      
      // Find and select the button with this key
      const btn = pickerEl.querySelector(`[data-icon-key="${iconKey}"]`);
      if (btn) {
        btn.classList.add("selected");
      }
    }

    function selectIconsInPicker(pickerEl, iconKeys) {
      if (!pickerEl) return;
      
      // Limpiar selecciones previas
      pickerEl.querySelectorAll(".iconPickerBtn").forEach(b => b.classList.remove("selected"));
      
      // iconKeys puede ser: null, "", [], o array de strings
      if (!iconKeys || iconKeys.length === 0) return;
      
      // Si es string (JSON), parsearlo
      let keys = iconKeys;
      if (typeof iconKeys === "string") {
        try {
          keys = JSON.parse(iconKeys);
        } catch (e) {
          // Si falla, asumir que es un string single
          keys = [iconKeys];
        }
      }
      
      // Seleccionar cada icono
      if (Array.isArray(keys)) {
        keys.forEach(key => {
          const btn = pickerEl.querySelector(`[data-icon-key="${key}"]`);
          if (btn) {
            btn.classList.add("selected");
          }
        });
      }
    }

    function bindIconPreview(selectEl, previewEl) {
      if (!selectEl || !previewEl) return;

      const render = () => {
        const key = String(selectEl.value || "").trim();
        // si √©s Auto (value=""), mostra plate
        previewEl.innerHTML = twemojiSvgIcon(key) || twemojiSvgIcon("plate");
      };

      selectEl.addEventListener("change", render);
      render();
    }
    function preventMobileKeyboardOnOpen(modalEl){
      // 1) Si hi ha algun input enfocat, el desfocusem
      if (document.activeElement && typeof document.activeElement.blur === "function") {
        document.activeElement.blur();
      }

      // 2) Focalitzem un element no-editable (no obre teclat)
      // IMPORTANT: el modal ha de tenir tabindex="-1" (veure punt 2)
      if (modalEl && typeof modalEl.focus === "function") {
        // defer per evitar que algun altre focus "guanyi" just despr√©s
        setTimeout(() => modalEl.focus({ preventScroll: true }), 0);
      }

      // 3) Assegurem que cap input/textarea quedi amb autofocus
      if (modalEl){
        modalEl.querySelectorAll("input[autofocus], textarea[autofocus]").forEach(el => el.removeAttribute("autofocus"));
      }
    }

    async function login(code) {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      });
    
      const data = await res.json();
    
      if (!data.ok) {
        throw new Error(data.error || "Login failed");
      }
    
      // üîê AQU√ç √âS EL PUNT 1
      localStorage.setItem("mf_token", data.token);
      localStorage.setItem("mf_family", JSON.stringify(data.family));
    
      return data;
    }

    function isLoggedIn() {
      return !!localStorage.getItem("mf_token");
    }
    
    async function bootstrapAuth() {
      const token = localStorage.getItem("mf_token");
      if (!token) {
        console.log("No token. Not logged in.");
        return;
      }
    
      const res = await apiFetch("/api/me");
      const data = await res.json().catch(() => null);
    
      if (!res.ok || !data?.ok) {
        console.log("Token invalid/expired. Clearing.", data);
        localStorage.removeItem("mf_token");
        localStorage.removeItem("mf_family");
        return;
      }
    
      console.log("Token valid. Payload:", data.payload);
      // aqu√≠ ja pots activar la UI ‚Äúloguejada‚Äù de forma segura
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      bootstrapAuth();
    });

    
    document.addEventListener("DOMContentLoaded", () => {
      renderAuthState();
    });

    async function apiFetch(path, options = {}) {
      const token = localStorage.getItem("mf_token");
      
      if (!token) {
        console.warn("apiFetch: No token in localStorage. User may not be authenticated.");
      }
      
      const headers = {
        ...(options.headers || {}),
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
      };

      console.log("apiFetch:", { path, tokenExists: !!token, headers });
      
      const res = await fetch(path, { ...options, headers });
      return res;
    }

    // ===== AUTH (client) =====
    const AUTH_TOKEN_KEY = "mf_token";
    const AUTH_FAMILY_KEY = "mf_family";

    function setAuth(token, family) {
      localStorage.setItem("mf_token", token);
      localStorage.setItem("mf_family", JSON.stringify(family));
    }
  
    function clearAuth() {
      localStorage.removeItem("mf_token");
      localStorage.removeItem("mf_family");
    }
  
    function getAuth() {
      const token = localStorage.getItem("mf_token");
      const familyRaw = localStorage.getItem("mf_family");
      let family = null;
      try { family = familyRaw ? JSON.parse(familyRaw) : null; } catch {}
      return { token, family };
    }
  
    function renderAuthState() {
      const { token, family } = getAuth();
  
      const userMenuContainer = document.getElementById("userMenuContainer");
      const loginForm = document.getElementById("loginForm");
      const userMenuLabel = document.getElementById("userMenuLabel");
      const userMenuAdmin = document.getElementById("userMenuAdmin");
      const container = document.querySelector(".container");
  
      const logged = !!token && !!family;
  
      if (logged) {
        // Mostrar men√∫ de usuario
        userMenuContainer.style.display = "block";
        loginForm.style.display = "none";
        
        // Usar display_name si est√° disponible, sino el name
        const displayName = family.display_name || family.name;
        userMenuLabel.textContent = displayName;
        
        // Mostrar opci√≥n de administraci√≥n si es admin
        userMenuAdmin.style.display = family.role === "admin" ? "block" : "none";
        
        container?.classList.remove("not-authenticated");
      } else {
        userMenuContainer.style.display = "none";
        loginForm.style.display = "flex";
        container?.classList.add("not-authenticated");
      }
    }
  
    function closeUserMenu() {
      const dropdown = document.getElementById("userMenuDropdown");
      if (dropdown) {
        dropdown.classList.remove("open");
      }
    }
  
    window.openUserMenu = function(e) {
      e.stopPropagation();
      const dropdown = document.getElementById("userMenuDropdown");
      if (dropdown) {
        dropdown.classList.toggle("open");
      }
    };
  
    window.openPreferencesModal = async function() {
      closeUserMenu();
      const { token, family } = getAuth();
      
      if (!token || !family) return;
      
      // Mostrar modal de preferencias
      const overlay = document.getElementById("overlay");
      const modal = document.getElementById("modal");
      const modalHeader = overlay?.querySelector(".modalHeader");
      const modalBody = document.getElementById("modalBody");
      
      if (!modalHeader || !modalBody) return;
      
      IS_IN_MODAL = true;
      
      modalHeader.innerHTML = `
        <div>
          <div class="modalTitle">Prefer√®ncies</div>
        </div>
        <button id="preferencesCloseBtn">Tancar</button>
      `;
      
      const displayName = family.display_name || family.name;
      
      modalBody.innerHTML = `
        <div style="padding: 20px 0; grid-column: 1 / -1;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nom visible</label>
            <input id="prefDisplayNameInput" type="text" value="${displayName}" 
                   placeholder="Nom de la fam√≠lia" style="width: 100%; margin-bottom: 12px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="prefCancelBtn" style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">Cancelar</button>
              <button id="prefSaveBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar</button>
            </div>
          </div>

          <hr style="border: 0; height: 1px; background: #eee; margin: 20px 0;">

          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Canviar contrasenya d'acc√©s</label>
            <div style="background: #f9f9f9; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
              <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Codi actual: <span style="font-family: monospace; font-weight: bold;">XXXX</span></div>
              <button id="changeCodeBtn" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Canviar codi</button>
            </div>
          </div>
        </div>
      `;
      
      // Event listeners
      const prefSaveBtn = document.getElementById("prefSaveBtn");
      const prefCancelBtn = document.getElementById("prefCancelBtn");
      const preferencesCloseBtn = document.getElementById("preferencesCloseBtn");
      const prefDisplayNameInput = document.getElementById("prefDisplayNameInput");
      const changeCodeBtn = document.getElementById("changeCodeBtn");
      
      const closePrefs = () => {
        overlay.classList.remove("open");
        IS_IN_MODAL = false;
      };
      
      prefSaveBtn.addEventListener("click", async () => {
        const newDisplayName = (prefDisplayNameInput.value || "").trim();
        if (!newDisplayName) {
          alert("El nom no pot estar buit");
          return;
        }
        
        try {
          prefSaveBtn.disabled = true;
          const response = await apiFetch("/api/family", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "updateDisplayName", display_name: newDisplayName })
          });
          
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Error saving preferences");
          }
          
          // Actualizar localStorage
          family.display_name = newDisplayName;
          localStorage.setItem("mf_family", JSON.stringify(family));
          renderAuthState();
          
          alert("Prefer√®ncies guardades");
          closePrefs();
        } catch (e) {
          alert("Error: " + String(e));
          prefSaveBtn.disabled = false;
        }
      });
      
      changeCodeBtn.addEventListener("click", () => {
        showChangeCodeForm();
      });
      
      prefCancelBtn.addEventListener("click", closePrefs);
      preferencesCloseBtn.addEventListener("click", closePrefs);
      
      overlay.classList.add("open");
      preventMobileKeyboardOnOpen(modal);
    };

    function showChangeCodeForm() {
      const modalBody = document.getElementById("modalBody");
      const newCode = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
      
      modalBody.innerHTML = `
        <div style="grid-column: 1 / -1;">
          <h3 style="margin-top: 0;">Nou codi d'acc√©s</h3>
          <div style="display: grid; gap: 10px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nou codi:</label>
              <input type="text" id="newCodeInput" value="${newCode}" maxlength="6" 
                     style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 18px; font-family: monospace; font-weight: bold;" />
              <div style="font-size: 12px; color: #666; margin-top: 5px;">Pots canviar els d√≠gits si ho vols</div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button id="genNewCodeBtn" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Generar nou</button>
              <button id="cancelChangeCodeBtn" style="padding: 8px 16px; background: #ccc; color: #333; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Cancelar</button>
              <button id="confirmChangeCodeBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Confirmar</button>
            </div>
          </div>
        </div>
      `;
      
      const newCodeInput = document.getElementById("newCodeInput");
      const genNewCodeBtn = document.getElementById("genNewCodeBtn");
      const cancelChangeCodeBtn = document.getElementById("cancelChangeCodeBtn");
      const confirmChangeCodeBtn = document.getElementById("confirmChangeCodeBtn");
      
      genNewCodeBtn.addEventListener("click", () => {
        const generatedCode = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
        newCodeInput.value = generatedCode;
      });
      
      cancelChangeCodeBtn.addEventListener("click", () => {
        openPreferencesModal();
      });
      
      confirmChangeCodeBtn.addEventListener("click", async () => {
        const codeValue = newCodeInput.value.trim();
        
        if (!codeValue || codeValue.length < 4) {
          alert("El codi ha de tenir com a m√≠nim 4 d√≠gits");
          return;
        }
        
        if (!/^\d+$/.test(codeValue)) {
          alert("El codi nom√©s pot contenir d√≠gits");
          return;
        }
        
        confirmChangeCodeBtn.disabled = true;
        confirmChangeCodeBtn.textContent = "Canviant...";
        
        try {
          const response = await apiFetch("/api/family", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "changeMyCode", new_code: codeValue })
          });
          
          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || "Error al canviar el codi");
          }
          
          alert("‚úì Codi canviat correctament!\n\nNou codi: " + codeValue);
          openPreferencesModal();
        } catch (e) {
          alert("Error: " + String(e));
          confirmChangeCodeBtn.disabled = false;
          confirmChangeCodeBtn.textContent = "Confirmar";
        }
      });
    }

  
    window.openAdminModal = async function() {
      closeUserMenu();
      const { token, family } = getAuth();
      
      if (!token || !family || family.role !== "admin") return;
      
      const overlay = document.getElementById("overlay");
      const modal = document.getElementById("modal");
      const modalHeader = overlay?.querySelector(".modalHeader");
      const modalBody = document.getElementById("modalBody");
      
      if (!modalHeader || !modalBody) return;
      
      IS_IN_MODAL = true;
      
      modalHeader.innerHTML = `
        <div>
          <div class="modalTitle">Administraci√≥ de fam√≠lies</div>
        </div>
        <button id="adminCloseBtn">Tancar</button>
      `;
      
      // Cargar lista de familias
      const res = await apiFetch("/api/family", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "listFamilies" })
      });
      const data = await res.json();
      
      if (!data.ok) {
        modalBody.innerHTML = `<div style="grid-column: 1 / -1; color: red;">Error: ${data.error}</div>`;
        const adminCloseBtn = document.getElementById("adminCloseBtn");
        adminCloseBtn.addEventListener("click", () => {
          overlay.classList.remove("open");
          IS_IN_MODAL = false;
        });
        overlay.classList.add("open");
        return;
      }
      
      const families = data.families || [];
      
      // Tabla de familias
      let familiesHtml = `
        <div style="grid-column: 1 / -1; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Fam√≠lies</h3>
            <button id="createFamilyBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">+ Nova familia</button>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                  <th style="text-align: left; padding: 10px; font-weight: 600;">Nom</th>
                  <th style="text-align: left; padding: 10px; font-weight: 600;">Nom visible</th>
                  <th style="text-align: center; padding: 10px; font-weight: 600;">Codi</th>
                  <th style="text-align: center; padding: 10px; font-weight: 600;">Receptes</th>
                  <th style="text-align: center; padding: 10px; font-weight: 600;">Menjars</th>
                  <th style="text-align: center; padding: 10px; font-weight: 600;">Rol</th>
                  <th style="text-align: center; padding: 10px; font-weight: 600;">Accions</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      for (const f of families) {
        const displayName = f.display_name || f.name;
        const isProtected = String(f.name || "").toUpperCase() === "CANTON LLOBET";
        familiesHtml += `
          <tr style="border-bottom: 1px solid #eee;" id="family-row-${f.id}">
            <td style="padding: 10px;">${f.name}</td>
            <td style="padding: 10px;">
              <input type="text" class="family-display-name" data-family-id="${f.id}" value="${displayName}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;" />
            </td>
            <td style="text-align: center; padding: 10px; font-family: monospace; font-weight: 500;">${f.code_last4}</td>
            <td style="text-align: center; padding: 10px;"><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-weight: 500;">${f.recipe_count || 0}</span></td>
            <td style="text-align: center; padding: 10px;"><span style="background: #f3e5f5; padding: 4px 8px; border-radius: 4px; font-weight: 500;">${f.meals_count || 0}</span></td>
            <td style="text-align: center; padding: 10px;">
              <select class="family-role" data-family-id="${f.id}" ${isProtected ? 'disabled title="Familia protegida"' : ''} style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="member" ${f.role === 'member' ? 'selected' : ''}>Membre</option>
                <option value="admin" ${f.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
            </td>
            <td style="text-align: center; padding: 10px;">
              <button class="save-family-btn" data-family-id="${f.id}" style="padding: 4px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Guardar</button>
              <button class="change-code-btn ${isProtected ? 'protected-btn' : ''}" data-family-id="${f.id}" ${isProtected ? 'disabled title="Familia protegida"' : ''} style="padding: 4px 10px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Codi</button>
              <button class="delete-family-btn ${isProtected ? 'protected-btn' : ''}" data-family-id="${f.id}" ${isProtected ? 'disabled title="Familia protegida"' : ''} style="padding: 4px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Borrar</button>
            </td>
          </tr>
        `;
      }
      
      familiesHtml += `
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      modalBody.innerHTML = familiesHtml;
      
      // Event listeners
      const adminCloseBtn = document.getElementById("adminCloseBtn");
      const createFamilyBtn = document.getElementById("createFamilyBtn");
      const saveBtns = document.querySelectorAll(".save-family-btn");
      const deleteBtns = document.querySelectorAll(".delete-family-btn");
      const changeCodeBtns = document.querySelectorAll(".change-code-btn");
      
      const closeAdmin = () => {
        overlay.classList.remove("open");
        IS_IN_MODAL = false;
      };
      
      adminCloseBtn.addEventListener("click", closeAdmin);
      
      createFamilyBtn.addEventListener("click", () => {
        showCreateFamilyForm();
      });
      
      saveBtns.forEach(btn => {
        btn.addEventListener("click", async () => {
          const familyId = btn.dataset.familyId;
          const displayNameInput = document.querySelector(`.family-display-name[data-family-id="${familyId}"]`);
          const roleSelect = document.querySelector(`.family-role[data-family-id="${familyId}"]`);
          
          const newDisplayName = displayNameInput.value.trim();
          const newRole = roleSelect.value;
          
          if (!newDisplayName) {
            alert("El nom visible no pot estar buit");
            return;
          }
          
          // Enviar cambios
          let success = true;
          
          // Actualizar display name
          const res1 = await apiFetch("/api/family", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "updateFamilyDisplayName",
              target_family_id: familyId,
              display_name: newDisplayName
            })
          });
          const data1 = await res1.json();
          if (!data1.ok) {
            alert("Error al actualizar nom: " + data1.error);
            success = false;
          }
          
          // Actualizar rol
          const res2 = await apiFetch("/api/family", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "updateFamilyRole",
              target_family_id: familyId,
              family_role: newRole
            })
          });
          const data2 = await res2.json();
          if (!data2.ok) {
            alert("Error al actualizar rol: " + data2.error);
            success = false;
          }
          
          if (success) {
            alert("Familia actualizada");
            
            // Si es la familia actual, actualizar localStorage y UI
            const { family: currentFamily } = getAuth();
            if (currentFamily && currentFamily.id === familyId) {
              currentFamily.display_name = newDisplayName;
              currentFamily.role = newRole;
              setAuth(localStorage.getItem("mf_token"), currentFamily);
              renderAuthState();
            }
            
            openAdminModal(); // Recargar la lista
          }
        });
      });
      
      changeCodeBtns.forEach(btn => {
        btn.addEventListener("click", async () => {
          const familyId = btn.dataset.familyId;
          showAdminChangeCodeForm(familyId, families);
        });
      });
      
      deleteBtns.forEach(btn => {
        btn.addEventListener("click", async () => {
          const familyId = btn.dataset.familyId;
          if (!confirm("¬øEst√†s segur que vols borrar aquesta familia?")) return;
          
          const res = await apiFetch("/api/family", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "deleteFamily", target_family_id: familyId })
          });
          const data = await res.json();
          
          if (data.ok) {
            alert("Familia borrada");
            openAdminModal(); // Recargar
          } else {
            alert("Error: " + data.error);
          }
        });
      });
      
      overlay.classList.add("open");
      preventMobileKeyboardOnOpen(modal);
    };
    
    function showAdminChangeCodeForm(familyId, families) {
      const family = families.find(f => f.id === familyId);
      if (!family) return;
      
      const modalBody = document.getElementById("modalBody");
      const newCode = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
      
      modalBody.innerHTML = `
        <div style="grid-column: 1 / -1;">
          <h3 style="margin-top: 0;">Canviar codi d'acc√©s</h3>
          <div style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
            <strong>Familia:</strong> ${family.name}
          </div>
          <div style="display: grid; gap: 10px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nou codi:</label>
              <input type="text" id="adminNewCodeInput" value="${newCode}" maxlength="6" 
                     style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 18px; font-family: monospace; font-weight: bold;" />
              <div style="font-size: 12px; color: #666; margin-top: 5px;">Pots canviar els d√≠gits si ho vols</div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button id="adminGenNewCodeBtn" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Generar nou</button>
              <button id="adminCancelChangeCodeBtn" style="padding: 8px 16px; background: #ccc; color: #333; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Cancelar</button>
              <button id="adminConfirmChangeCodeBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Confirmar</button>
            </div>
          </div>
        </div>
      `;
      
      const adminNewCodeInput = document.getElementById("adminNewCodeInput");
      const adminGenNewCodeBtn = document.getElementById("adminGenNewCodeBtn");
      const adminCancelChangeCodeBtn = document.getElementById("adminCancelChangeCodeBtn");
      const adminConfirmChangeCodeBtn = document.getElementById("adminConfirmChangeCodeBtn");
      
      adminGenNewCodeBtn.addEventListener("click", () => {
        const generatedCode = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
        adminNewCodeInput.value = generatedCode;
      });
      
      adminCancelChangeCodeBtn.addEventListener("click", () => {
        openAdminModal();
      });
      
      adminConfirmChangeCodeBtn.addEventListener("click", async () => {
        const codeValue = adminNewCodeInput.value.trim();
        
        if (!codeValue || codeValue.length < 4) {
          alert("El codi ha de tenir com a m√≠nim 4 d√≠gits");
          return;
        }
        
        if (!/^\d+$/.test(codeValue)) {
          alert("El codi nom√©s pot contenir d√≠gits");
          return;
        }
        
        adminConfirmChangeCodeBtn.disabled = true;
        adminConfirmChangeCodeBtn.textContent = "Canviant...";
        
        try {
          const response = await apiFetch("/api/family", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "changeFamilyCode", target_family_id: familyId, new_code: codeValue })
          });
          
          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || "Error al canviar el codi");
          }
          
          alert("‚úì Codi canviat correctament!\n\nNou codi: " + codeValue);
          openAdminModal();
        } catch (e) {
          alert("Error: " + String(e));
          adminConfirmChangeCodeBtn.disabled = false;
          adminConfirmChangeCodeBtn.textContent = "Confirmar";
        }
      });
    }
    
    function showCreateFamilyForm() {
      const modalBody = document.getElementById("modalBody");
      const formHtml = `
        <div style="grid-column: 1 / -1; margin-bottom: 20px;">
          <h3 style="margin-top: 0;">Nova familia</h3>
          <div style="display: grid; gap: 10px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nom de la familia:</label>
              <input type="text" id="newFamilyName" placeholder="Ex: Fam√≠lia Garc√≠a" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" />
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nom visible (opcional):</label>
              <input type="text" id="newFamilyDisplayName" placeholder="Ex: Els Garc√≠a" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" />
            </div>
            <div id="createdCodeDisplay" style="display: none; padding: 12px; background: #e8f5e9; border-radius: 4px; border-left: 4px solid #4CAF50;">
              <div style="font-weight: 600; margin-bottom: 8px;">‚úì Familia creada!</div>
              <div style="font-size: 14px;">Codi d'acc√©s: <span id="generatedCode" style="font-family: monospace; font-weight: bold; font-size: 18px;"></span></div>
              <div style="font-size: 12px; margin-top: 8px; color: #666;">Els membres poden usar aquest codi para accedir a la familia.</div>
            </div>
            <div id="buttonContainer" style="display: flex; gap: 10px;">
              <button id="createFamilyFormBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Crear</button>
              <button id="cancelCreateFamilyBtn" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">Cancelar</button>
            </div>
          </div>
        </div>
      `;
      
      modalBody.innerHTML = formHtml;
      
      const createBtn = document.getElementById("createFamilyFormBtn");
      const cancelBtn = document.getElementById("cancelCreateFamilyBtn");
      const newFamilyName = document.getElementById("newFamilyName");
      const buttonContainer = document.getElementById("buttonContainer");
      
      cancelBtn.addEventListener("click", () => {
        openAdminModal();
      });
      
      createBtn.addEventListener("click", async () => {
        const familyName = newFamilyName.value.trim();
        const displayName = document.getElementById("newFamilyDisplayName").value.trim();
        
        if (!familyName) {
          alert("El nom de la familia no pot estar buit");
          return;
        }
        
        // Deshabilitar bot√≥n durante la creaci√≥n
        createBtn.disabled = true;
        createBtn.textContent = "Creant...";
        
        try {
          const res = await apiFetch("/api/family", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "createFamily",
              family_name: familyName,
              family_display_name: displayName || familyName
            })
          });
          const data = await res.json();
          
          if (!data.ok) {
            alert("Error: " + data.error);
            createBtn.disabled = false;
            createBtn.textContent = "Crear";
            return;
          }
          
          // Mostrar c√≥digo generado
          const createdCodeDisplay = document.getElementById("createdCodeDisplay");
          const generatedCode = document.getElementById("generatedCode");
          generatedCode.textContent = data.family.code;
          createdCodeDisplay.style.display = "block";
          
          // Reemplazar los botones con uno nuevo "Tornar a la llista"
          buttonContainer.innerHTML = `
            <button id="returnToListBtn" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Tornar a la llista</button>
          `;
          
          const returnBtn = document.getElementById("returnToListBtn");
          returnBtn.addEventListener("click", () => {
            openAdminModal();
          });
          
          newFamilyName.disabled = true;
          document.getElementById("newFamilyDisplayName").disabled = true;
          
        } catch (err) {
          alert("Error de conexi√≥: " + err.message);
          createBtn.disabled = false;
          createBtn.textContent = "Crear";
        }
      });
    }
    
    async function bootstrapAuth() {
      // 1) Pinta r√†pid el que hi ha a localStorage
      renderAuthState();
  
      // 2) Si hi ha token, valida'l contra el server
      const token = localStorage.getItem("mf_token");
      if (!token) return;
  
      const res = await apiFetch("/api/me");
      const data = await res.json().catch(() => null);
  
      if (!res.ok || !data?.ok) {
        console.log("Token invalid/expirat. Netejant.", data);
        clearAuth();
        renderAuthState();
        return;
      }
      
      // Obtener informaci√≥n completa de la familia (incluyendo display_name)
      try {
        const familyRes = await apiFetch("/api/family");
        const familyData = await familyRes.json();
        
        if (familyRes.ok && familyData.ok && familyData.family) {
          const fam = { 
            id: familyData.family.id, 
            name: familyData.family.name, 
            role: familyData.family.role || "member",
            display_name: familyData.family.display_name
          };
          localStorage.setItem("mf_family", JSON.stringify(fam));
        }
      } catch (e) {
        console.warn("Could not fetch family info:", e);
      }
      
      renderAuthState();
    }
  
    async function doLogin() {
      const code = (document.getElementById("familyCodeInput").value || "").trim();
      if (!code) return alert("Introdueix el codi de fam√≠lia");
  
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code }),
      });
  
      const data = await res.json().catch(() => null);
      if (!res.ok || !data?.ok) {
        return alert(data?.error || "Login error");
      }
  
      setAuth(data.token, data.family);
      renderAuthState();
      
      // Load data after successful login
      showLoading();
      try {
        await loadRecipesOnce();
        await loadWeekData();
        renderBoardForDisplay();
        updateUIForMode();
        
        const todayISO = iso(new Date());
        const dates = buildDates(WEEK_START_ISO);
        scrollToDateOnMobile(dates.includes(todayISO) ? todayISO : WEEK_START_ISO);
        syncMealHeights();
      } catch (e) {
        console.error("Error loading data after login:", e);
        toast("error", "Error", "No s'han pogut carregar les dades");
      } finally {
        hideLoading();
      }
    }
  
    function doLogout() {
      closeUserMenu();
      clearAuth();
      renderAuthState();
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").addEventListener("click", doLogin);
      
      // User menu button
      const userMenuBtn = document.getElementById("userMenuBtn");
      if (userMenuBtn) {
        userMenuBtn.addEventListener("click", openUserMenu);
      }
      
      // User menu options
      const userMenuPreferences = document.getElementById("userMenuPreferences");
      const userMenuAdmin = document.getElementById("userMenuAdmin");
      const userMenuLogout = document.getElementById("userMenuLogout");
      
      if (userMenuPreferences) {
        userMenuPreferences.addEventListener("click", openPreferencesModal);
      }
      
      if (userMenuAdmin) {
        userMenuAdmin.addEventListener("click", openAdminModal);
      }
      
      if (userMenuLogout) {
        userMenuLogout.addEventListener("click", doLogout);
      }
      
      // Close dropdown cuando hace click fuera
      document.addEventListener("click", (e) => {
        const userMenuContainer = document.getElementById("userMenuContainer");
        if (userMenuContainer && !userMenuContainer.contains(e.target)) {
          closeUserMenu();
        }
      });
      
      // Close dropdown con ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeUserMenu();
        }
      });
  
      // Enter per login
      document.getElementById("familyCodeInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") doLogin();
      });
  
      bootstrapAuth();
    });
  </script>

  </div>
  <div id="toastWrap" class="toastWrap"></div>

  <div id="recipeOverlay" class="overlay">
    <div id="recipeModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">Receptes</div>
          <div class="muted" style="font-size:12px;">Edita ingredients, passos, v√≠deo i icona</div>
        </div>

        <div class="modalHeaderActions">
          <span id="recipeTopStatus" class="muted" style="font-size:12px;"></span>
          <button id="recipeDeleteBtn" style="background: rgba(239,68,68,0.15); color: #dc2626;">Borrar</button>
          <button id="recipeSaveTopBtn" class="btnPrimary" disabled>Guardar</button>
          <button id="recipeCloseBtn">Tancar</button>
        </div>
      </div>
      <div class="recipeEditor">
        <div class="recipeListPane">
          <div class="recipeSearch">
            <span class="muted">üîé</span>
            <input id="recipeSearchInput" placeholder="Cerca receptes..." autocomplete="off">
          </div>
          <div id="recipeList" class="recipeList"></div>
        </div>

        <div class="recipeDetailPane">
          <div id="recipeEmpty" class="muted">Selecciona una recepta a l‚Äôesquerra.</div>

          <div id="recipeForm" class="recipeForm" style="display:none;">
            <div class="recipeFormTop">
              <div class="recipeHeaderGrid">
                <div class="rhName">
                  <input id="rName" placeholder="Nom de la recepta">
                </div>

                <div class="rhCat">
                  <select id="rCategory" title="Categoria">
                    <option value="Primer">Primer</option>
                    <option value="Segon">Segon</option>
                    <option value="Plat √∫nic">Plat √∫nic</option>
                    <option value="Esmorzar">Esmorzar</option>
                    <option value="Berenar">Berenar</option>
                  </select>
                </div>

                <div class="rhIcon">
                  <div class="iconPickerHelper">Pots seleccionar fins a 3 icones.</div>
                  <span id="rIconPreview" class="iconPreview" aria-hidden="true"></span>
                </div>

                <div id="rIconPicker" class="iconPickerGrid"></div>
              </div>
              <input type="hidden" id="rIconValue">

            </div>

            <label class="muted" style="font-size:12px;margin-top:8px;">Ingredients (1 per l√≠nia)</label>
            <textarea id="rIngredients" rows="5" placeholder="- Patates&#10;- Ceba&#10;- Oli..."></textarea>

            <label class="muted" style="font-size:12px;margin-top:8px;">Passos (1 per l√≠nia o numerat)</label>
            <textarea id="rSteps" rows="7" placeholder="1) ...&#10;2) ..."></textarea>

            <label class="muted" style="font-size:12px;margin-top:8px;">V√≠deo (URL)</label>
            <input id="rVideo" placeholder="https://...">

            <div class="noteActions" style="justify-content:space-between;">
              <div class="muted" id="rStatus" style="font-size:12px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="recipeViewOverlay" class="overlay">
    <div id="recipeViewModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
      <div class="modalHeader">
        <div>
          <div id="rvTitle" class="modalTitle">Recepta</div>
          <div id="rvMeta" class="muted" style="font-size:12px;"></div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button id="rvEditBtn" class="btnPrimary">Editar</button>
          <button id="rvCloseBtn">Tancar</button>
        </div>
      </div>


      <div class="modalBody" style="grid-template-columns: 1fr;">
        <div class="panel" style="background: rgba(255,255,255,0.65);">
          <div style="font-weight:800; margin-bottom:6px;">Ingredients</div>
          <pre id="rvIngredients" style="margin:0; white-space:pre-wrap; font-family:inherit; font-size:14px; color:rgba(0,0,0,0.78);"></pre>
        </div>

        <div class="panel" style="background: rgba(255,255,255,0.65);">
          <div style="font-weight:800; margin-bottom:6px;">Passos</div>
          <pre id="rvSteps" style="margin:0; white-space:pre-wrap; font-family:inherit; font-size:14px; color:rgba(0,0,0,0.78);"></pre>
        </div>

        <div id="rvVideoWrap" class="panel" style="display:none; background: rgba(255,255,255,0.65);">
          <div style="font-weight:800; margin-bottom:6px;">V√≠deo</div>
          <a id="rvVideoLink" href="#" target="_blank" rel="noopener">Obrir v√≠deo</a>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    // Register Service Worker for PWA support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }

    // Force landscape orientation
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').catch(err => {
        console.log('Could not lock orientation to landscape:', err);
      });
    }
    
    // Ensure landscape is locked on orientation change
    screen.addEventListener('orientationchange', () => {
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('landscape').catch(err => {
          console.log('Could not lock orientation to landscape:', err);
        });
      }
    });

    // Handle orientation changes: re-render board when switching between daily/weekly view
    window.addEventListener('resize', () => {
      renderBoardForDisplay();
      updateUIForMode();
      syncMealHeights();
    });
  </script>

</body>
</html>


